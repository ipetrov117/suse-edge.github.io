<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>SUSE Edge Documentation | Downstream clusters</title><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"/>
<meta name="title" content="Downstream clusters"/>
<meta name="description" content="This section covers how to do various Day 2 operations for different parts of your downstream cluster using your management cluster."/>
<meta name="book-title" content="SUSE Edge Documentation"/>
<meta name="chapter-title" content="Chapter 25. Downstream clusters"/>
<meta name="tracker-url" content="https://github.com/suse-edge/suse-edge.github.io/issues/new"/>
<meta name="tracker-type" content="gh"/>
<meta name="publisher" content="SUSE"/><meta property="og:title" content="Downstream clusters"/>
<meta property="og:description" content="This section covers how to do various Day 2 operations for …"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Downstream clusters"/>
<meta name="twitter:description" content="This section covers how to do various Day 2 operations for …"/>
<script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": ["TechArticle"],
    "image": "https://www.suse.com/assets/img/suse-white-logo-green.svg",
    
     "isPartOf": {
      "@type": "CreativeWorkSeries",
      "name": "Products &amp; Solutions"
    },
    

    "headline": "Downstream clusters",
  
    "description": "Downstream clusters",
      
    "author": [
      {
        "@type": "Corporation",
        "name": "SUSE Product &amp; Solution Documentation Team",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    ],
      

    "about": [
      
    ],
  
    "sameAs": [
          "https://www.facebook.com/SUSEWorldwide/about",
          "https://www.youtube.com/channel/UCHTfqIzPKz4f_dri36lAQGA",
          "https://twitter.com/SUSE",
          "https://www.linkedin.com/company/suse"
    ],
    "publisher": {
      "@type": "Corporation",
      "name": "SUSE",
      "url": "https://documentation.suse.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    }
  }</script>
<link rel="prev" href="day2-mgmt-cluster.html" title="Chapter 24. Management Cluster"/><link rel="next" href="id-product-documentation.html" title="Part VI. Product Documentation"/><script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/script-purejs.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="wide offline js-off"><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">SUSE Edge Documentation</a><span> / </span><a class="crumb" href="id-day-2-operations.html">Day 2 Operations</a><span> / </span><a class="crumb" href="id-downstream-clusters.html">Downstream clusters</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title">SUSE Edge Documentation</div><ol><li><a href="id-suse-edge-documentation.html" class=" "><span class="title-number"> </span><span class="title-name">SUSE Edge Documentation</span></a></li><li><a href="id-quick-starts.html" class="has-children "><span class="title-number">I </span><span class="title-name">Quick Starts</span></a><ol><li><a href="quickstart-metal3.html" class=" "><span class="title-number">1 </span><span class="title-name">BMC automated deployments with Metal<sup>3</sup></span></a></li><li><a href="quickstart-elemental.html" class=" "><span class="title-number">2 </span><span class="title-name">Remote host onboarding with Elemental</span></a></li><li><a href="quickstart-eib.html" class=" "><span class="title-number">3 </span><span class="title-name">Standalone clusters with Edge Image Builder</span></a></li></ol></li><li><a href="id-components-used.html" class="has-children "><span class="title-number">II </span><span class="title-name">Components Used</span></a><ol><li><a href="components-rancher.html" class=" "><span class="title-number">4 </span><span class="title-name">Rancher</span></a></li><li><a href="components-rancher-dashboard-extensions.html" class=" "><span class="title-number">5 </span><span class="title-name">Rancher Dashboard Extensions</span></a></li><li><a href="components-fleet.html" class=" "><span class="title-number">6 </span><span class="title-name">Fleet</span></a></li><li><a href="components-slmicro.html" class=" "><span class="title-number">7 </span><span class="title-name">SLE Micro</span></a></li><li><a href="components-metal3.html" class=" "><span class="title-number">8 </span><span class="title-name">Metal<sup>3</sup></span></a></li><li><a href="components-eib.html" class=" "><span class="title-number">9 </span><span class="title-name">Edge Image Builder</span></a></li><li><a href="components-nmc.html" class=" "><span class="title-number">10 </span><span class="title-name">Edge Networking</span></a></li><li><a href="components-elemental.html" class=" "><span class="title-number">11 </span><span class="title-name">Elemental</span></a></li><li><a href="components-akri.html" class=" "><span class="title-number">12 </span><span class="title-name">Akri</span></a></li><li><a href="components-k3s.html" class=" "><span class="title-number">13 </span><span class="title-name">K3s</span></a></li><li><a href="components-rke2.html" class=" "><span class="title-number">14 </span><span class="title-name">RKE2</span></a></li><li><a href="components-longhorn.html" class=" "><span class="title-number">15 </span><span class="title-name">Longhorn</span></a></li><li><a href="components-neuvector.html" class=" "><span class="title-number">16 </span><span class="title-name">NeuVector</span></a></li><li><a href="components-metallb.html" class=" "><span class="title-number">17 </span><span class="title-name">MetalLB</span></a></li><li><a href="components-kubevirt.html" class=" "><span class="title-number">18 </span><span class="title-name">Edge Virtualization</span></a></li></ol></li><li><a href="id-how-to-guides.html" class="has-children "><span class="title-number">III </span><span class="title-name">How-To Guides</span></a><ol><li><a href="guides-metallb-k3s.html" class=" "><span class="title-number">19 </span><span class="title-name">MetalLB on K3s (using L2)</span></a></li><li><a href="guides-metallb-kubernetes.html" class=" "><span class="title-number">20 </span><span class="title-name">MetalLB in front of the Kubernetes API server</span></a></li><li><a href="id-air-gapped-deployments-with-edge-image-builder.html" class=" "><span class="title-number">21 </span><span class="title-name">Air-gapped deployments with Edge Image Builder</span></a></li></ol></li><li><a href="id-third-party-integration.html" class="has-children "><span class="title-number">IV </span><span class="title-name">Third-Party Integration</span></a><ol><li><a href="integrations-nats.html" class=" "><span class="title-number">22 </span><span class="title-name">NATS</span></a></li><li><a href="id-nvidia-gpus-on-sle-micro.html" class=" "><span class="title-number">23 </span><span class="title-name">NVIDIA GPUs on SLE Micro</span></a></li></ol></li><li class="active"><a href="id-day-2-operations.html" class="has-children you-are-here"><span class="title-number">V </span><span class="title-name">Day 2 Operations</span></a><ol><li><a href="day2-mgmt-cluster.html" class=" "><span class="title-number">24 </span><span class="title-name">Management Cluster</span></a></li><li><a href="id-downstream-clusters.html" class=" you-are-here"><span class="title-number">25 </span><span class="title-name">Downstream clusters</span></a></li></ol></li><li><a href="id-product-documentation.html" class="has-children "><span class="title-number">VI </span><span class="title-name">Product Documentation</span></a><ol><li><a href="atip.html" class=" "><span class="title-number">26 </span><span class="title-name">SUSE Adaptive Telco Infrastructure Platform (ATIP)</span></a></li><li><a href="atip-architecture.html" class=" "><span class="title-number">27 </span><span class="title-name">Concept &amp; Architecture</span></a></li><li><a href="atip-requirements.html" class=" "><span class="title-number">28 </span><span class="title-name">Requirements &amp; Assumptions</span></a></li><li><a href="atip-management-cluster.html" class=" "><span class="title-number">29 </span><span class="title-name">Setting up the management cluster</span></a></li><li><a href="atip-features.html" class=" "><span class="title-number">30 </span><span class="title-name">Telco features configuration</span></a></li><li><a href="atip-automated-provisioning.html" class=" "><span class="title-number">31 </span><span class="title-name">Fully automated directed network provisioning</span></a></li><li><a href="atip-lifecycle.html" class=" "><span class="title-number">32 </span><span class="title-name">Lifecycle actions</span></a></li></ol></li><li><a href="id-appendix.html" class="has-children "><span class="title-number">VII </span><span class="title-name">Appendix</span></a><ol><li><a href="id-release-notes.html" class=" "><span class="title-number">33 </span><span class="title-name">Release Notes</span></a></li></ol></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="id-downstream-clusters" data-id-title="Downstream clusters"><div class="titlepage"><div><div><div class="title-container"><h1 class="title"><span class="title-number-name"><span class="title-number">25 </span><span class="title-name">Downstream clusters</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#">#</a></h1><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers how to do various <code class="literal">Day 2</code> operations for different parts of your downstream cluster using your <code class="literal">management cluster</code>.</p><section class="sect1" id="id-introduction" data-id-title="Introduction"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">25.1 </span><span class="title-name">Introduction</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-introduction">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section is meant to be a <span class="strong"><strong>starting point</strong></span> for the <code class="literal">Day 2</code> operations documentation. You can find the following information.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>The default components (<a class="xref" href="id-downstream-clusters.html#day2-downstream-components" title="25.1.1. Components">Section 25.1.1, “Components”</a>) used to achieve <code class="literal">Day 2</code> operations over multiple downstream clusters.</p></li><li class="listitem"><p>Determining which <code class="literal">Day 2</code> resources should you use for your specific use-case (<a class="xref" href="id-downstream-clusters.html#day2-determine-use-case" title="25.1.2. Determine your use-case">Section 25.1.2, “Determine your use-case”</a>).</p></li><li class="listitem"><p>The suggested workflow sequence (<a class="xref" href="id-downstream-clusters.html#day2-upgrade-workflow" title="25.1.3. Day 2 workflow">Section 25.1.3, “Day 2 workflow”</a>) for <code class="literal">Day 2</code> operations.</p></li></ol></div><section class="sect2" id="day2-downstream-components" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.1.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-downstream-components">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Below you can find a description of the default components that should be setup on either your <code class="literal">management cluster</code> or your <code class="literal">downstream clusters</code> so that you can successfully perform <code class="literal">Day 2</code> operations.</p><section class="sect3" id="id-rancher" data-id-title="Rancher"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.1.1.1 </span><span class="title-name">Rancher</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-rancher">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.4.3.4.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>For use-cases where you want to utilise Fleet (<a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>) without Rancher, you can skip the Rancher component all together.</p></div><p>Responsible for the management of your <code class="literal">downstream clusters</code>. Should be deployed on your <code class="literal">management cluster</code>.</p><p>For more information, see <a class="xref" href="components-rancher.html" title="Chapter 4. Rancher">Chapter 4, <em>Rancher</em></a>.</p></section><section class="sect3" id="id-fleet" data-id-title="Fleet"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.1.1.2 </span><span class="title-name">Fleet</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-fleet">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Responsible for multi-cluster resource deployment.</p><p>Typically offered by the <code class="literal">Rancher</code> component. For use-cases where <code class="literal">Rancher</code> is not used, can be deployed as a standalone component.</p><p>For more information on installing Fleet as a standalone component, see Fleet’s <a class="link" href="https://fleet.rancher.io/installation" target="_blank">Installation Details</a>.</p><p>For more information regarding the Fleet component, see <a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>.</p><div id="id-1.7.4.3.4.4.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>This documentation heavily relies on <code class="literal">Fleet</code> and more specifically on the <code class="literal">GitRepo</code> and <code class="literal">Bundle</code> resources (more on this in <a class="xref" href="id-downstream-clusters.html#day2-determine-use-case" title="25.1.2. Determine your use-case">Section 25.1.2, “Determine your use-case”</a>) for establishing a GitOps way of automating the deployment of resources related to <code class="literal">Day 2</code> operations.</p><p>For use-cases, where a third party GitOps tool usage is desired, see:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>For <code class="literal">OS upgrades</code> - <a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-third-party" title="25.3.4.3. SUC Plan deployment - third-party GitOps workflow">Section 25.3.4.3, “SUC Plan deployment - third-party GitOps workflow”</a></p></li><li class="listitem"><p>For <code class="literal">Kubernetes distribution upgrades</code> - <a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-third-party" title="25.4.4.3. SUC Plan deployment - third-party GitOps workflow">Section 25.4.4.3, “SUC Plan deployment - third-party GitOps workflow”</a></p></li><li class="listitem"><p>For <code class="literal">Helm chart upgrades</code> - retrieve the chart version supported by the desired Edge release from the <a class="xref" href="id-release-notes.html#release-notes" title="33.1. Abstract">Section 33.1, “Abstract”</a> page and populate the chart version and URL in your third party GitOps tool</p></li></ol></div></div></section><section class="sect3" id="id-system-upgrade-controller-suc" data-id-title="System-upgrade-controller (SUC)"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.1.1.3 </span><span class="title-name">System-upgrade-controller (SUC)</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-system-upgrade-controller-suc">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The <span class="strong"><strong>system-upgrade-controller (SUC)</strong></span> is responsible for executing tasks on specified nodes based on configuration data provided through a custom resource, called a <code class="literal">Plan</code>. Should be located on each <code class="literal">downstream cluster</code> that requires some sort of a <code class="literal">Day 2</code> operation.</p><p>For more information regarding <span class="strong"><strong>SUC</strong></span>, see the upstream <a class="link" href="https://github.com/rancher/system-upgrade-controller" target="_blank">repository</a>.</p><p>For information on how to deploy <span class="strong"><strong>SUC</strong></span> on your downstream clusters, first determine your use-case (<a class="xref" href="id-downstream-clusters.html#day2-determine-use-case" title="25.1.2. Determine your use-case">Section 25.1.2, “Determine your use-case”</a>) and then refer to either <a class="xref" href="id-downstream-clusters.html#day2-suc-dep-gitrepo" title="25.2.1.1. SUC deployment using a GitRepo resource">Section 25.2.1.1, “SUC deployment using a GitRepo resource”</a>, or <a class="xref" href="id-downstream-clusters.html#day2-suc-dep-bundle" title="25.2.1.2. SUC deployment using a Bundle resource">Section 25.2.1.2, “SUC deployment using a Bundle resource”</a> for SUC deployment information.</p></section></section><section class="sect2" id="day2-determine-use-case" data-id-title="Determine your use-case"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.1.2 </span><span class="title-name">Determine your use-case</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-determine-use-case">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>As mentioned previously, resources related to <code class="literal">Day 2</code> operations are propagated to downstream clusters using Fleet’s <code class="literal">GitRepo</code> and <code class="literal">Bundle</code> resources.</p><p>Below you can find more information regarding what these resources do and for which use-cases should they be used for <code class="literal">Day 2</code> operations.</p><section class="sect3" id="id-gitrepo" data-id-title="GitRepo"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.1.2.1 </span><span class="title-name">GitRepo</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-gitrepo">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <code class="literal">GitRepo</code> is a Fleet (<a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>) resource that represents a Git repository from which <code class="literal">Fleet</code> can create <code class="literal">Bundles</code>. Each <code class="literal">Bundle</code> is created based on configuration paths defined inside of the <code class="literal">GitRepo</code> resource. For more information, see the <a class="link" href="https://fleet.rancher.io/gitrepo-add" target="_blank">GitRepo</a> documentation.</p><p>In terms of <code class="literal">Day 2</code> operations <code class="literal">GitRepo</code> resources are normally used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> on <span class="strong"><strong>non air-gapped</strong></span> environments that utilise a <span class="emphasis"><em>Fleet GitOps</em></span> approach.</p><p>Alternatively, <code class="literal">GitRepo</code> resources can also be used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> on <span class="strong"><strong>air-gapped</strong></span> environments, <span class="strong"><strong>if you mirror your repository setup through a local git server</strong></span>.</p></section><section class="sect3" id="id-bundle" data-id-title="Bundle"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.1.2.2 </span><span class="title-name">Bundle</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-bundle">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><code class="literal">Bundles</code> hold <span class="strong"><strong>raw</strong></span> Kubernetes resources that will be deployed on the targeted cluster. Usually they are created from a <code class="literal">GitRepo</code> resource, but there are use-cases where they can be deployed manually. For more information refer to the <a class="link" href="https://fleet.rancher.io/bundle-add" target="_blank">Bundle</a> documentation.</p><p>In terms of <code class="literal">Day 2</code> operations <code class="literal">Bundle</code> resources are normally used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> on <span class="strong"><strong>air-gapped</strong></span> environments that do not use some form of <span class="emphasis"><em>local GitOps</em></span> procedure (e.g. a <span class="strong"><strong>local git server</strong></span>).</p><p>Alternatively, if your use-case does not allow for a <span class="emphasis"><em>GitOps</em></span> workflow (e.g. using a Git repository), <span class="strong"><strong>Bundle</strong></span> resources could also be used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> on <span class="strong"><strong>non air-gapped</strong></span> environments.</p></section></section><section class="sect2" id="day2-upgrade-workflow" data-id-title="Day 2 workflow"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.1.3 </span><span class="title-name">Day 2 workflow</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-upgrade-workflow">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The following is a <code class="literal">Day 2</code> workflow that should be followed when upgrading a downstream cluster to a specific Edge release.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>OS upgrade (<a class="xref" href="id-downstream-clusters.html#day2-os-upgrade" title="25.3. OS upgrade">Section 25.3, “OS upgrade”</a>)</p></li><li class="listitem"><p>Kubernetes version upgrade (<a class="xref" href="id-downstream-clusters.html#day2-k8s-upgrade" title="25.4. Kubernetes version upgrade">Section 25.4, “Kubernetes version upgrade”</a>)</p></li><li class="listitem"><p>Helm chart upgrade (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade" title="25.5. Helm chart upgrade">Section 25.5, “Helm chart upgrade”</a>)</p></li></ol></div></section></section><section class="sect1" id="day2-suc-deployment-guide" data-id-title="System upgrade controller deployment guide"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">25.2 </span><span class="title-name">System upgrade controller deployment guide</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-suc-deployment-guide">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The <span class="strong"><strong>system-upgrade-controller (SUC)</strong></span> is responsible for deploying resources on specific nodes of a cluster based on configurations defined in a custom resource called a <span class="strong"><strong>Plan</strong></span>. For more information, see the <a class="link" href="https://github.com/rancher/system-upgrade-controller" target="_blank">upstream</a> documentation.</p><div id="id-1.7.4.4.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This section focuses solely on deploying the <code class="literal">system-upgrade-controller</code>. <span class="strong"><strong>Plan</strong></span> resources should be deployed from the following documentations:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>OS upgrade (<a class="xref" href="id-downstream-clusters.html#day2-os-upgrade" title="25.3. OS upgrade">Section 25.3, “OS upgrade”</a>)</p></li><li class="listitem"><p>Kubernetes version upgrade (<a class="xref" href="id-downstream-clusters.html#day2-k8s-upgrade" title="25.4. Kubernetes version upgrade">Section 25.4, “Kubernetes version upgrade”</a>)</p></li><li class="listitem"><p>Helm chart upgrade (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade" title="25.5. Helm chart upgrade">Section 25.5, “Helm chart upgrade”</a>)</p></li></ol></div></div><section class="sect2" id="id-deployment-2" data-id-title="Deployment"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.2.1 </span><span class="title-name">Deployment</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-deployment-2">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.4.4.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This section assumes that you are going to use  Fleet (<a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>) to orchestrate the <span class="strong"><strong>SUC</strong></span> deployment. Users using a third-party GitOps workflow should see <a class="xref" href="id-downstream-clusters.html#day2-suc-third-party-gitops" title="25.2.1.3. Deploying system-upgrade-controller when using a third-party GitOps workflow">Section 25.2.1.3, “Deploying system-upgrade-controller when using a third-party GitOps workflow”</a> for information on what resources they need to setup in their workflow.</p></div><p>To determine the resource to use, refer to <a class="xref" href="id-downstream-clusters.html#day2-determine-use-case" title="25.1.2. Determine your use-case">Section 25.1.2, “Determine your use-case”</a>.</p><section class="sect3" id="day2-suc-dep-gitrepo" data-id-title="SUC deployment using a GitRepo resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.2.1.1 </span><span class="title-name">SUC deployment using a GitRepo resource</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-suc-dep-gitrepo">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers how to create a <code class="literal">GitRepo</code> resource that will ship the needed <code class="literal">SUC Plans</code> for a successful <span class="strong"><strong>SUC</strong></span> deployment to your <span class="strong"><strong>target</strong></span> downstream clusters.</p><p>The Edge team maintains a ready to use <code class="literal">GitRepo</code> resource for <span class="strong"><strong>SUC</strong></span> in each of our <code class="literal">suse-edge/fleet-examples</code> <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">releases</a> under <code class="literal">gitrepos/day2/system-upgrade-controller-gitrepo.yaml</code>.</p><div id="id-1.7.4.4.4.4.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>If using the <code class="literal">suse-edge/fleet-examples</code> repository, make sure you are using the resources from a dedicated <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p><code class="literal">GitRepo</code> creation can be done in one of of the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Through the Rancher UI (<a class="xref" href="id-downstream-clusters.html#day2-suc-dep-gitrepo-rancher" title="25.2.1.1.1. GitRepo deployment - Rancher UI">Section 25.2.1.1.1, “GitRepo deployment - Rancher UI”</a>) (when <code class="literal">Rancher</code> is available)</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="id-downstream-clusters.html#day2-suc-dep-gitrepo-manual" title="25.2.1.1.2. GitRepo creation - manual">Section 25.2.1.1.2, “GitRepo creation - manual”</a>) the resources to your <code class="literal">management cluster</code></p></li></ul></div><p>Once created, <code class="literal">Fleet</code> will be responsible for picking up the resource and deploying the <span class="strong"><strong>SUC</strong></span> resources to all your <span class="strong"><strong>target</strong></span> clusters. For information on how to track the deployment process, see <a class="xref" href="id-downstream-clusters.html#monitor-suc-deployment" title="25.2.2.1. Monitor SUC deployment">Section 25.2.2.1, “Monitor SUC deployment”</a>.</p><section class="sect4" id="day2-suc-dep-gitrepo-rancher" data-id-title="GitRepo deployment - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.2.1.1.1 </span><span class="title-name">GitRepo deployment - Rancher UI</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-suc-dep-gitrepo-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Git Repos → Add Repository</strong></span></p></li></ol></div><p>If you use the <code class="literal">suse-edge/fleet-examples</code> repository:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>Repository URL</strong></span> - <code class="literal"><a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">https://github.com/suse-edge/fleet-examples.git</a></code></p></li><li class="listitem"><p><span class="strong"><strong>Watch → Revision</strong></span> - choose a <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag for the <code class="literal">suse-edge/fleet-examples</code> repository that you wish to use, e.g. <code class="literal">release-3.0.1</code>.</p></li><li class="listitem"><p>Under <span class="strong"><strong>Paths</strong></span> add the path to the <span class="strong"><strong>system-upgrade-controller</strong></span> as seen in the release tag - <code class="literal">fleets/day2/system-upgrade-controller</code></p></li><li class="listitem"><p>Select <span class="strong"><strong>Next</strong></span> to move to the <span class="strong"><strong>target</strong></span> configuration section</p></li><li class="listitem"><p><span class="strong"><strong>Only select clusters for which you wish to deploy the <code class="literal">system-upgrade-controller</code>.</strong></span> When you are satisfied with your configurations, click <span class="strong"><strong>Create</strong></span></p></li></ol></div><p>Alternatively, if you decide to use your own repository to host these files, you would need to provide your repo data above.</p></section><section class="sect4" id="day2-suc-dep-gitrepo-manual" data-id-title="GitRepo creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.2.1.1.2 </span><span class="title-name">GitRepo creation - manual</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-suc-dep-gitrepo-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Choose the desired Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you wish to deploy the <span class="strong"><strong>SUC</strong></span> <code class="literal">GitRepo</code> from (referenced below as <code class="literal">${REVISION}</code>).</p></li><li class="listitem"><p>Pull the <span class="strong"><strong>GitRepo</strong></span> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o system-upgrade-controller-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/{REVISION}/gitrepos/day2/system-upgrade-controller-gitrepo.yaml</pre></div></li><li class="listitem"><p>Edit the <span class="strong"><strong>GitRepo</strong></span> configurations, under <code class="literal">spec.targets</code> specify your desired target list. By default, the <code class="literal">GitRepo</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any down stream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters, change the default <code class="literal">GitRepo</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>GitRepo</strong></span> resource to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f system-upgrade-controller-gitrepo.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>GitRepo</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get gitrepo system-upgrade-controller -n fleet-default

# Example output
NAME                        REPO                                               COMMIT       BUNDLEDEPLOYMENTS-READY   STATUS
system-upgrade-controller   https://github.com/suse-edge/fleet-examples.git   release-3.0.1   0/0</pre></div></li></ol></div></section></section><section class="sect3" id="day2-suc-dep-bundle" data-id-title="SUC deployment using a Bundle resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.2.1.2 </span><span class="title-name">SUC deployment using a Bundle resource</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-suc-dep-bundle">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers how to create a <code class="literal">Bundle</code> resource that will ship the needed <code class="literal">SUC Plans</code> for a successful <span class="strong"><strong>SUC</strong></span> deployment to your <span class="strong"><strong>target</strong></span> downstream clusters.</p><p>The Edge team maintains a ready to use <code class="literal">Bundle</code> resources for <span class="strong"><strong>SUC</strong></span> in each of our <code class="literal">suse-edge/fleet-examples</code> <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">releases</a> under <code class="literal">bundles/day2/system-upgrade-controller/controller-bundle.yaml</code>.</p><div id="id-1.7.4.4.4.5.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>If using the <code class="literal">suse-edge/fleet-examples</code> repository, make sure you are using the resources from a dedicated <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p><code class="literal">Bundle</code> creation can be done in one of of the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Through the Rancher UI (<a class="xref" href="id-downstream-clusters.html#day2-suc-dep-bundle-rancher" title="25.2.1.2.1. Bundle creation - Rancher UI">Section 25.2.1.2.1, “Bundle creation - Rancher UI”</a>) (when <code class="literal">Rancher</code> is available)</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="id-downstream-clusters.html#day2-suc-dep-bundle-manual" title="25.2.1.2.2. Bundle creation - manual">Section 25.2.1.2.2, “Bundle creation - manual”</a>) the resources to your <code class="literal">management cluster</code></p></li></ul></div><p>Once created, <code class="literal">Fleet</code> will be responsible for pickuping the resource and deploying the <span class="strong"><strong>SUC</strong></span> resources to all your <span class="strong"><strong>target</strong></span> clusters. For information on how to track the deployment process, see <a class="xref" href="id-downstream-clusters.html#monitor-suc-deployment" title="25.2.2.1. Monitor SUC deployment">Section 25.2.2.1, “Monitor SUC deployment”</a>.</p><section class="sect4" id="day2-suc-dep-bundle-rancher" data-id-title="Bundle creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.2.1.2.1 </span><span class="title-name">Bundle creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-suc-dep-bundle-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Advanced</strong></span> &gt; <span class="strong"><strong>Bundles</strong></span></p></li><li class="listitem"><p>Select <span class="strong"><strong>Create from YAML</strong></span></p></li><li class="listitem"><p>From here you can create the Bundle in one of the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>By manually copying the file content to the <span class="strong"><strong>Create from YAML</strong></span> page. File content can be retrieved from this url - <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller/controller-bundle.yaml" target="_blank">https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller/controller-bundle.yaml</a>. Where <code class="literal">${REVISION}</code> is the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you desire (e.g. <code class="literal">release-3.0.1</code>).</p></li><li class="listitem"><p>By cloning the <code class="literal">suse-edge/fleet-examples</code> repository to the desired <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag and selecting the <span class="strong"><strong>Read from File</strong></span> option in the <span class="strong"><strong>Create from YAML</strong></span> page. From there, navigate to <code class="literal">bundles/day2/system-upgrade-controller</code> directory and select <code class="literal">controller-bundle.yaml</code>. This will auto-populate the <span class="strong"><strong>Create from YAML</strong></span> page with the Bundle content.</p></li></ul></div></li><li class="listitem"><p>Change the <span class="strong"><strong>target</strong></span> clusters for the <code class="literal">Bundle</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all downstream clusters change the default Bundle <code class="literal">.spec.targets</code> to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>For a more granular downstream cluster mappings, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p></li></ul></div></li><li class="listitem"><p><span class="strong"><strong>Create</strong></span></p></li></ol></div></section><section class="sect4" id="day2-suc-dep-bundle-manual" data-id-title="Bundle creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.2.1.2.2 </span><span class="title-name">Bundle creation - manual</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-suc-dep-bundle-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Choose the desired Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you wish to deploy the <span class="strong"><strong>SUC</strong></span> <code class="literal">Bundle</code> from (referenced below as <code class="literal">${REVISION}</code>).</p></li><li class="listitem"><p>Pull the <span class="strong"><strong>Bundle</strong></span> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o controller-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller/controller-bundle.yaml</pre></div></li><li class="listitem"><p>Edit the <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> configurations, under <code class="literal">spec.targets</code> provide your desired target list. By default the <code class="literal">Bundle</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any down stream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters change the default <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>Bundle</strong></span> resource to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f controller-bundle.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>Bundle</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get bundles system-upgrade-controller -n fleet-default

# Example output
NAME                        BUNDLEDEPLOYMENTS-READY   STATUS
system-upgrade-controller   0/0</pre></div></li></ol></div></section></section><section class="sect3" id="day2-suc-third-party-gitops" data-id-title="Deploying system-upgrade-controller when using a third-party GitOps workflow"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.2.1.3 </span><span class="title-name">Deploying system-upgrade-controller when using a third-party GitOps workflow</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-suc-third-party-gitops">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>To deploy the <code class="literal">system-upgrade-controller</code> using a third-party GitOps tool, depending on the tool, you might need information for the <code class="literal">system-upgrade-controller</code> Helm chart or Kubernetes resoruces, or both.</p><p>Choose a specific Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> from which you wish to use the <span class="strong"><strong>SUC</strong></span> from.</p><p>From there, the <span class="strong"><strong>SUC</strong></span> Helm chart data can be found under the <code class="literal">helm</code> configuration section of the <code class="literal">fleets/day2/system-upgrade-controller/fleet.ymal</code> file.</p><p>The <span class="strong"><strong>SUC</strong></span> Kubernetes resources can be found under the <span class="strong"><strong>SUC</strong></span> <code class="literal">Bundle</code> configuration under <code class="literal">.spec.resources.content</code>. The location for the bundle is <code class="literal">bundles/day2/system-upgrade-controller/controller-bundle.yaml</code>.</p><p>Use the above mentioned resoruces to populate the data that your third-party GitOps workflow needs in order to deploy <span class="strong"><strong>SUC</strong></span>.</p></section></section><section class="sect2" id="id-monitor-suc-resources-using-rancher" data-id-title="Monitor SUC resources using Rancher"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.2.2 </span><span class="title-name">Monitor SUC resources using Rancher</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-monitor-suc-resources-using-rancher">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers how to monitor the lifecycle of the <span class="strong"><strong>SUC</strong></span> deployment and any deployed <span class="strong"><strong>SUC</strong></span> Plans using the Rancher UI.</p><section class="sect3" id="monitor-suc-deployment" data-id-title="Monitor SUC deployment"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.2.2.1 </span><span class="title-name">Monitor SUC deployment</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#monitor-suc-deployment">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>To check the <span class="strong"><strong>SUC</strong></span> pod logs for a specific cluster:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, <span class="strong"><strong>☰ → &lt;your-cluster-name&gt;</strong></span></p></li><li class="listitem"><p>Select <span class="strong"><strong>Workloads → Pods</strong></span></p></li><li class="listitem"><p>Under the namespace drop down menu select the <code class="literal">cattle-system</code> namespace</p><div class="informalfigure"><div class="mediaobject"><a href="images/day2-monitor-suc-deployment-1.png"><img src="images/day2-monitor-suc-deployment-1.png" width="NaN" alt="day2 monitor suc deployment 1" title="day2 monitor suc deployment 1"/></a></div></div></li><li class="listitem"><p>In the Pod filter bar, write the <span class="strong"><strong>SUC</strong></span> name - <code class="literal">system-upgrade-controller</code></p></li><li class="listitem"><p>On the right of the pod select <span class="strong"><strong>⋮ → View Logs</strong></span></p><div class="informalfigure"><div class="mediaobject"><a href="images/day2-monitor-suc-deployment-2.png"><img src="images/day2-monitor-suc-deployment-2.png" width="NaN" alt="day2 monitor suc deployment 2" title="day2 monitor suc deployment 2"/></a></div></div></li><li class="listitem"><p>The <span class="strong"><strong>SUC</strong></span> logs should looks something similar to:</p><div class="informalfigure"><div class="mediaobject"><a href="images/day2-monitor-suc-deployment-3.png"><img src="images/day2-monitor-suc-deployment-3.png" width="NaN" alt="day2 monitor suc deployment 3" title="day2 monitor suc deployment 3"/></a></div></div></li></ol></div></section><section class="sect3" id="monitor-suc-plans" data-id-title="Monitor SUC Plans"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.2.2.2 </span><span class="title-name">Monitor SUC Plans</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#monitor-suc-plans">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.4.4.5.4.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>The <span class="strong"><strong>SUC Plan</strong></span> Pods are kept alive for <span class="strong"><strong>15</strong></span> minutes. After that they are removed by the corresponding Job that created them. To have access to the <span class="strong"><strong>SUC Plan</strong></span> Pod logs, you should enable logging for your cluster. For information on how to do this in Rancher, see <a class="link" href="https://ranchermanager.docs.rancher.com/v2.8/integrations-in-rancher/logging" target="_blank">Rancher Integration with Logging Services</a>.</p></div><p>To check <span class="strong"><strong>Pod</strong></span> logs for the specific <span class="strong"><strong>SUC</strong></span> plan:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, <span class="strong"><strong>☰ → &lt;your-cluster-name&gt;</strong></span></p></li><li class="listitem"><p>Select <span class="strong"><strong>Workloads → Pods</strong></span></p></li><li class="listitem"><p>Under the namespace drop down menu select the <code class="literal">cattle-system</code> namespace</p><div class="informalfigure"><div class="mediaobject"><a href="images/day2-monitor-suc-deployment-1.png"><img src="images/day2-monitor-suc-deployment-1.png" width="NaN" alt="day2 monitor suc deployment 1" title="day2 monitor suc deployment 1"/></a></div></div></li><li class="listitem"><p>In the Pod filter bar, write the name for your <span class="strong"><strong>SUC Plan</strong></span> Pod. The name will be in the following template format: <code class="literal">apply-&lt;plan_name&gt;-on-&lt;node_name&gt;</code></p><div class="figure" id="id-1.7.4.4.5.4.4.4.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2-k8s-plan-monitor.png"><img src="images/day2-k8s-plan-monitor.png" width="NaN" alt="day2 k8s plan monitor" title="day2 k8s plan monitor"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.1: </span><span class="title-name">Example Kubernetes upgrade plan pods </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.4.5.4.4.4.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>Note how we have one Pod in <span class="strong"><strong>Completed</strong></span> and one in <span class="strong"><strong>Unknown</strong></span> state. This is expected and has happened due to the Kubernetes version upgrade on the node.</p><div class="figure" id="id-1.7.4.4.5.4.4.4.4"><div class="figure-contents"><div class="mediaobject"><a href="images/day2-os-pkg-plan-monitor.png"><img src="images/day2-os-pkg-plan-monitor.png" width="NaN" alt="day2 os pkg plan monitor" title="day2 os pkg plan monitor"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.2: </span><span class="title-name">Example OS upgrade plan pods </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.4.5.4.4.4.4">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>Note how we have one Pod in <span class="strong"><strong>Completed</strong></span> and one in <span class="strong"><strong>Unknown</strong></span> state. This is expected and has happened due to the OS reboot.</p><div class="figure" id="id-1.7.4.4.5.4.4.4.6"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_chart_upgrade_plan_monitor.png"><img src="images/day2_chart_upgrade_plan_monitor.png" width="NaN" alt="day2 chart upgrade plan monitor" title="day2 chart upgrade plan monitor"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.3: </span><span class="title-name">Example of upgrade plan pods for EIB deployed Helm charts on an HA cluster </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.4.5.4.4.4.6">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li><li class="listitem"><p>Select the pod that you want to review the logs of and navigate to <span class="strong"><strong>⋮ → View Logs</strong></span></p></li></ol></div></section></section></section><section class="sect1" id="day2-os-upgrade" data-id-title="OS upgrade"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">25.3 </span><span class="title-name">OS upgrade</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-os-upgrade">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><section class="sect2" id="id-components" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.3.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-components">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers the custom components that the <code class="literal">OS upgrade</code> process uses over the default <code class="literal">Day 2</code> components (<a class="xref" href="id-downstream-clusters.html#day2-downstream-components" title="25.1.1. Components">Section 25.1.1, “Components”</a>).</p><section class="sect3" id="id-systemd-service" data-id-title="systemd.service"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.3.1.1 </span><span class="title-name">systemd.service</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-systemd-service">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A different <a class="link" href="https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html" target="_blank">systemd.service</a> is created depending on what upgrade your OS requires from one Edge version to another:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For Edge versions that require the same OS version (e.g. <code class="literal">6.0</code>), the <code class="literal">os-pkg-update.service</code> will be created. It uses the <a class="link" href="https://kubic.opensuse.org/documentation/man-pages/transactional-update.8.html" target="_blank">transactional-update</a> command to perform a <a class="link" href="https://en.opensuse.org/SDB:Zypper_usage#Updating_packages" target="_blank">normal package upgrade</a>.</p></li><li class="listitem"><p>For Edge versions that require a OS version migration (e.g <code class="literal">5.5</code> → <code class="literal">6.0</code>), the <code class="literal">os-migration.service</code> will be created. It uses <a class="link" href="https://kubic.opensuse.org/documentation/man-pages/transactional-update.8.html" target="_blank">transactional-update</a> to perform:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>First a <a class="link" href="https://en.opensuse.org/SDB:Zypper_usage#Updating_packages" target="_blank">normal package upgrade</a>. Done in order to ensure that all packages are with the latest version before the migration. Mitigating any failures related to old package version.</p></li><li class="listitem"><p>After that it proceeds with the OS migration process by utilising the <code class="literal">zypper migration</code> command.</p></li></ul></div></li></ul></div><p>Shipped through a <span class="strong"><strong>SUC plan</strong></span>, which should be located on each <span class="strong"><strong>downstream cluster</strong></span> that is in need of a OS upgrade.</p></section></section><section class="sect2" id="id-requirements" data-id-title="Requirements"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.3.2 </span><span class="title-name">Requirements</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-requirements">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>General:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>SCC registered machine</strong></span> - All downstream cluster nodes should be registered to <code class="literal"><a class="link" href="https://scc.suse.com/" target="_blank">https://scc.suse.com/</a></code>. This is needed so that the <code class="literal">os-pkg-update.service/os-migration.service</code> can successfully connect to the needed OS RPM repositories.</p><div id="id-1.7.4.5.3.3.1.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>For Edge releases that require a new OS version (e.g Edge 3.1), make sure that your SCC key supports the migration to the new version (e.g. for Edge 3.1, the SCC key should support SLE Micro <code class="literal">5.5</code> → <code class="literal">6.0</code> migration).</p></div></li><li class="listitem"><p><span class="strong"><strong>Make sure that SUC Plan tolerations match node tolerations</strong></span> - If your Kubernetes cluster nodes have custom <span class="strong"><strong>taints</strong></span>, make sure to add <a class="link" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank">tolerations</a> for those taints in the <span class="strong"><strong>SUC Plans</strong></span>. By default <span class="strong"><strong>SUC Plans</strong></span> have tolerations only for <span class="strong"><strong>control-plane</strong></span> nodes. Default tolerations include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>CriticalAddonsOnly=true:NoExecute</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/control-plane:NoSchedule</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/etcd:NoExecute</em></span></p><div id="id-1.7.4.5.3.3.2.2.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Any additional tolerations must be added under the <code class="literal">.spec.tolerations</code> section of each Plan. <span class="strong"><strong>SUC Plans</strong></span> related to the OS upgrade can be found in the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> repository under <code class="literal">fleets/day2/system-upgrade-controller-plans/os-upgrade</code>. <span class="strong"><strong>Make sure you use the Plans from a valid repository <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</strong></span></p><p>An example of defining custom tolerations for the <span class="strong"><strong>control-plane</strong></span> SUC Plan, would look like this:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: cp-os-upgrade-edge-3XX
spec:
  ...
  tolerations:
  # default tolerations
  - key: "CriticalAddonsOnly"
    operator: "Equal"
    value: "true"
    effect: "NoExecute"
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Equal"
    effect: "NoSchedule"
  - key: "node-role.kubernetes.io/etcd"
    operator: "Equal"
    effect: "NoExecute"
  # custom toleration
  - key: "foo"
    operator: "Equal"
    value: "bar"
    effect: "NoSchedule"
...</pre></div></div></li></ul></div></li></ol></div><p><span class="emphasis"><em>Air-gapped:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>Mirror SUSE RPM repositories</strong></span> - OS RPM repositories should be locally mirrored so that <code class="literal">os-pkg-update.service/os-migration.service</code> can have access to them. This can be achieved using <a class="link" href="https://github.com/SUSE/rmt" target="_blank">RMT</a>.</p></li></ol></div></section><section class="sect2" id="id-update-procedure" data-id-title="Update procedure"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.3.3 </span><span class="title-name">Update procedure</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-update-procedure">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.4.5.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This section assumes you will be deploying the <code class="literal">OS upgrade</code> <span class="strong"><strong>SUC Plan</strong></span> using Fleet (<a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>). If you intend to deploy the <span class="strong"><strong>SUC Plan</strong></span> using a different approach, refer to <a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-third-party" title="25.3.4.3. SUC Plan deployment - third-party GitOps workflow">Section 25.3.4.3, “SUC Plan deployment - third-party GitOps workflow”</a>.</p></div><p>The <code class="literal">OS upgrade procedure</code> revolves around deploying <span class="strong"><strong>SUC Plans</strong></span> to downstream clusters. These plans then hold information about how and on which nodes to deploy the <code class="literal">os-pkg-update.service/os-migration.service</code>. For information regarding the structure of a <span class="strong"><strong>SUC Plan</strong></span>, refer to the <a class="link" href="https://github.com/rancher/system-upgrade-controller?tab=readme-ov-file#example-plans" target="_blank">upstream</a> documentation.</p><p><code class="literal">OS upgrade</code> SUC Plans are shipped in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Through a <code class="literal">GitRepo</code> resources - <a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo" title="25.3.4.1. SUC Plan deployment - GitRepo resource">Section 25.3.4.1, “SUC Plan deployment - GitRepo resource”</a></p></li><li class="listitem"><p>Through a <code class="literal">Bundle</code> resource - <a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle" title="25.3.4.2. SUC Plan deployment - Bundle resource">Section 25.3.4.2, “SUC Plan deployment - Bundle resource”</a></p></li></ul></div><p>To determine which resource you should use, refer to <a class="xref" href="id-downstream-clusters.html#day2-determine-use-case" title="25.1.2. Determine your use-case">Section 25.1.2, “Determine your use-case”</a>.</p><p>For a full overview of what happens during the <span class="emphasis"><em>upgrade procedure</em></span>, refer to the <a class="xref" href="id-downstream-clusters.html#os-update-overview" title="25.3.3.1. Overview">Section 25.3.3.1, “Overview”</a> section.</p><section class="sect3" id="os-update-overview" data-id-title="Overview"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.3.3.1 </span><span class="title-name">Overview</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#os-update-overview">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section aims to describe the full workflow that the <span class="strong"><strong><span class="emphasis"><em>OS upgrade process</em></span></strong></span> goes throught from start to finish.</p><div class="figure" id="id-1.7.4.5.4.8.3"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_os_pkg_update_diagram.png"><img src="images/day2_os_pkg_update_diagram.png" width="NaN" alt="day2 os pkg update diagram" title="day2 os pkg update diagram"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.4: </span><span class="title-name">OS upgrade workflow </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.5.4.8.3">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>OS upgrade steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Based on their use-case, the user determines whether to use a <span class="strong"><strong>GitRepo</strong></span> or a <span class="strong"><strong>Bundle</strong></span> resource for the deployment of the <code class="literal">OS upgrade SUC Plans</code> to the desired downstream clusters. For information on how to map a <span class="strong"><strong>GitRepo/Bundle</strong></span> to a specific set of downstream clusters, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>If you are unsure whether you should use a <span class="strong"><strong>GitRepo</strong></span> or a <span class="strong"><strong>Bundle</strong></span> resource for the <span class="strong"><strong>SUC Plan</strong></span> deployment, refer to <a class="xref" href="id-downstream-clusters.html#day2-determine-use-case" title="25.1.2. Determine your use-case">Section 25.1.2, “Determine your use-case”</a>.</p></li><li class="listitem"><p>For <span class="strong"><strong>GitRepo/Bundle</strong></span> configuration options, refer to <a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo" title="25.3.4.1. SUC Plan deployment - GitRepo resource">Section 25.3.4.1, “SUC Plan deployment - GitRepo resource”</a> or <a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle" title="25.3.4.2. SUC Plan deployment - Bundle resource">Section 25.3.4.2, “SUC Plan deployment - Bundle resource”</a>.</p></li></ol></div></li><li class="listitem"><p>The user deploys the configured <span class="strong"><strong>GitRepo/Bundle</strong></span> resource to the <code class="literal">fleet-default</code> namespace in his <code class="literal">management cluster</code>. This is done either <span class="strong"><strong>manually</strong></span> or through the <span class="strong"><strong>Rancher UI</strong></span> if such is available.</p></li><li class="listitem"><p>Fleet (<a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>) constantly monitors the <code class="literal">fleet-default</code> namespace and immediately detects the newly deployed <span class="strong"><strong>GitRepo/Bundle</strong></span> resource. For more information regarding what namespaces does Fleet monitor, refer to Fleet’s <a class="link" href="https://fleet.rancher.io/namespaces" target="_blank">Namespaces</a> documentation.</p></li><li class="listitem"><p>If the user has deployed a <span class="strong"><strong>GitRepo</strong></span> resource, <code class="literal">Fleet</code> will reconcile the <span class="strong"><strong>GitRepo</strong></span> and based on its <span class="strong"><strong>paths</strong></span> and <span class="strong"><strong>fleet.yaml</strong></span> configurations it will deploy a <span class="strong"><strong>Bundle</strong></span> resource in the <code class="literal">fleet-default</code> namespace. For more information, refer to Fleet’s <a class="link" href="https://fleet.rancher.io/gitrepo-content" target="_blank">GitRepo Contents</a> documentation.</p></li><li class="listitem"><p><code class="literal">Fleet</code> then proceeds to deploy the <code class="literal">Kubernetes resources</code> from this <span class="strong"><strong>Bundle</strong></span> to all the targeted <code class="literal">downstream clusters</code>. In the context of <code class="literal">OS upgrades</code>, Fleet deploys the following resources from the <span class="strong"><strong>Bundle</strong></span>:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><span class="strong"><strong>Agent SUC Plan</strong></span> - instructs <span class="strong"><strong>SUC</strong></span> on how to do an OS upgrade on cluster <span class="strong"><strong><span class="emphasis"><em>agent</em></span></strong></span> nodes.  It is <span class="strong"><strong>not</strong></span> interpreted if the cluster consists only from <span class="emphasis"><em>control-plane</em></span> nodes. It executes after all control-plane <span class="strong"><strong>SUC</strong></span> plans have completed successfully.</p></li><li class="listitem"><p><span class="strong"><strong>Control-plane SUC Plan</strong></span> - instructs <span class="strong"><strong>SUC</strong></span> on how to do an OS upgrade on cluster <span class="strong"><strong><span class="emphasis"><em>control-plane</em></span></strong></span> nodes.</p></li><li class="listitem"><p><span class="strong"><strong>Script Secret</strong></span> - referenced in each <span class="strong"><strong>SUC Plan</strong></span>; ships an <code class="literal">upgrade.sh</code> script responsible for creating the <code class="literal">os-pkg-update.service/os-migration.service</code> which will do the actual OS upgrade.</p></li><li class="listitem"><p><span class="strong"><strong>Script Data ConfigMap</strong></span> - referenced in each <span class="strong"><strong>SUC Plan</strong></span>; ships configurations used by the <code class="literal">upgrade.sh</code> script.</p><div id="id-1.7.4.5.4.8.5.5.2.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The above resources will be deployed in the <code class="literal">cattle-system</code> namespace of each downstream cluster.</p></div></li></ol></div></li><li class="listitem"><p>On the downstream cluster, <span class="strong"><strong>SUC</strong></span> picks up the newly deployed <span class="strong"><strong>SUC Plans</strong></span> and deploys an <span class="strong"><strong><span class="emphasis"><em>Update Pod</em></span></strong></span> on each node that matches the <span class="strong"><strong>node selector</strong></span> defined in the <span class="strong"><strong>SUC Plan</strong></span>. For information how to monitor the <span class="strong"><strong>SUC Plan Pod</strong></span>, refer to <a class="xref" href="id-downstream-clusters.html#monitor-suc-plans" title="25.2.2.2. Monitor SUC Plans">Section 25.2.2.2, “Monitor SUC Plans”</a>.</p></li><li class="listitem"><p>The <span class="strong"><strong>Update Pod</strong></span> (deployed on each node) <span class="strong"><strong>mounts</strong></span> the script Secret and <span class="strong"><strong>executes</strong></span> the <code class="literal">upgrade.sh</code> script that the Secret ships.</p></li><li class="listitem"><p>The <code class="literal">upgrade.sh</code> proceeds to do the following:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Based on its configurations, determine whether the OS needs a package update, or it needs to be migrated.</p></li><li class="listitem"><p>Based on the above outcome it will create either a <code class="literal">os-pkg-update.service</code> (for package updates), or a <code class="literal">os-migration.service</code> (for migration). The service will be of type <span class="strong"><strong>oneshot</strong></span> and will adopt the following workflow:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>For <code class="literal">os-pkg-update.service</code>:</p><div class="orderedlist"><ol class="orderedlist" type="A"><li class="listitem"><p>Update all package version on the node OS, by running <code class="literal">transactional-update cleanup up</code></p></li><li class="listitem"><p>After a successful <code class="literal">transactional-update</code>, schedule a system <span class="strong"><strong>reboot</strong></span> so that the package version updates can take effect</p></li></ol></div></li><li class="listitem"><p>For <code class="literal">os-migration.service</code>:</p><div class="orderedlist"><ol class="orderedlist" type="A"><li class="listitem"><p>Update all package version on the node OS, by running <code class="literal">transactional-update cleanup up</code>. This is done to ensure that no old package versions causes an OS migration error.</p></li><li class="listitem"><p>Proceed to migrate the OS to the desired values. Migration is done by utilising the <code class="literal">zypper migration</code> command.</p></li><li class="listitem"><p>Schedule a system <span class="strong"><strong>reboot</strong></span> so that the migration can take effect</p></li></ol></div></li></ol></div></li><li class="listitem"><p>Start the <code class="literal">os-pkg-update.service/os-migration.service</code> and wait for it to complete.</p></li><li class="listitem"><p>Cleanup the <code class="literal">os-pkg-update.service/os-migration.service</code> after the <span class="strong"><strong><span class="emphasis"><em>systemd.service</em></span></strong></span> has done its job. It is removed from the system to ensure that no accidental executions/reboots happen in the future.</p></li></ol></div></li></ol></div><p>The OS upgrade procedure finishes with the <span class="strong"><strong><span class="emphasis"><em>system reboot</em></span></strong></span>. After the reboot, the OS package versions are upgraded and if the Edge release requires it, the OS might be migrated as well.</p></section></section><section class="sect2" id="os-pkg-suc-plan-deployment" data-id-title="OS upgrade - SUC Plan deployment"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.3.4 </span><span class="title-name">OS upgrade - SUC Plan deployment</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#os-pkg-suc-plan-deployment">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section describes how to orchestrate the deployment of <span class="strong"><strong>SUC Plans</strong></span> related OS upgrades using Fleet’s <span class="strong"><strong>GitRepo</strong></span> and <span class="strong"><strong>Bundle</strong></span> resources.</p><section class="sect3" id="os-upgrade-suc-plan-deployment-git-repo" data-id-title="SUC Plan deployment - GitRepo resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.3.4.1 </span><span class="title-name">SUC Plan deployment - GitRepo resource</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>GitRepo</strong></span> resource, that ships the needed <code class="literal">OS upgrade</code> <span class="strong"><strong>SUC Plans</strong></span>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo-rancher" title="25.3.4.1.1. GitRepo creation - Rancher UI">Section 25.3.4.1.1, “GitRepo creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo-manual" title="25.3.4.1.2. GitRepo creation - manual">Section 25.3.4.1.2, “GitRepo creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the OS upgrade process of the nodes of your targeted cluster, refer to the <a class="xref" href="id-downstream-clusters.html#monitor-suc-plans" title="25.2.2.2. Monitor SUC Plans">Section 25.2.2.2, “Monitor SUC Plans”</a> documentation.</p><section class="sect4" id="os-upgrade-suc-plan-deployment-git-repo-rancher" data-id-title="GitRepo creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.3.4.1.1 </span><span class="title-name">GitRepo creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Git Repos → Add Repository</strong></span></p></li></ol></div><p>If you use the <code class="literal">suse-edge/fleet-examples</code> repository:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>Repository URL</strong></span> - <code class="literal"><a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">https://github.com/suse-edge/fleet-examples.git</a></code></p></li><li class="listitem"><p><span class="strong"><strong>Watch → Revision</strong></span> - choose a <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag for the <code class="literal">suse-edge/fleet-examples</code> repository that you wish to use</p></li><li class="listitem"><p>Under <span class="strong"><strong>Paths</strong></span> add the path to the OS upgrade Fleets that you wish to use - <code class="literal">fleets/day2/system-upgrade-controller-plans/os-upgrade</code></p></li><li class="listitem"><p>Select <span class="strong"><strong>Next</strong></span> to move to the <span class="strong"><strong>target</strong></span> configuration section. <span class="strong"><strong>Only select clusters whose node’s packages you wish to upgrade</strong></span></p></li><li class="listitem"><p><span class="strong"><strong>Create</strong></span></p></li></ol></div><p>Alternatively, if you decide to use your own repository to host these files, you would need to provide your repo data above.</p></section><section class="sect4" id="os-upgrade-suc-plan-deployment-git-repo-manual" data-id-title="GitRepo creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.3.4.1.2 </span><span class="title-name">GitRepo creation - manual</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Choose the desired Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you wish to apply the OS <span class="strong"><strong>SUC update Plans</strong></span> from (referenced below as <code class="literal">${REVISION}</code>).</p></li><li class="listitem"><p>Pull the <span class="strong"><strong>GitRepo</strong></span> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o os-update-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/gitrepos/day2/os-update-gitrepo.yaml</pre></div></li><li class="listitem"><p>Edit the <span class="strong"><strong>GitRepo</strong></span> configuration, under <code class="literal">spec.targets</code> specify your desired target list. By default the <code class="literal">GitRepo</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any down stream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters change the default <code class="literal">GitRepo</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>GitRepo</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f os-update-gitrepo.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>GitRepo</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get gitrepo os-upgrade -n fleet-default

# Example output
NAME            REPO                                              COMMIT         BUNDLEDEPLOYMENTS-READY   STATUS
os-upgrade      https://github.com/suse-edge/fleet-examples.git   release-3.1.0  0/0</pre></div></li></ol></div></section></section><section class="sect3" id="os-upgrade-suc-plan-deployment-bundle" data-id-title="SUC Plan deployment - Bundle resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.3.4.2 </span><span class="title-name">SUC Plan deployment - Bundle resource</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>Bundle</strong></span> resource, that ships the needed <code class="literal">OS upgrade</code> <span class="strong"><strong>SUC Plans</strong></span>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle-rancher" title="25.3.4.2.1. Bundle creation - Rancher UI">Section 25.3.4.2.1, “Bundle creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle-manual" title="25.3.4.2.2. Bundle creation - manual">Section 25.3.4.2.2, “Bundle creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the OS upgrade process of the nodes of your targeted cluster, refer to the <a class="xref" href="id-downstream-clusters.html#monitor-suc-plans" title="25.2.2.2. Monitor SUC Plans">Section 25.2.2.2, “Monitor SUC Plans”</a> documentation.</p><section class="sect4" id="os-upgrade-suc-plan-deployment-bundle-rancher" data-id-title="Bundle creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.3.4.2.1 </span><span class="title-name">Bundle creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, click <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Advanced</strong></span> &gt; <span class="strong"><strong>Bundles</strong></span></p></li><li class="listitem"><p>Select <span class="strong"><strong>Create from YAML</strong></span></p></li><li class="listitem"><p>From here you can create the Bundle in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>By manually copying the <span class="strong"><strong>Bundle</strong></span> content to the <span class="strong"><strong>Create from YAML</strong></span> page. Content can be retrieved from <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller-plans/os-upgrade/os-upgrade-bundle.yaml" target="_blank">https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller-plans/os-upgrade/os-upgrade-bundle.yaml</a>, where <code class="literal">${REVISION}</code> is the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> that you are using</p></li><li class="listitem"><p>By cloning the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository to the desired <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag and selecting the <span class="strong"><strong>Read from File</strong></span> option in the <span class="strong"><strong>Create from YAML</strong></span> page. From there, navigate to <code class="literal">bundles/day2/system-upgrade-controller-plans/os-upgrade</code> directory and select <code class="literal">os-upgrade-bundle.yaml</code>. This will auto-populate the <span class="strong"><strong>Create from YAML</strong></span> page with the Bundle content.</p></li></ol></div></li><li class="listitem"><p>Change the <span class="strong"><strong>target</strong></span> clusters for the <code class="literal">Bundle</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all downstream clusters change the default Bundle <code class="literal">.spec.targets</code> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>For a more granular downstream cluster mappings, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p></li></ul></div></li><li class="listitem"><p>Select <span class="strong"><strong>Create</strong></span></p></li></ol></div></section><section class="sect4" id="os-upgrade-suc-plan-deployment-bundle-manual" data-id-title="Bundle creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.3.4.2.2 </span><span class="title-name">Bundle creation - manual</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Choose the desired Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you wish to apply the OS upgrade <span class="strong"><strong>SUC Plans</strong></span> from (referenced below as <code class="literal">${REVISION}</code>).</p></li><li class="listitem"><p>Pull the <span class="strong"><strong>Bundle</strong></span> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o os-upgrade-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller-plans/os-upgrade/os-upgrade-bundle.yaml</pre></div></li><li class="listitem"><p>Edit the <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> configurations, under <code class="literal">spec.targets</code> provide your desired target list. By default the <code class="literal">Bundle</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any down stream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters change the default <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>Bundle</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f os-upgrade-bundle.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>Bundle</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get bundles -n fleet-default</pre></div></li></ol></div></section></section><section class="sect3" id="os-upgrade-suc-plan-deployment-third-party" data-id-title="SUC Plan deployment - third-party GitOps workflow"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.3.4.3 </span><span class="title-name">SUC Plan deployment - third-party GitOps workflow</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#os-upgrade-suc-plan-deployment-third-party">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>There might be use-cases where users would like to incorporate the OS upgrade <span class="strong"><strong>SUC Plans</strong></span> to their own third-party GitOps workflow (e.g. <code class="literal">Flux</code>).</p><p>To get the OS upgrade resources that you need, first determine the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag of the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository that you would like to use.</p><p>After that, resources can be found at <code class="literal">fleets/day2/system-upgrade-controller-plans/os-upgrade</code>, where:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">plan-control-plane.yaml</code> - <code class="literal">system-upgrade-controller</code> Plan resource for <span class="strong"><strong>control-plane</strong></span> nodes</p></li><li class="listitem"><p><code class="literal">plan-agent.yaml</code> - <code class="literal">system-upgrade-controller</code> Plan resource for <span class="strong"><strong>agent</strong></span> nodes</p></li><li class="listitem"><p><code class="literal">secret.yaml</code> - secret that ships a script that creates the <code class="literal">os-pkg-update.service/os-migration.service</code> <a class="link" href="https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html" target="_blank">systemd.service</a></p></li></ul></div><div id="id-1.7.4.5.5.5.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>These <code class="literal">Plan</code> resources are interpreted by the <code class="literal">system-upgrade-controller</code> and should be deployed on each downstream cluster that you wish to upgrade. For information on how to deploy the <code class="literal">system-upgrade-controller</code>, see <a class="xref" href="id-downstream-clusters.html#day2-suc-third-party-gitops" title="25.2.1.3. Deploying system-upgrade-controller when using a third-party GitOps workflow">Section 25.2.1.3, “Deploying system-upgrade-controller when using a third-party GitOps workflow”</a>.</p></div><p>To better understand how your GitOps workflow can be used to deploy the <span class="strong"><strong>SUC Plans</strong></span> for OS upgrade, it can be beneficial to take a look at the overview (<a class="xref" href="id-downstream-clusters.html#os-update-overview" title="25.3.3.1. Overview">Section 25.3.3.1, “Overview”</a>) of the update procedure using <code class="literal">Fleet</code>.</p></section></section></section><section class="sect1" id="day2-k8s-upgrade" data-id-title="Kubernetes version upgrade"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">25.4 </span><span class="title-name">Kubernetes version upgrade</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-k8s-upgrade">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.4.6.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>This section covers Kubernetes upgrades for downstream clusters that have <span class="strong"><strong>NOT</strong></span> been created through a Rancher (<a class="xref" href="components-rancher.html" title="Chapter 4. Rancher">Chapter 4, <em>Rancher</em></a>) instance. For information on how to upgrade the Kubernetes version of <code class="literal">Rancher</code> created clusters, see <a class="link" href="https://ranchermanager.docs.rancher.com/v2.8/getting-started/installation-and-upgrade/upgrade-and-roll-back-kubernetes#upgrading-the-kubernetes-version" target="_blank">Upgrading and Rolling Back Kubernetes</a>.</p></div><section class="sect2" id="id-components-2" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.4.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-components-2">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers the custom components that the <code class="literal">Kubernetes upgrade</code> process uses over the default <code class="literal">Day 2</code> components (<a class="xref" href="id-downstream-clusters.html#day2-downstream-components" title="25.1.1. Components">Section 25.1.1, “Components”</a>).</p><section class="sect3" id="id-rke2-upgrade-2" data-id-title="rke2-upgrade"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.4.1.1 </span><span class="title-name">rke2-upgrade</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-rke2-upgrade-2">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Image responsible for upgrading the RKE2 version of a specific node.</p><p>Shipped through a Pod created by <span class="strong"><strong>SUC</strong></span> based on a <span class="strong"><strong>SUC Plan</strong></span>. The Plan should be located on each <span class="strong"><strong>downstream cluster</strong></span> that is in need of a RKE2 upgrade.</p><p>For more information regarding how the <code class="literal">rke2-upgrade</code> image performs the upgrade, see the <a class="link" href="https://github.com/rancher/rke2-upgrade/tree/master" target="_blank">upstream</a> documentation.</p></section><section class="sect3" id="id-k3s-upgrade" data-id-title="k3s-upgrade"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.4.1.2 </span><span class="title-name">k3s-upgrade</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-k3s-upgrade">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Image responsible for upgrading the K3s version of a specific node.</p><p>Shipped through a Pod created by <span class="strong"><strong>SUC</strong></span> based on a <span class="strong"><strong>SUC Plan</strong></span>. The Plan should be located on each <span class="strong"><strong>downstream cluster</strong></span> that is in need of a K3s upgrade.</p><p>For more information regarding how the <code class="literal">k3s-upgrade</code> image performs the upgrade, see the <a class="link" href="https://github.com/k3s-io/k3s-upgrade" target="_blank">upstream</a> documentation.</p></section></section><section class="sect2" id="id-requirements-2" data-id-title="Requirements"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.4.2 </span><span class="title-name">Requirements</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-requirements-2">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>Backup your Kubernetes distribution:</strong></span></p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>For <span class="strong"><strong>imported RKE2 clusters</strong></span>, see the <a class="link" href="https://docs.rke2.io/backup_restore" target="_blank">RKE2 Backup and Restore</a> documentation.</p></li><li class="listitem"><p>For <span class="strong"><strong>imported K3s clusters</strong></span>, see the <a class="link" href="https://docs.k3s.io/datastore/backup-restore" target="_blank">K3s Backup and Restore</a> documentation.</p></li></ol></div></li><li class="listitem"><p><span class="strong"><strong>Make sure that SUC Plan tolerations match node tolerations</strong></span> - If your Kubernetes cluster nodes have custom <span class="strong"><strong>taints</strong></span>, make sure to add <a class="link" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank">tolerations</a> for those taints in the <span class="strong"><strong>SUC Plans</strong></span>. By default <span class="strong"><strong>SUC Plans</strong></span> have tolerations only for <span class="strong"><strong>control-plane</strong></span> nodes. Default tolerations include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>CriticalAddonsOnly=true:NoExecute</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/control-plane:NoSchedule</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/etcd:NoExecute</em></span></p><div id="id-1.7.4.6.4.2.2.2.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Any additional tolerations must be added under the <code class="literal">.spec.tolerations</code> section of each Plan. <span class="strong"><strong>SUC Plans</strong></span> related to the Kubernetes version upgrade can be found in the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> repository under:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <span class="strong"><strong>RKE2</strong></span> - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade</code></p></li><li class="listitem"><p>For <span class="strong"><strong>K3s</strong></span>  - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade</code></p></li></ul></div><p><span class="strong"><strong>Make sure you use the Plans from a valid repository <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</strong></span></p><p>An example of defining custom tolerations for the RKE2 <span class="strong"><strong>control-plane</strong></span> SUC Plan, would look like this:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: rke2-plan-control-plane
spec:
  ...
  tolerations:
  # default tolerations
  - key: "CriticalAddonsOnly"
    operator: "Equal"
    value: "true"
    effect: "NoExecute"
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Equal"
    effect: "NoSchedule"
  - key: "node-role.kubernetes.io/etcd"
    operator: "Equal"
    effect: "NoExecute"
  # custom toleration
  - key: "foo"
    operator: "Equal"
    value: "bar"
    effect: "NoSchedule"
...</pre></div></div></li></ul></div></li></ol></div></section><section class="sect2" id="id-upgrade-procedure" data-id-title="Upgrade procedure"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.4.3 </span><span class="title-name">Upgrade procedure</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-upgrade-procedure">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.4.6.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This section assumes you will be deploying <span class="strong"><strong>SUC Plans</strong></span> using Fleet (<a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>). If you intend to deploy the <span class="strong"><strong>SUC Plan</strong></span> using a different approach, refer to <a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-third-party" title="25.4.4.3. SUC Plan deployment - third-party GitOps workflow">Section 25.4.4.3, “SUC Plan deployment - third-party GitOps workflow”</a>.</p></div><p>The <code class="literal">Kubernetes version upgrade procedure</code> revolves around deploying <span class="strong"><strong>SUC Plans</strong></span> to downstream clusters. These plans hold information that instructs the <span class="strong"><strong>SUC</strong></span> on which nodes to create Pods which run the <code class="literal">rke2/k3s-upgrade</code> images. For information regarding the structure of a <span class="strong"><strong>SUC Plan</strong></span>, refer to the <a class="link" href="https://github.com/rancher/system-upgrade-controller?tab=readme-ov-file#example-plans" target="_blank">upstream</a> documentation.</p><p><code class="literal">Kubernetes upgrade</code> Plans are shipped in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Through a <code class="literal">GitRepo</code> resources - <a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo" title="25.4.4.1. SUC Plan deployment - GitRepo resource">Section 25.4.4.1, “SUC Plan deployment - GitRepo resource”</a></p></li><li class="listitem"><p>Through a <code class="literal">Bundle</code> resource - <a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle" title="25.4.4.2. SUC Plan deployment - Bundle resource">Section 25.4.4.2, “SUC Plan deployment - Bundle resource”</a></p></li></ul></div><p>To determine which resource you should use, refer to <a class="xref" href="id-downstream-clusters.html#day2-determine-use-case" title="25.1.2. Determine your use-case">Section 25.1.2, “Determine your use-case”</a>.</p><p>For a full overview of what happens during the <span class="emphasis"><em>update procedure</em></span>, refer to the <a class="xref" href="id-downstream-clusters.html#k8s-version-upgrade-overview" title="25.4.3.1. Overview">Section 25.4.3.1, “Overview”</a> section.</p><section class="sect3" id="k8s-version-upgrade-overview" data-id-title="Overview"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.4.3.1 </span><span class="title-name">Overview</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#k8s-version-upgrade-overview">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section aims to describe the full workflow that the <span class="strong"><strong><span class="emphasis"><em>Kubernetes version upgrade process</em></span></strong></span> goes throught from start to finish.</p><div class="figure" id="id-1.7.4.6.5.8.3"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_k8s_version_upgrade_diagram.png"><img src="images/day2_k8s_version_upgrade_diagram.png" width="NaN" alt="day2 k8s version upgrade diagram" title="day2 k8s version upgrade diagram"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.5: </span><span class="title-name">Kubernetes version upgrade workflow </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.6.5.8.3">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>Kubernetes version upgrade steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Based on his use-case, the user determines whether to use a <span class="strong"><strong>GitRepo</strong></span> or a <span class="strong"><strong>Bundle</strong></span> resource for the deployment of the <code class="literal">Kubernetes upgrade SUC Plans</code> to the desired downstream clusters. For information on how to map a <span class="strong"><strong>GitRepo/Bundle</strong></span> to a specific set of downstream clusters, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>If you are unsure whether you should use a <span class="strong"><strong>GitRepo</strong></span> or a <span class="strong"><strong>Bundle</strong></span> resource for the <span class="strong"><strong>SUC Plan</strong></span> deployment, refer to <a class="xref" href="id-downstream-clusters.html#day2-determine-use-case" title="25.1.2. Determine your use-case">Section 25.1.2, “Determine your use-case”</a>.</p></li><li class="listitem"><p>For <span class="strong"><strong>GitRepo/Bundle</strong></span> configuration options, refer to <a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo" title="25.4.4.1. SUC Plan deployment - GitRepo resource">Section 25.4.4.1, “SUC Plan deployment - GitRepo resource”</a> or <a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle" title="25.4.4.2. SUC Plan deployment - Bundle resource">Section 25.4.4.2, “SUC Plan deployment - Bundle resource”</a>.</p></li></ol></div></li><li class="listitem"><p>The user deploys the configured <span class="strong"><strong>GitRepo/Bundle</strong></span> resource to the <code class="literal">fleet-default</code> namespace in his <code class="literal">management cluster</code>. This is done either <span class="strong"><strong>manually</strong></span> or thorugh the <span class="strong"><strong>Rancher UI</strong></span> if such is available.</p></li><li class="listitem"><p>Fleet (<a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>) constantly monitors the <code class="literal">fleet-default</code> namespace and immediately detects the newly deployed <span class="strong"><strong>GitRepo/Bundle</strong></span> resource. For more information regarding what namespaces does Fleet monitor, refer to Fleet’s <a class="link" href="https://fleet.rancher.io/namespaces" target="_blank">Namespaces</a> documentation.</p></li><li class="listitem"><p>If the user has deployed a <span class="strong"><strong>GitRepo</strong></span> resource, <code class="literal">Fleet</code> will reconcile the <span class="strong"><strong>GitRepo</strong></span> and based on its <span class="strong"><strong>paths</strong></span> and <span class="strong"><strong>fleet.yaml</strong></span> configurations it will deploy a <span class="strong"><strong>Bundle</strong></span> resource in the <code class="literal">fleet-default</code> namespace. For more information, refer to Fleet’s <a class="link" href="https://fleet.rancher.io/gitrepo-content" target="_blank">GitRepo Contents</a> documentation.</p></li><li class="listitem"><p><code class="literal">Fleet</code> then proceeds to deploy the <code class="literal">Kubernetes resources</code> from this <span class="strong"><strong>Bundle</strong></span> to all the targeted <code class="literal">downstream clusters</code>. In the context of the <code class="literal">Kubernetes version upgrade</code>, Fleet deploys the following resources from the <span class="strong"><strong>Bundle</strong></span> (depending on the Kubernetes distrubution):</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><code class="literal">rke2-plan-agent</code>/<code class="literal">k3s-plan-agent</code> - instructs <span class="strong"><strong>SUC</strong></span> on how to do a Kubernetes upgrade on cluster <span class="strong"><strong><span class="emphasis"><em>agent</em></span></strong></span> nodes. Will <span class="strong"><strong>not</strong></span> be interpreted if the cluster consists only from <span class="emphasis"><em>control-plane</em></span> nodes.</p></li><li class="listitem"><p><code class="literal">rke2-plan-control-plane</code>/<code class="literal">k3s-plan-control-plane</code> - instructs <span class="strong"><strong>SUC</strong></span> on how to do a Kubernetes upgrade on cluster <span class="strong"><strong><span class="emphasis"><em>control-plane</em></span></strong></span> nodes.</p><div id="id-1.7.4.6.5.8.5.5.2.2.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The above <span class="strong"><strong>SUC Plans</strong></span> will be deployed in the <code class="literal">cattle-system</code> namespace of each downstream cluster.</p></div></li></ol></div></li><li class="listitem"><p>On the downstream cluster, <span class="strong"><strong>SUC</strong></span> picks up the newly deployed <span class="strong"><strong>SUC Plans</strong></span> and deploys an <span class="strong"><strong><span class="emphasis"><em>Update Pod</em></span></strong></span> on each node that matches the <span class="strong"><strong>node selector</strong></span> defined in the <span class="strong"><strong>SUC Plan</strong></span>. For information how to monitor the <span class="strong"><strong>SUC Plan Pod</strong></span>, refer to <a class="xref" href="id-downstream-clusters.html#monitor-suc-plans" title="25.2.2.2. Monitor SUC Plans">Section 25.2.2.2, “Monitor SUC Plans”</a>.</p></li><li class="listitem"><p>Depending on which <span class="strong"><strong>SUC Plans</strong></span> you have deployed, the <span class="strong"><strong>Update Pod</strong></span> will run either a <a class="link" href="https://hub.docker.com/r/rancher/rke2-upgrade/tags" target="_blank">rke2-upgrade</a> or a <a class="link" href="https://hub.docker.com/r/rancher/k3s-upgrade/tags" target="_blank">k3s-upgrade</a> image and will execute the following workflow on <span class="strong"><strong>each</strong></span> cluster node:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cordon/" target="_blank">Cordon</a> cluster node - to ensure that no pods are scheduled accidentally on this node while it is being upgraded, we mark it as <code class="literal">unschedulable</code>.</p></li><li class="listitem"><p>Replace the <code class="literal">rke2/k3s</code> binary that is installed on the node OS with the binary shipped by the <code class="literal">rke2-upgrade/k3s-upgrade</code> image that the Pod is currently running.</p></li><li class="listitem"><p>Kill the <code class="literal">rke2/k3s</code> process that is running on the node OS - this instructs the <span class="strong"><strong>supervisor</strong></span> to automatically restart the <code class="literal">rke2/k3s</code> process using the new version.</p></li><li class="listitem"><p><a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_uncordon/" target="_blank">Uncordon</a> cluster node - after the successful Kubernetes distribution upgrade, the node is again marked as <code class="literal">scheduable</code>.</p><div id="id-1.7.4.6.5.8.5.7.2.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>For further information regarding how the <code class="literal">rke2-upgrade</code> and <code class="literal">k3s-upgrade</code> images work, see the <a class="link" href="https://github.com/rancher/rke2-upgrade" target="_blank">rke2-upgrade</a> and <a class="link" href="https://github.com/k3s-io/k3s-upgrade" target="_blank">k3s-upgrade</a> upstream projects.</p></div></li></ol></div></li></ol></div><p>With the above steps executed, the Kubernetes version of each cluster node should have been upgraded to the desired Edge compatible <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a>.</p></section></section><section class="sect2" id="k8s-upgrade-suc-plan-deployment" data-id-title="Kubernetes version upgrade - SUC Plan deployment"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.4.4 </span><span class="title-name">Kubernetes version upgrade - SUC Plan deployment</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><section class="sect3" id="k8s-upgrade-suc-plan-deployment-git-repo" data-id-title="SUC Plan deployment - GitRepo resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.4.4.1 </span><span class="title-name">SUC Plan deployment - GitRepo resource</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>GitRepo</strong></span> resource, that ships the needed <code class="literal">Kubernetes upgrade</code> <span class="strong"><strong>SUC Plans</strong></span>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo-rancher" title="25.4.4.1.1. GitRepo creation - Rancher UI">Section 25.4.4.1.1, “GitRepo creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo-manual" title="25.4.4.1.2. GitRepo creation - manual">Section 25.4.4.1.2, “GitRepo creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the Kubernetes upgrade process of the nodes of your targeted cluster, refer to the <a class="xref" href="id-downstream-clusters.html#monitor-suc-plans" title="25.2.2.2. Monitor SUC Plans">Section 25.2.2.2, “Monitor SUC Plans”</a> documentation.</p><section class="sect4" id="k8s-upgrade-suc-plan-deployment-git-repo-rancher" data-id-title="GitRepo creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.4.4.1.1 </span><span class="title-name">GitRepo creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Git Repos → Add Repository</strong></span></p></li></ol></div><p>If you use the <code class="literal">suse-edge/fleet-examples</code> repository:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>Repository URL</strong></span> - <code class="literal"><a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">https://github.com/suse-edge/fleet-examples.git</a></code></p></li><li class="listitem"><p><span class="strong"><strong>Watch → Revision</strong></span> - choose a <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag for the <code class="literal">suse-edge/fleet-examples</code> repository that you wish to use</p></li><li class="listitem"><p>Under <span class="strong"><strong>Paths</strong></span> add the path to the Kubernetes distribution upgrade Fleets as seen in the release tag:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>For RKE2 - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade</code></p></li><li class="listitem"><p>For K3s  - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade</code></p></li></ol></div></li><li class="listitem"><p>Select <span class="strong"><strong>Next</strong></span> to move to the <span class="strong"><strong>target</strong></span> configuration section. <span class="strong"><strong>Only select clusters for which you wish to upgrade the desired Kubernetes distribution</strong></span></p></li><li class="listitem"><p><span class="strong"><strong>Create</strong></span></p></li></ol></div><p>Alternatively, if you decide to use your own repository to host these files, you would need to provide your repo data above.</p></section><section class="sect4" id="k8s-upgrade-suc-plan-deployment-git-repo-manual" data-id-title="GitRepo creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.4.4.1.2 </span><span class="title-name">GitRepo creation - manual</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Choose the desired Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you wish to apply the Kubernetes <span class="strong"><strong>SUC upgrade Plans</strong></span> from (referenced below as <code class="literal">${REVISION}</code>).</p></li><li class="listitem"><p>Pull the <span class="strong"><strong>GitRepo</strong></span> resource:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <span class="strong"><strong>RKE2</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o rke2-upgrade-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/gitrepos/day2/rke2-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>For <span class="strong"><strong>K3s</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o k3s-upgrade-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/gitrepos/day2/k3s-upgrade-gitrepo.yaml</pre></div></li></ul></div></li><li class="listitem"><p>Edit the <span class="strong"><strong>GitRepo</strong></span> configuration, under <code class="literal">spec.targets</code> specify your desired target list. By default the <code class="literal">GitRepo</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any down stream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters change the default <code class="literal">GitRepo</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>GitRepo</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># RKE2
kubectl apply -f rke2-upgrade-gitrepo.yaml

# K3s
kubectl apply -f k3s-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>GitRepo</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># RKE2
kubectl get gitrepo rke2-upgrade -n fleet-default

# K3s
kubectl get gitrepo k3s-upgrade -n fleet-default

# Example output
NAME           REPO                                              COMMIT          BUNDLEDEPLOYMENTS-READY   STATUS
k3s-upgrade    https://github.com/suse-edge/fleet-examples.git   release-3.0.1   0/0
rke2-upgrade   https://github.com/suse-edge/fleet-examples.git   release-3.0.1   0/0</pre></div></li></ol></div></section></section><section class="sect3" id="k8s-upgrade-suc-plan-deployment-bundle" data-id-title="SUC Plan deployment - Bundle resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.4.4.2 </span><span class="title-name">SUC Plan deployment - Bundle resource</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>Bundle</strong></span> resource, that ships the needed <code class="literal">Kubernetes upgrade</code> <span class="strong"><strong>SUC Plans</strong></span>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle-rancher" title="25.4.4.2.1. Bundle creation - Rancher UI">Section 25.4.4.2.1, “Bundle creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle-manual" title="25.4.4.2.2. Bundle creation - manual">Section 25.4.4.2.2, “Bundle creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the Kubernetes upgrade process of the nodes of your targeted cluster, refer to the <a class="xref" href="id-downstream-clusters.html#monitor-suc-plans" title="25.2.2.2. Monitor SUC Plans">Section 25.2.2.2, “Monitor SUC Plans”</a> documentation.</p><section class="sect4" id="k8s-upgrade-suc-plan-deployment-bundle-rancher" data-id-title="Bundle creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.4.4.2.1 </span><span class="title-name">Bundle creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, click <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Advanced</strong></span> &gt; <span class="strong"><strong>Bundles</strong></span></p></li><li class="listitem"><p>Select <span class="strong"><strong>Create from YAML</strong></span></p></li><li class="listitem"><p>From here you can create the Bundle in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>By manually copying the <span class="strong"><strong>Bundle</strong></span> content to the <span class="strong"><strong>Create from YAML</strong></span> page. Content can be retrieved:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>For RKE2 - <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml" target="_blank">https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml</a></p></li><li class="listitem"><p>For K3s - <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml" target="_blank">https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml</a></p></li></ol></div></li><li class="listitem"><p>By cloning the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository to the desired <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag and selecting the <span class="strong"><strong>Read from File</strong></span> option in the <span class="strong"><strong>Create from YAML</strong></span> page. From there, navigate to the bundle that you need (<code class="literal">/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml</code> for RKE2 and <code class="literal">/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml</code> for K3s). This will auto-populate the <span class="strong"><strong>Create from YAML</strong></span> page with the Bundle content</p></li></ol></div></li><li class="listitem"><p>Change the <span class="strong"><strong>target</strong></span> clusters for the <code class="literal">Bundle</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all downstream clusters change the default Bundle <code class="literal">.spec.targets</code> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>For a more granular downstream cluster mappings, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p></li></ul></div></li><li class="listitem"><p><span class="strong"><strong>Create</strong></span></p></li></ol></div></section><section class="sect4" id="k8s-upgrade-suc-plan-deployment-bundle-manual" data-id-title="Bundle creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.4.4.2.2 </span><span class="title-name">Bundle creation - manual</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Choose the desired Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you wish to apply the Kubernetes <span class="strong"><strong>SUC upgrade Plans</strong></span> from (referenced below as <code class="literal">${REVISION}</code>).</p></li><li class="listitem"><p>Pull the <span class="strong"><strong>Bundle</strong></span> resources:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <span class="strong"><strong>RKE2</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o rke2-plan-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml</pre></div></li><li class="listitem"><p>For <span class="strong"><strong>K3s</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o k3s-plan-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/${REVISION}/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml</pre></div></li></ul></div></li><li class="listitem"><p>Edit the <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> configurations, under <code class="literal">spec.targets</code> provide your desired target list. By default the <code class="literal">Bundle</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any down stream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters change the default <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>Bundle</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For RKE2
kubectl apply -f rke2-plan-bundle.yaml

# For K3s
kubectl apply -f k3s-plan-bundle.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>Bundle</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For RKE2
kubectl get bundles rke2-upgrade -n fleet-default

# For K3s
kubectl get bundles k3s-upgrade -n fleet-default

# Example output
NAME           BUNDLEDEPLOYMENTS-READY   STATUS
k3s-upgrade    0/0
rke2-upgrade   0/0</pre></div></li></ol></div></section></section><section class="sect3" id="k8s-upgrade-suc-plan-deployment-third-party" data-id-title="SUC Plan deployment - third-party GitOps workflow"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.4.4.3 </span><span class="title-name">SUC Plan deployment - third-party GitOps workflow</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-third-party">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>There might be use-cases where users would like to incorporate the Kubernetes upgrade resources to their own third-party GitOps workflow (e.g. <code class="literal">Flux</code>).</p><p>To get the upgrade resources that you need, first determine the he Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag of the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository that you would like to use.</p><p>After that, the resources can be found at:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For a RKE2 cluster upgrade:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">control-plane</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade/plan-control-plane.yaml</code></p></li><li class="listitem"><p>For <code class="literal">agent</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade/plan-agent.yaml</code></p></li></ul></div></li><li class="listitem"><p>For a K3s cluster upgrade:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">control-plane</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade/plan-control-plane.yaml</code></p></li><li class="listitem"><p>For <code class="literal">agent</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade/plan-agent.yaml</code></p></li></ul></div></li></ul></div><div id="id-1.7.4.6.6.4.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>These <code class="literal">Plan</code> resources are interpreted by the <code class="literal">system-upgrade-controller</code> and should be deployed on each downstream cluster that you wish to upgrade. For information on how to deploy the <code class="literal">system-upgrade-controller</code>, see <a class="xref" href="id-downstream-clusters.html#day2-suc-third-party-gitops" title="25.2.1.3. Deploying system-upgrade-controller when using a third-party GitOps workflow">Section 25.2.1.3, “Deploying system-upgrade-controller when using a third-party GitOps workflow”</a>.</p></div><p>To better understand how your GitOps workflow can be used to deploy the <span class="strong"><strong>SUC Plans</strong></span> for Kubernetes version upgrade, it can be beneficial to take a look at the overview (<a class="xref" href="id-downstream-clusters.html#k8s-version-upgrade-overview" title="25.4.3.1. Overview">Section 25.4.3.1, “Overview”</a>) of the update procedure using <code class="literal">Fleet</code>.</p></section></section></section><section class="sect1" id="day2-helm-upgrade" data-id-title="Helm chart upgrade"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">25.5 </span><span class="title-name">Helm chart upgrade</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-helm-upgrade">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.4.7.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The below sections focus on using <code class="literal">Fleet</code> functionalities to achieve a Helm chart update.</p><p>Users adopting a third-party GitOps workflow, should take the configurations for their desired helm chart from its <code class="literal">fleet.yaml</code> located at <code class="literal">fleets/day2/chart-templates/&lt;chart-name&gt;</code>. <span class="strong"><strong>Make sure you are retrieving the chart data from a valid "Day 2" Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a>.</strong></span></p></div><section class="sect2" id="id-components-3" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.5.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-components-3">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Apart from the default <code class="literal">Day 2</code> components (<a class="xref" href="id-downstream-clusters.html#day2-downstream-components" title="25.1.1. Components">Section 25.1.1, “Components”</a>), no other custom components are needed for this operation.</p></section><section class="sect2" id="id-preparation-for-air-gapped-environments" data-id-title="Preparation for air-gapped environments"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.5.2 </span><span class="title-name">Preparation for air-gapped environments</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-preparation-for-air-gapped-environments">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><section class="sect3" id="id-ensure-that-you-have-access-to-your-helm-charts-upgrade-fleet-yaml-file" data-id-title="Ensure that you have access to your Helm chart’s upgrade fleet.yaml file"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.2.1 </span><span class="title-name">Ensure that you have access to your Helm chart’s upgrade <code class="literal">fleet.yaml</code> file</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-ensure-that-you-have-access-to-your-helm-charts-upgrade-fleet-yaml-file">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Host the needed resources on a local git server that is accessible by your <code class="literal">management cluster</code>.</p></section><section class="sect3" id="id-find-the-required-assets-for-your-edge-release-version" data-id-title="Find the required assets for your Edge release version"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.2.2 </span><span class="title-name">Find the required assets for your Edge release version</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-find-the-required-assets-for-your-edge-release-version">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Go to the Day 2 <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> page and find the Edge 3.X.Y release that you want to upgrade your chart to and click <span class="strong"><strong>Assets</strong></span>.</p></li><li class="listitem"><p>From the release’s <span class="strong"><strong>Assets</strong></span> section, download the following files, which are required for an air-gapped upgrade of a SUSE supported helm chart:</p><div class="informaltable"><table style="border-collapse: collapse; border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><colgroup><col class="col_1"/><col class="col_2"/></colgroup><tbody><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="strong"><strong>Release File</strong></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p><span class="strong"><strong>Description</strong></span></p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-save-images.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>This script pulls the images in the <code class="literal">edge-release-images.txt</code> file and saves them to a '.tar.gz' archive that can then be used in your air-gapped environment.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-save-oci-artefacts.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>This script pulls the SUSE OCI chart artefacts in the <code class="literal">edge-release-helm-oci-artefacts.txt</code> file and creates a '.tar.gz' archive of a directory containing all other chart OCI archives.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-load-images.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>This script loads the images in the '.tar.gz' archive generated by <code class="literal">edge-save-images.sh</code>, retags them and pushes them to your private registry.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-load-oci-artefacts.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>This script takes a directory containing '.tgz' SUSE OCI charts and loads all OCI charts to your private registry. The directory is retrieved from the '.tar.gz' archive that the <code class="literal">edge-save-oci-artefacts.sh</code> script has generated.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-release-helm-oci-artefacts.txt</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>This file contains a list of OCI artefacts for the SUSE Edge release Helm charts.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; "><p><span class="emphasis"><em>edge-release-images.txt</em></span></p></td><td style="text-align: left; vertical-align: top; "><p>This file contains a list of images needed by the Edge release Helm charts.</p></td></tr></tbody></table></div></li></ol></div></section><section class="sect3" id="id-create-the-suse-edge-release-images-archive" data-id-title="Create the SUSE Edge release images archive"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.2.3 </span><span class="title-name">Create the SUSE Edge release images archive</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-create-the-suse-edge-release-images-archive">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On a machine with internet access:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Make <code class="literal">edge-save-images.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-save-images.sh</pre></div></li><li class="listitem"><p>Use <code class="literal">edge-save-images.sh</code> script to create a <span class="emphasis"><em>Docker</em></span> importable '.tar.gz' archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-save-images.sh --source-registry registry.suse.com</pre></div></li><li class="listitem"><p>This will create a ready to load <code class="literal">edge-images.tar.gz</code> (unless you have specified the <code class="literal">-i|--images</code> option) archive with the needed images.</p></li><li class="listitem"><p>Copy this archive to your <span class="strong"><strong>air-gapped</strong></span> machine</p><div class="verbatim-wrap highlight bash"><pre class="screen">scp edge-images.tar.gz &lt;user&gt;@&lt;machine_ip&gt;:/path</pre></div></li></ol></div></section><section class="sect3" id="id-create-a-suse-edge-helm-chart-oci-images-archive" data-id-title="Create a SUSE Edge Helm chart OCI images archive"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.2.4 </span><span class="title-name">Create a SUSE Edge Helm chart OCI images archive</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-create-a-suse-edge-helm-chart-oci-images-archive">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On a machine with internet access:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Make <code class="literal">edge-save-oci-artefacts.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-save-oci-artefacts.sh</pre></div></li><li class="listitem"><p>Use <code class="literal">edge-save-oci-artefacts.sh</code> script to create a '.tar.gz' archive of all SUSE Edge Helm chart OCI images:</p><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-save-oci-artefacts.sh --source-registry registry.suse.com</pre></div></li><li class="listitem"><p>This will create a <code class="literal">oci-artefacts.tar.gz</code> archive containing all SUSE Edge Helm chart OCI images</p></li><li class="listitem"><p>Copy this archive to your <span class="strong"><strong>air-gapped</strong></span> machine</p><div class="verbatim-wrap highlight bash"><pre class="screen">scp oci-artefacts.tar.gz &lt;user&gt;@&lt;machine_ip&gt;:/path</pre></div></li></ol></div></section><section class="sect3" id="id-load-suse-edge-release-images-to-your-air-gapped-machine" data-id-title="Load SUSE Edge release images to your air-gapped machine"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.2.5 </span><span class="title-name">Load SUSE Edge release images to your air-gapped machine</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-load-suse-edge-release-images-to-your-air-gapped-machine">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On your air-gapped machine:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log into your private registry (if required):</p><div class="verbatim-wrap highlight bash"><pre class="screen">podman login &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt;</pre></div></li><li class="listitem"><p>Make <code class="literal">edge-load-images.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-load-images.sh</pre></div></li><li class="listitem"><p>Use <code class="literal">edge-load-images.sh</code> to load the images from the <span class="strong"><strong>copied</strong></span> <code class="literal">edge-images.tar.gz</code> archive, retag them and push them to your private registry:</p><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-load-images.sh --source-registry registry.suse.com --registry &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt; --images edge-images.tar.gz</pre></div></li></ol></div></section><section class="sect3" id="id-load-suse-edge-helm-chart-oci-images-to-your-air-gapped-machine" data-id-title="Load SUSE Edge Helm chart OCI images to your air-gapped machine"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.2.6 </span><span class="title-name">Load SUSE Edge Helm chart OCI images to your air-gapped machine</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-load-suse-edge-helm-chart-oci-images-to-your-air-gapped-machine">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On your air-gapped machine:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log into your private registry (if required):</p><div class="verbatim-wrap highlight bash"><pre class="screen">podman login &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt;</pre></div></li><li class="listitem"><p>Make <code class="literal">edge-load-oci-artefacts.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-load-oci-artefacts.sh</pre></div></li><li class="listitem"><p>Untar the copied <code class="literal">oci-artefacts.tar.gz</code> archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">tar -xvf oci-artefacts.tar.gz</pre></div></li><li class="listitem"><p>This will produce a directory with the naming template <code class="literal">edge-release-oci-tgz-&lt;date&gt;</code></p></li><li class="listitem"><p>Pass this directory to the <code class="literal">edge-load-oci-artefacts.sh</code> script to load the SUSE Edge helm chart OCI images to your private registry:</p><div id="id-1.7.4.7.4.7.3.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This script assumes the <code class="literal">helm</code> CLI has been pre-installed on your environment. For Helm installation instructions, see <a class="link" href="https://helm.sh/docs/intro/install/" target="_blank">Installing Helm</a>.</p></div><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-load-oci-artefacts.sh --archive-directory edge-release-oci-tgz-&lt;date&gt; --registry &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt; --source-registry registry.suse.com</pre></div></li></ol></div></section><section class="sect3" id="id-create-registry-mirrors-pointing-to-your-private-registry-for-your-kubernetes-distribution" data-id-title="Create registry mirrors pointing to your private registry for your Kubernetes distribution"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.2.7 </span><span class="title-name">Create registry mirrors pointing to your private registry for your Kubernetes distribution</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-create-registry-mirrors-pointing-to-your-private-registry-for-your-kubernetes-distribution">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>For RKE2, see <a class="link" href="https://docs.rke2.io/install/containerd_registry_configuration" target="_blank">Containerd Registry Configuration</a></p><p>For K3s, see <a class="link" href="https://docs.k3s.io/installation/registry-mirror" target="_blank">Embedded Registry Mirror</a></p></section></section><section class="sect2" id="id-upgrade-procedure-2" data-id-title="Upgrade procedure"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">25.5.3 </span><span class="title-name">Upgrade procedure</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-upgrade-procedure-2">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.4.7.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The below upgrade procedure utilises Rancher’s Fleet (<a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>) funtionality. Users using a third-party GitOps workflow should retrieve the chart versions supported by each Edge release from the <a class="xref" href="id-release-notes.html#release-notes" title="33.1. Abstract">Section 33.1, “Abstract”</a> and populate these versions to their third-party GitOps workflow.</p></div><p>This section focuses on the following Helm upgrade procedure use-cases:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>I have a new cluster and would like to deploy and manage a SUSE Helm chart (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-new-cluster" title="25.5.3.1. I have a new cluster and would like to deploy and manage a SUSE Helm chart">Section 25.5.3.1, “I have a new cluster and would like to deploy and manage a SUSE Helm chart”</a>)</p></li><li class="listitem"><p>I would like to upgrade a Fleet managed Helm chart (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-fleet-managed-chart" title="25.5.3.2. I would like to upgrade a Fleet managed Helm chart">Section 25.5.3.2, “I would like to upgrade a Fleet managed Helm chart”</a>)</p></li><li class="listitem"><p>I would like to upgrade an EIB created Helm chart (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart" title="25.5.3.3. I would like to upgrade an EIB created Helm chart">Section 25.5.3.3, “I would like to upgrade an EIB created Helm chart”</a>)</p></li></ol></div><div id="id-1.7.4.7.5.5" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Manually deployed Helm charts cannot be reliably upgraded. We suggest to redeploy the helm chart using the <a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-new-cluster" title="25.5.3.1. I have a new cluster and would like to deploy and manage a SUSE Helm chart">Section 25.5.3.1, “I have a new cluster and would like to deploy and manage a SUSE Helm chart”</a> method.</p></div><section class="sect3" id="day2-helm-upgrade-new-cluster" data-id-title="I have a new cluster and would like to deploy and manage a SUSE Helm chart"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.3.1 </span><span class="title-name">I have a new cluster and would like to deploy and manage a SUSE Helm chart</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-helm-upgrade-new-cluster">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>For users that want to manage their Helm chart lifecycle through Fleet.</p><section class="sect4" id="id-prepare-your-fleet-resources" data-id-title="Prepare your Fleet resources"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.5.3.1.1 </span><span class="title-name">Prepare your Fleet resources</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-prepare-your-fleet-resources">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Acquire the Chart’s Fleet resources from the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you wish to use</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>From the selected Edge release tag revision, navigate to the Helm chart fleet - <code class="literal">fleets/day2/chart-templates/&lt;chart&gt;</code></p></li><li class="listitem"><p>Copy the chart Fleet directory to the Git repository that you will be using for your GitOps workflow</p></li><li class="listitem"><p><span class="strong"><strong>Optionally</strong></span>, if the Helm chart requires configurations to its <span class="strong"><strong>values</strong></span>, edit the <code class="literal">.helm.values</code> configuration inside the <code class="literal">fleet.yaml</code> file of the copied directory</p></li><li class="listitem"><p><span class="strong"><strong>Optionally</strong></span>, there may be use-cases where you need to add additional resources to your chart’s fleet so that it can better fit your environment. For information on how to enhance your Fleet directory, see <a class="link" href="https://fleet.rancher.io/gitrepo-content" target="_blank">Git Repository Contents</a></p></li></ol></div></li></ol></div><p>An <span class="strong"><strong>example</strong></span> for the <code class="literal">longhorn</code> helm chart would look like:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>User Git repository strucutre:</p><div class="verbatim-wrap highlight bash"><pre class="screen">&lt;user_repository_root&gt;
└── longhorn
    └── fleet.yaml</pre></div></li><li class="listitem"><p><code class="literal">fleet.yaml</code> content populated with user <code class="literal">longhorn</code> data:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">defaultNamespace: longhorn-system

helm:
  releaseName: "longhorn"
  chart: "longhorn"
  repo: "https://charts.longhorn.io"
  version: "1.6.1"
  takeOwnership: true
  # custom chart value overrides
  values:
    # Example for user provided custom values content
    defaultSettings:
      deletingConfirmationFlag: true

# https://fleet.rancher.io/bundle-diffs
diff:
  comparePatches:
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: engineimages.longhorn.io
    operations:
    - {"op":"remove", "path":"/status/conditions"}
    - {"op":"remove", "path":"/status/storedVersions"}
    - {"op":"remove", "path":"/status/acceptedNames"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: nodes.longhorn.io
    operations:
    - {"op":"remove", "path":"/status/conditions"}
    - {"op":"remove", "path":"/status/storedVersions"}
    - {"op":"remove", "path":"/status/acceptedNames"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: volumes.longhorn.io
    operations:
    - {"op":"remove", "path":"/status/conditions"}
    - {"op":"remove", "path":"/status/storedVersions"}
    - {"op":"remove", "path":"/status/acceptedNames"}</pre></div><div id="id-1.7.4.7.5.6.3.4.2.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>These are just example values that are used to illustrate custom configurations over the <code class="literal">longhorn</code> chart. They should <span class="strong"><strong>NOT</strong></span> be treated as deployment guidelines for the <code class="literal">longhorn</code> chart.</p></div></li></ul></div></section><section class="sect4" id="id-create-the-gitrepo" data-id-title="Create the GitRepo"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.5.3.1.2 </span><span class="title-name">Create the GitRepo</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-create-the-gitrepo">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>After populating your repository with the chart’s Fleet resources, you must create a <a class="link" href="https://fleet.rancher.io/ref-gitrepo" target="_blank">GitRepo</a> resource. This resource will hold information on how to access your chart’s Fleet resources and to which clusters it needs to apply those resources.</p><p>The <code class="literal">GitRepo</code> resource can be created through the Rancher UI, or by manually deploying the resource to the <code class="literal">management cluster</code>.</p><p>For information on how to create and deploy the GitRepo resource <span class="strong"><strong>manually</strong></span>, see <a class="link" href="https://fleet.rancher.io/tut-deployment" target="_blank">Creating a Deployment</a>.</p><p>To create a <code class="literal">GitRepo</code> resource through the <span class="strong"><strong>Rancher UI</strong></span>, see <a class="link" href="https://ranchermanager.docs.rancher.com/v2.8/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">Accessing Fleet in the Rancher UI</a>.</p><p><span class="emphasis"><em>Example <span class="strong"><strong>longhorn</strong></span> <code class="literal">GitRepo</code> resource for <span class="strong"><strong>manual</strong></span> deployment:</em></span></p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: fleet.cattle.io/v1alpha1
kind: GitRepo
metadata:
  name: longhorn-git-repo
  namespace: fleet-default
spec:
  # If using a tag
  # revision: &lt;user_repository_tag&gt;
  #
  # If using a branch
  # branch: &lt;user_repository_branch&gt;
  paths:
  # As seen in the 'Prepare your Fleet resources' example
  - longhorn
  repo: &lt;user_repository_url&gt;
  targets:
  # Match all clusters
  - clusterSelector: {}</pre></div></section><section class="sect4" id="id-managing-the-deployed-helm-chart" data-id-title="Managing the deployed Helm chart"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.5.3.1.3 </span><span class="title-name">Managing the deployed Helm chart</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-managing-the-deployed-helm-chart">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Once deployed with Fleet, for Helm chart upgrades, see <a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-fleet-managed-chart" title="25.5.3.2. I would like to upgrade a Fleet managed Helm chart">Section 25.5.3.2, “I would like to upgrade a Fleet managed Helm chart”</a>.</p></section></section><section class="sect3" id="day2-helm-upgrade-fleet-managed-chart" data-id-title="I would like to upgrade a Fleet managed Helm chart"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.3.2 </span><span class="title-name">I would like to upgrade a Fleet managed Helm chart</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-helm-upgrade-fleet-managed-chart">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Determine the version to which you need to upgrade your chart so that it is compatible with an Edge 3.X.Y release. Helm chart version per Edge release can be viewed from the <a class="xref" href="id-release-notes.html#release-notes" title="33.1. Abstract">Section 33.1, “Abstract”</a>.</p></li><li class="listitem"><p>In your Fleet monitored Git repository, edit the Helm chart’s <code class="literal">fleet.yaml</code> file with the correct chart <span class="strong"><strong>version</strong></span> and <span class="strong"><strong>repository</strong></span> from the <a class="xref" href="id-release-notes.html#release-notes" title="33.1. Abstract">Section 33.1, “Abstract”</a>.</p></li><li class="listitem"><p>After commiting and pushing the changes to your repository, this will trigger an upgrade of the desired Helm chart</p></li></ol></div></section><section class="sect3" id="day2-helm-upgrade-eib-chart" data-id-title="I would like to upgrade an EIB created Helm chart"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">25.5.3.3 </span><span class="title-name">I would like to upgrade an EIB created Helm chart</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.4.7.5.8.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This section assumes that you have deployed the system-upgrade-controller (SUC) beforehand, if you have not done so, or are unsure why you need it, see the default Day 2 components (<a class="xref" href="id-downstream-clusters.html#day2-downstream-components" title="25.1.1. Components">Section 25.1.1, “Components”</a>) list.</p></div><p>EIB deploys Helm charts by utilizing the auto-deploy manifests functionality of <a class="link" href="https://docs.rke2.io/advanced#auto-deploying-manifests" target="_blank">rke2</a>/<a class="link" href="https://docs.k3s.io/installation/packaged-components#auto-deploying-manifests-addons" target="_blank">k3s</a>. It creates a <a class="link" href="https://github.com/k3s-io/helm-controller#helm-controller" target="_blank">HelmChart</a> resource definition manifest unter the <code class="literal">/var/lib/rancher/&lt;rke2/k3s&gt;/server/manifests</code> location of the initialiser node and lets <code class="literal">rke2/k3s</code> pick it up and auto-deploy it in the cluster.</p><p>From a <code class="literal">Day 2</code> point of view this would mean that any upgrades of the Helm chart need to happen by editing the <code class="literal">HelmChart</code> manifest file of the specific chart. To automate this process for multiple clusters, this section uses <span class="strong"><strong>SUC Plans</strong></span>.</p><p>Below you can find information on:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The general overview (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-overview" title="25.5.3.3.1. Overview">Section 25.5.3.3.1, “Overview”</a>) of the helm chart upgrade workflow.</p></li><li class="listitem"><p>The necessary upgrade steps (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="25.5.3.3.2. Upgrade Steps">Section 25.5.3.3.2, “Upgrade Steps”</a>) needed for a successful helm chart upgrade.</p></li><li class="listitem"><p>An example (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-example" title="25.5.3.3.3. Example">Section 25.5.3.3.3, “Example”</a>) showcasing a <a class="link" href="https://longhorn.io" target="_blank">Longhorn</a> chart upgrade using the explained method.</p></li><li class="listitem"><p>How to use the upgrade process with a different GitOps tool (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-third-party" title="25.5.3.3.4. Helm chart upgrade using a third-party GitOps tool">Section 25.5.3.3.4, “Helm chart upgrade using a third-party GitOps tool”</a>).</p></li></ul></div><section class="sect4" id="day2-helm-upgrade-eib-chart-overview" data-id-title="Overview"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.5.3.3.1 </span><span class="title-name">Overview</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-overview">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section is meant to give a high overview of the workflow that the user goes through in order to upgrade one or multiple Helm charts. For a detailed explanation of the steps needed for a Helm chart upgrade, see <a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="25.5.3.3.2. Upgrade Steps">Section 25.5.3.3.2, “Upgrade Steps”</a>.</p><div class="figure" id="id-1.7.4.7.5.8.7.3"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_diagram.png"><img src="images/day2_helm_chart_upgrade_diagram.png" width="NaN" alt="day2 helm chart upgrade diagram" title="day2 helm chart upgrade diagram"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.6: </span><span class="title-name">Helm chart upgrade workflow </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.7.3">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>The workflow begins with the user <a class="link" href="https://helm.sh/docs/helm/helm_pull/" target="_blank">pulling</a> the new Helm chart archive(s) that he wishes to upgrade his chart(s) to.</p></li><li class="listitem"><p>The archive(s) should then be <span class="emphasis"><em>encoded</em></span> and passed as configuration to the <code class="literal">eib-chart-upgrade-user-data.yaml</code> file that is located under the fleet directory for the related SUC Plan. This is further explained in the upgrade steps (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="25.5.3.3.2. Upgrade Steps">Section 25.5.3.3.2, “Upgrade Steps”</a>) section.</p></li><li class="listitem"><p>The user then proceeds to configure and deploy a <code class="literal">GitRepo</code> resource that will ship all the needed resources (SUC Plan, secrets, etc.) to the downstream clusters.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>The resource is deployed on the <code class="literal">management cluster</code> under the <code class="literal">fleet-default</code> namespace.</p></li></ol></div></li><li class="listitem"><p>Fleet (<a class="xref" href="components-fleet.html" title="Chapter 6. Fleet">Chapter 6, <em>Fleet</em></a>) detects the deployed resource and deploys all the configured resources to the specified downstream clusters. Deployed resources include:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>The <code class="literal">eib-chart-upgrade</code> SUC Plan that will be used by SUC to create an <span class="strong"><strong>Upgrade Pod</strong></span> on each node.</p></li><li class="listitem"><p>The <code class="literal">eib-chart-upgrade-script</code> Secret that ships the <code class="literal">upgrade script</code> that the <span class="strong"><strong>Upgrade Pod</strong></span> will use to upgrade the <code class="literal">HelmChart</code> manifests on the initialiser node.</p></li><li class="listitem"><p>The <code class="literal">eib-chart-upgrade-user-data</code> Secret that ships the chart data that the <code class="literal">upgrade script</code> will use in order to understand which chart manifests it needs to upgrade.</p></li></ol></div></li><li class="listitem"><p>Once the <code class="literal">eib-chart-upgrade</code> SUC Plan has been deployed, the SUC picks it up and creates a Job which deploys the <span class="strong"><strong>Upgrade Pod</strong></span>.</p></li><li class="listitem"><p>Once deployed, the <span class="strong"><strong>Upgrade Pod</strong></span> mounts the <code class="literal">eib-chart-upgrade-script</code> and <code class="literal">eib-chart-upgrade-user-data</code> Secrets and executes the <code class="literal">upgrade script</code> that is shipped by the <code class="literal">eib-chart-upgrade-script</code> Secret.</p></li><li class="listitem"><p>The <code class="literal">upgrade script</code> does the following:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Determine whether the Pod that the script is running on has been deployed on the <code class="literal">initialiser</code> node. The <code class="literal">initialiser</code> node is the node that is hosting the <code class="literal">HelmChart</code> manifests. For a single-node cluster it is the single control-plane node. For HA clusters it is the node that you have marked as <code class="literal">initializer</code> when creating the cluster in EIB. If you have not specified the <code class="literal">initializer</code> property, then the first node from the <code class="literal">nodes</code> list is marked as <code class="literal">initializer</code>. For more information, see the <a class="link" href="https://github.com/suse-edge/edge-image-builder/blob/main/docs/building-images.md#kubernetes" target="_blank">upstream</a> documentation for EIB.</p><div id="id-1.7.4.7.5.8.7.4.7.2.1.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>If the <code class="literal">upgrade script</code> is running on a non-initialiser node, it immediately finishes its execution and does not go through the steps below.</p></div></li><li class="listitem"><p>Backup the manifests that will be edited in order to ensure disaster recover.</p><div id="id-1.7.4.7.5.8.7.4.7.2.2.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>By default backups of the manifests are stored under the <code class="literal">/tmp/eib-helm-chart-upgrade-&lt;date&gt;</code> directory. If you wish to use a custom location you can pass the <code class="literal">MANIFEST_BACKUP_DIR</code> enviroment variable to the Helm chart upgrade SUC Plan (example in the Plan).</p></div></li><li class="listitem"><p>Edit the <code class="literal">HelmChart</code> manifests. As of this version, the following properties are changed in order to trigger a chart upgrade:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>The content of the <code class="literal">chartContent</code> property is replaced with the encoded archive provided in the <code class="literal">eib-chart-upgrade-user-data</code> Secret.</p></li><li class="listitem"><p>The value of the <code class="literal">version</code> property is replaced with the version provided in the <code class="literal">eib-chart-upgrade-user-data</code> Secret.</p></li></ol></div></li></ol></div></li><li class="listitem"><p>After the successful execution of the <code class="literal">upgrade script</code>, the Helm integration for <a class="link" href="https://docs.rke2.io/helm" target="_blank">RKE2</a>/<a class="link" href="https://docs.k3s.io/helm" target="_blank">K3s</a> will pickup the change and automatically trigger an upgrade on the Helm chart.</p></li></ol></div></section><section class="sect4" id="day2-helm-upgrade-eib-chart-upgrade-steps" data-id-title="Upgrade Steps"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.5.3.3.2 </span><span class="title-name">Upgrade Steps</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Determine an Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">relase tag</a> from which you wish to copy the Helm chart upgrade logic.</p></li><li class="listitem"><p>Copy the <code class="literal">fleets/day2/system-upgrade-controller-plans/eib-chart-upgrade</code> fleet to the repository that your Fleet will be using to do GitOps from.</p></li><li class="listitem"><p><a class="link" href="https://helm.sh/docs/helm/helm_pull/" target="_blank">Pull</a> the Helm chart archive that you wish to upgrade to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm pull [chart URL | repo/chartname]

# Alternatively if you want to pull a specific version:
# helm pull [chart URL | repo/chartname] --version 0.0.0</pre></div></li><li class="listitem"><p>Encode the chart archive that you pulled:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Encode the archive and disable line wrapping
base64 -w 0 &lt;chart-archive&gt;.tgz</pre></div></li><li class="listitem"><p>Configure the <code class="literal">eib-chart-upgrade-user-data.yaml</code> secret located under the <code class="literal">eib-chart-upgrade</code> fleet that you copied from step (2):</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>The secret ships a file called <code class="literal">chart_upgrade_data.txt</code>. This file holds the chart upgrade data that the <code class="literal">upgrade script</code> will use to know which charts need to be upgraded. The file expects one-line per chart entries in the following format <span class="strong"><strong>"&lt;name&gt;|&lt;version&gt;|&lt;base64_encoded_archive&gt;"</strong></span>:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p><code class="literal">name</code> - is the name of the helm chart as seen in the <code class="literal">kubernetes.helm.charts.name[]</code> property of the EIB definition file.</p></li><li class="listitem"><p><code class="literal">version</code> - should hold the new version of the Helm chart. During the upgrade this value will be used to replace the old <code class="literal">version</code> value of the <code class="literal">HelmChart</code> manifest.</p></li><li class="listitem"><p><code class="literal">base64_encoded_archive</code> - pass the output of the <code class="literal">base64 -w 0 &lt;chart-archive&gt;.tgz</code> here. During upgrade this value will be used to replace the old <code class="literal">chartContent</code> value of the <code class="literal">HelmChart</code> manifest.</p><div id="id-1.7.4.7.5.8.8.2.5.2.1.2.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The <span class="strong"><strong>&lt;name&gt;|&lt;version&gt;|&lt;base64_encoded_archive&gt;</strong></span> line should be removed from the file before you start adding your data. It serves as an example of where and how you should configure your chart data.</p></div></li></ol></div></li></ol></div></li><li class="listitem"><p>Configure a <code class="literal">GitRepo</code> resource that will be shipping your chart upgrade <code class="literal">fleet</code>. For more information on what a <code class="literal">GitRepo</code> is, see <a class="link" href="https://fleet.rancher.io/ref-gitrepo" target="_blank">GitRepo Resource</a>.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Configure <code class="literal">GitRepo</code> through the Rancher UI:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>In the upper left corner, <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Git Repos → Add Repository</strong></span></p></li><li class="listitem"><p>Here pass your <span class="strong"><strong>repository data</strong></span> and <span class="strong"><strong>path</strong></span> to your chart <code class="literal">upgrade fleet</code></p></li><li class="listitem"><p>Select <span class="strong"><strong>Next</strong></span> and specify the <span class="strong"><strong>target</strong></span> clusters of which you want to upgrade the configured charts</p></li><li class="listitem"><p><span class="strong"><strong>Create</strong></span></p></li></ol></div></li><li class="listitem"><p>If <code class="literal">Rancher</code> is not available on your setup, you can configure a <code class="literal">GitRepo</code> manually on your <code class="literal">management cluster</code>:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>Populate the following template with your data:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: fleet.cattle.io/v1alpha1
kind: GitRepo
metadata:
  name: CHANGE_ME
  namespace: fleet-default
spec:
  # if running from a tag
  # revision: CHANGE_ME
  # if running from a branch
  # branch: CHANGE_ME
  paths:
  # path to your chart upgrade fleet relative to your repository
  - CHANGE_ME
  # your repository URL
  repo: CHANGE_ME
  targets:
  # Select target clusters
  - clusterSelector: CHANGE_ME
  # To match all clusters:
  # - clusterSelector: {}</pre></div><p>For more information on how to setup and deploy a <code class="literal">GitRepo</code> resource, see <a class="link" href="https://fleet.rancher.io/ref-gitrepo" target="_blank">GitRepo Resource</a> and <a class="link" href="https://fleet.rancher.io/gitrepo-add" target="_blank">Create a GitRepo Resource</a>.</p><p>For information on how to match <span class="strong"><strong>taget</strong></span> clusters on a more granular level, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p></li><li class="listitem"><p>Deploy the configured <code class="literal">GitRepo</code> resource to the <code class="literal">fleet-default</code> namespace of the <code class="literal">management cluster</code>.</p></li></ol></div></li></ol></div></li></ol></div><p>Executing this steps should result in a successfully created <code class="literal">GitRepo</code> resource. It will then be picked up by Fleet and a Bundle will be created. This Bunlde will hold the <span class="strong"><strong>raw</strong></span> Kubernetes resources that the <code class="literal">GitRepo</code> has configured under its fleet directory.</p><p>Fleet will then deploy all the Kubernetes resources from the Bundle to the specified downstream clusters. One of this resources will be a SUC Plan that will trigger the chart upgrade. For a full list of the resoruces that will be deployed and the workflow of the upgrade process, refer to the overview (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-overview" title="25.5.3.3.1. Overview">Section 25.5.3.3.1, “Overview”</a>) section.</p><p>To track the upgrade process itself, refer to the Monitor SUC Plans (<a class="xref" href="id-downstream-clusters.html#monitor-suc-plans" title="25.2.2.2. Monitor SUC Plans">Section 25.2.2.2, “Monitor SUC Plans”</a>) section.</p></section><section class="sect4" id="day2-helm-upgrade-eib-chart-example" data-id-title="Example"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.5.3.3.3 </span><span class="title-name">Example</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-example">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The following section serves to provide a real life example to the <a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="25.5.3.3.2. Upgrade Steps">Section 25.5.3.3.2, “Upgrade Steps”</a> section.</p><p>I have the following two EIB deployed clusters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">longhorn-single-k3s</code> - single node K3s cluster</p></li><li class="listitem"><p><code class="literal">longhorn-ha-rke2</code> - HA RKE2 cluster</p></li></ul></div><p>Both clusters are running <a class="link" href="https://longhorn.io" target="_blank">Longhorn</a> and have been deployed through EIB, using the following image definition <span class="emphasis"><em>snippet</em></span>:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kubernetes:
  # HA RKE2 cluster specific snippet
  # nodes:
  # - hostname: cp1rke2.example.com
  #   initializer: true
  #   type: server
  # - hostname: cp2rke2.example.com
  #   type: server
  # - hostname: cp3rke2.example.com
  #   type: server
  # - hostname: agent1rke2.example.com
  #   type: agent
  # - hostname: agent2rke2.example.com
  #   type: agent
  # version depending on the distribution
  version: v1.28.10+k3s1/v1.28.10+rke2r1
  helm:
    charts:
    - name: longhorn
      repositoryName: longhorn
      targetNamespace: longhorn-system
      createNamespace: true
      version: 1.5.5
    repositories:
    - name: longhorn
      url: https://charts.longhorn.io
...</pre></div><div class="figure" id="id-1.7.4.7.5.8.9.7"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_k3s_old.png"><img src="images/day2_helm_chart_upgrade_example_k3s_old.png" width="NaN" alt="day2 helm chart upgrade example k3s old" title="day2 helm chart upgrade example k3s old"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.7: </span><span class="title-name">longhorn-single-k3s installed Longhorn version </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.9.7">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><div class="figure" id="id-1.7.4.7.5.8.9.8"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_rke2_old.png"><img src="images/day2_helm_chart_upgrade_example_rke2_old.png" width="NaN" alt="day2 helm chart upgrade example rke2 old" title="day2 helm chart upgrade example rke2 old"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.8: </span><span class="title-name">longhorn-ha-rke2 installed Longhorn version </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.9.8">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>The problem with this is that currently <code class="literal">longhorn-single-k3s</code> and <code class="literal">longhorn-ha-rke2</code> are running with a Longhorn version that is not compatible with any Edge release.</p><p>We need to upgrade the chart on both clusters to a Edge supported Longhorn version.</p><p>To do this we follow these steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Determine the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">relase tag</a> from which we want to take the upgrade logic. For example, this example will use the <code class="literal">release-3.0.1</code> release tag for which the supported Longhorn version is <code class="literal">1.6.1</code>.</p></li><li class="listitem"><p>Clone the <code class="literal">release-3.0.1</code> release tag and copy the <code class="literal">fleets/day2/system-upgrade-controller-plans/eib-chart-upgrade</code> directory to our own repository.</p><p>For simplicity this section works from a branch of the <code class="literal">suse-edge/fleet-examples</code> repository, so the directory structure is the same, but you can place the <code class="literal">eib-chart-upgrade</code> fleet anywhere in your repository.</p><p><span class="formalpara-title">Directory structure example. </span>
</p><div class="verbatim-wrap highlight bash"><pre class="screen">.
...
|-- fleets
|   `-- day2
|       `-- system-upgrade-controller-plans
|           `-- eib-chart-upgrade
|               |-- eib-chart-upgrade-script.yaml
|               |-- eib-chart-upgrade-user-data.yaml
|               |-- fleet.yaml
|               `-- plan.yaml
...</pre></div><p>
</p></li><li class="listitem"><p>Add the Longhorn chart repository:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm repo add longhorn https://charts.longhorn.io</pre></div></li><li class="listitem"><p>Pull the Longhorn chart version <code class="literal">1.6.1</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm pull longhorn/longhorn --version 1.6.1</pre></div><p>This will pull the longhorn as an archvie named <code class="literal">longhorn-1.6.1.tgz</code>.</p></li><li class="listitem"><p>Encode the Longhorn archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">base64 -w 0 longhorn-1.6.1.tgz</pre></div><p>This will output a long one-line base64 encoded string of the archive.</p></li><li class="listitem"><p>Now we have all the needed data to configure the <code class="literal">eib-chart-upgrade-user-data.yaml</code> file. The file configuration should look like this:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: v1
kind: Secret
metadata:
  name: eib-chart-upgrade-user-data
type: Opaque
stringData:
  # &lt;name&gt;|&lt;version&gt;|&lt;base64_encoded_archive&gt;
  chart_upgrade_data.txt: |
    longhorn|1.6.1|H4sIFAAAAAAA/ykAK2FIUjBjSE02THk5NWIzV...</pre></div><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><code class="literal">longhorn</code> is the name of the chart as seen in my EIB definition file</p></li><li class="listitem"><p><code class="literal">1.6.1</code> is the version to which I want to upgrade the <code class="literal">version</code> property of the Longhorn <code class="literal">HelmChart</code> manifest</p></li><li class="listitem"><p><code class="literal">H4sIFAAAAAAA/ykAK2FIUjBjSE02THk5NWIzV…​</code> is a snippet of the encoded Longhorn <code class="literal">1.6.1</code> archive. <span class="strong"><strong>A snippet has been added here for better readibility. You should always provide the full base64 encoded archive string here.</strong></span></p><div id="id-1.7.4.7.5.8.9.12.6.3.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This example shows configuration for a single chart upgrade, but if your use-case requires to upgrade multiple charts on multiple clusters, you can append the additional chart data as seen below:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: v1
kind: Secret
metadata:
  name: eib-chart-upgrade-user-data
type: Opaque
stringData:
  # &lt;name&gt;|&lt;version&gt;|&lt;base64_encoded_archive&gt;
  chart_upgrade_data.txt: |
    chartA|0.0.0|&lt;chartA_base64_archive&gt;
    chartB|0.0.0|&lt;chartB_base64_archive&gt;
    chartC|0.0.0|&lt;chartC_base64_archive&gt;
    ...</pre></div></div></li></ol></div></li><li class="listitem"><p>We also decided that we do not want to keep manifest backups at <code class="literal">/tmp</code>, so the following configuration was added to the <code class="literal">plan.yaml</code> file:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: eib-chart-upgrade
spec:
  ...
  upgrade:
    ...
    # For when you want to backup your chart
    # manifest data under a specific directory
    #
    envs:
    - name: MANIFEST_BACKUP_DIR
      value: "/root"</pre></div><p>This will ensure that manifest backups will be saved under the <code class="literal">/root</code> directory instead of <code class="literal">/tmp</code>.</p></li><li class="listitem"><p>Now that we have made all the needed configurations, what is left is to create the <code class="literal">GitRepo</code> resource. This example creates the <code class="literal">GitRepo</code> resource through the <code class="literal">Rancher UI</code>.</p></li><li class="listitem"><p>Following the steps described in the Upgrade Steps (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="25.5.3.3.2. Upgrade Steps">Section 25.5.3.3.2, “Upgrade Steps”</a>), we:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Named the <code class="literal">GitRepo</code> "longhorn-upgrade".</p></li><li class="listitem"><p>Passed the URL to the repository that will be used - <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">https://github.com/suse-edge/fleet-examples.git</a></p></li><li class="listitem"><p>Passed the branch of the repository - "doc-example"</p></li><li class="listitem"><p>Passed the path to the <code class="literal">eib-chart-upgrade</code> fleet as seen in the repo - <code class="literal">fleets/day2/system-upgrade-controller-plans/eib-chart-upgrade</code></p></li><li class="listitem"><p>Selected the target clusters and created the resource</p><div class="figure" id="id-1.7.4.7.5.8.9.12.9.2.5.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_gitrepo.png"><img src="images/day2_helm_chart_upgrade_example_gitrepo.png" width="NaN" alt="day2 helm chart upgrade example gitrepo" title="day2 helm chart upgrade example gitrepo"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.9: </span><span class="title-name">Successfully deployed SUC and longhorn GitRepos </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.9.12.9.2.5.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li></ol></div></li></ol></div><p>Now we need to monitor the upgrade procedures on the clusters:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Check the status of the <span class="strong"><strong>Upgrade Pods</strong></span>, following the directions from the SUC plan monitor (<a class="xref" href="id-downstream-clusters.html#monitor-suc-plans" title="25.2.2.2. Monitor SUC Plans">Section 25.2.2.2, “Monitor SUC Plans”</a>) section.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>A successfully completed <span class="strong"><strong>Upgrade Pod</strong></span> that has been working on an <code class="literal">intialiser</code> node should hold logs similar to:</p><div class="figure" id="id-1.7.4.7.5.8.9.14.1.2.1.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_initialiser_logs.png"><img src="images/day2_helm_chart_upgrade_example_initialiser_logs.png" width="NaN" alt="day2 helm chart upgrade example initialiser logs" title="day2 helm chart upgrade example initialiser logs"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.10: </span><span class="title-name">Upgrade Pod running on an initialiser node </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.9.14.1.2.1.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li><li class="listitem"><p>A successfully completed <span class="strong"><strong>Upgrade Pod</strong></span> that has been working on a <code class="literal">non-initialiser</code> node should hold logs similar to:</p><div class="figure" id="id-1.7.4.7.5.8.9.14.1.2.2.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_non_initialiser_logs.png"><img src="images/day2_helm_chart_upgrade_example_non_initialiser_logs.png" width="NaN" alt="day2 helm chart upgrade example non initialiser logs" title="day2 helm chart upgrade example non initialiser logs"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.11: </span><span class="title-name">Upgrade Pod running on a non-initialiser node </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.9.14.1.2.2.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li></ol></div></li><li class="listitem"><p>After a successful <span class="strong"><strong>Upgrade Pod</strong></span> completion, we would also need to wait and monitor for the pods that wil lbe created by the helm controller. These pods will do the actual upgrade based on the file chagnes that the <span class="strong"><strong>Upgrade Pod</strong></span> has done to the <code class="literal">HelmChart</code> manifest file.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>In your cluster, go to <span class="strong"><strong>Workloads → Pods</strong></span> and search for a pod that contains the <code class="literal">longhorn</code> string in the <code class="literal">default</code> namespace. This should produce a pod with the naming template <code class="literal">helm-install-longhorn-*</code>, view the logs of this pod.</p><div class="figure" id="id-1.7.4.7.5.8.9.14.2.2.1.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_helm_install.png"><img src="images/day2_helm_chart_upgrade_example_helm_install.png" width="NaN" alt="day2 helm chart upgrade example helm install" title="day2 helm chart upgrade example helm install"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.12: </span><span class="title-name">Successfully completed helm-install pod </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.9.14.2.2.1.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li><li class="listitem"><p>The logs should be similar to:</p><div class="figure" id="id-1.7.4.7.5.8.9.14.2.2.2.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_successfully_upgraded_pod.png"><img src="images/day2_helm_chart_upgrade_example_successfully_upgraded_pod.png" width="NaN" alt="day2 helm chart upgrade example successfully upgraded pod" title="day2 helm chart upgrade example successfully upgraded pod"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.13: </span><span class="title-name">Successfully completed helm-install pod logs </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.9.14.2.2.2.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li></ol></div></li></ol></div><p>Now that we have ensured that everything has completed succesfully, we need to verify the version change:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>On the clusters we need to go to <span class="strong"><strong>More Resources → Helm → HelmCharts</strong></span> and in the <code class="literal">default</code> namespace search for the <code class="literal">longhorn</code> HelmChart resource:</p><div class="figure" id="id-1.7.4.7.5.8.9.16.1.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_k3s_longhorn_upgrade.png"><img src="images/day2_helm_chart_upgrade_example_k3s_longhorn_upgrade.png" width="NaN" alt="day2 helm chart upgrade example k3s longhorn upgrade" title="day2 helm chart upgrade example k3s longhorn upgrade"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.14: </span><span class="title-name">longhorn-single-k3s upgraded Longhorn version </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.9.16.1.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><div class="figure" id="id-1.7.4.7.5.8.9.16.1.3"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_rke2_longhorn_upgrade.png"><img src="images/day2_helm_chart_upgrade_example_rke2_longhorn_upgrade.png" width="NaN" alt="day2 helm chart upgrade example rke2 longhorn upgrade" title="day2 helm chart upgrade example rke2 longhorn upgrade"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 25.15: </span><span class="title-name">longhorn-ha-rke2 upgraded Longhorn version </span></span><a title="Permalink" class="permalink" href="id-downstream-clusters.html#id-1.7.4.7.5.8.9.16.1.3">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li></ol></div><p>This ensures that the <code class="literal">Longhorn</code> helm chart has been successfully upgraded and concludes this example.</p><p>If for some reason we would like to revert to the previous chart version of Longhorn, the previous Longhorn  manifest will be located under <code class="literal">/root/longhorn.yaml</code> on the initialiser node. This is true, because we have specified the <code class="literal">MANIFEST_BACKUP_DIR</code> in the SUC Plan.</p></section><section class="sect4" id="day2-helm-upgrade-eib-chart-third-party" data-id-title="Helm chart upgrade using a third-party GitOps tool"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">25.5.3.3.4 </span><span class="title-name">Helm chart upgrade using a third-party GitOps tool</span></span> <a title="Permalink" class="permalink" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-third-party">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>There might be use-cases where users would like to use this upgrade procedure with a GitOps workflow other than Fleet (e.g. <code class="literal">Flux</code>).</p><p>To get the resources related to EIB deployed Helm chart upgrades you need to first determine the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag of the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository that you would like to use.</p><p>After that, resources can be found at <code class="literal">fleets/day2/system-upgrade-controller-plans/eib-chart-upgrade</code>, where:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">plan.yaml</code> - system-upgrade-controller Plan related to the upgrade procedure.</p></li><li class="listitem"><p><code class="literal">eib-chart-upgrade-script.yaml</code> - Secret holding the <code class="literal">upgrade script</code> that is responsible for editing and upgrade the <code class="literal">HelmChart</code> manifest files.</p></li><li class="listitem"><p><code class="literal">eib-chart-upgrade-user-data.yaml</code> - Secret holding a file that is utilised by the <code class="literal">upgrade scritp</code>; populated by the user with relevat chart upgrade data beforehand.</p></li></ul></div><div id="id-1.7.4.7.5.8.10.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>These <code class="literal">Plan</code> resources are interpreted by the <code class="literal">system-upgrade-controller</code> and should be deployed on each downstream cluster that holds charts in need of an upgrade. For information on how to deploy the <code class="literal">system-upgrade-controller</code>, see <a class="xref" href="id-downstream-clusters.html#day2-suc-third-party-gitops" title="25.2.1.3. Deploying system-upgrade-controller when using a third-party GitOps workflow">Section 25.2.1.3, “Deploying system-upgrade-controller when using a third-party GitOps workflow”</a>.</p></div><p>To better understand how your GitOps workflow can be used to deploy the <span class="strong"><strong>SUC Plans</strong></span> for the upgrade process, it can be beneficial to take a look at the overview (<a class="xref" href="id-downstream-clusters.html#day2-helm-upgrade-eib-chart-overview" title="25.5.3.3.1. Overview">Section 25.5.3.3.1, “Overview”</a>) of the process using <code class="literal">Fleet</code>.</p></section></section></section></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="day2-mgmt-cluster.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Chapter 24 </span>Management Cluster</span></a> </div><div><a class="pagination-link next" href="id-product-documentation.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Part VI </span>Product Documentation</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="section"><a href="id-downstream-clusters.html#id-introduction"><span class="title-number">25.1 </span><span class="title-name">Introduction</span></a></span></li><li><span class="section"><a href="id-downstream-clusters.html#day2-suc-deployment-guide"><span class="title-number">25.2 </span><span class="title-name">System upgrade controller deployment guide</span></a></span></li><li><span class="section"><a href="id-downstream-clusters.html#day2-os-upgrade"><span class="title-number">25.3 </span><span class="title-name">OS upgrade</span></a></span></li><li><span class="section"><a href="id-downstream-clusters.html#day2-k8s-upgrade"><span class="title-number">25.4 </span><span class="title-name">Kubernetes version upgrade</span></a></span></li><li><span class="section"><a href="id-downstream-clusters.html#day2-helm-upgrade"><span class="title-number">25.5 </span><span class="title-name">Helm chart upgrade</span></a></span></li></ul></div><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter/X"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2024</span></div></div></footer></body></html>