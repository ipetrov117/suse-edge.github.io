<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>SUSE Edge Documentation | Downstream clusters</title><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"/>
<meta name="title" content="Downstream clusters"/>
<meta name="description" content="This section covers how to do various Day 2 operations for different parts of your downstream cluster using your management cluster."/>
<meta name="book-title" content="SUSE Edge Documentation"/>
<meta name="chapter-title" content="Chapter 30. Downstream clusters"/>
<meta name="tracker-url" content="https://github.com/suse-edge/suse-edge.github.io/issues/new"/>
<meta name="tracker-type" content="gh"/>
<meta name="publisher" content="SUSE"/><meta property="og:title" content="Downstream clusters"/>
<meta property="og:description" content="This section covers how to do various Day 2 operations for …"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Downstream clusters"/>
<meta name="twitter:description" content="This section covers how to do various Day 2 operations for …"/>
<script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": ["TechArticle"],
    "image": "https://www.suse.com/assets/img/suse-white-logo-green.svg",
    
     "isPartOf": {
      "@type": "CreativeWorkSeries",
      "name": "Products &amp; Solutions"
    },
    

    "headline": "Downstream clusters",
  
    "description": "Downstream clusters",
      
    "author": [
      {
        "@type": "Corporation",
        "name": "SUSE Product &amp; Solution Documentation Team",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    ],
      

    "about": [
      
    ],
  
    "sameAs": [
          "https://www.facebook.com/SUSEWorldwide/about",
          "https://www.youtube.com/channel/UCHTfqIzPKz4f_dri36lAQGA",
          "https://twitter.com/SUSE",
          "https://www.linkedin.com/company/suse"
    ],
    "publisher": {
      "@type": "Corporation",
      "name": "SUSE",
      "url": "https://documentation.suse.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    }
  }</script>
<link rel="prev" href="day2-mgmt-cluster.html" title="Chapter 29. Management Cluster"/><link rel="next" href="id-product-documentation.html" title="Part VI. Product Documentation"/><script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/script-purejs.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="wide offline js-off"><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">SUSE Edge Documentation</a><span> / </span><a class="crumb" href="day-2-operations.html">Day 2 Operations</a><span> / </span><a class="crumb" href="day2-downstream-clusters.html">Downstream clusters</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title">SUSE Edge Documentation</div><ol><li><a href="id-suse-edge-3-2-0-documentation.html" class=" "><span class="title-number"> </span><span class="title-name">SUSE Edge 3.2.0 Documentation</span></a></li><li><a href="id-quick-starts.html" class="has-children "><span class="title-number">I </span><span class="title-name">Quick Starts</span></a><ol><li><a href="quickstart-metal3.html" class=" "><span class="title-number">1 </span><span class="title-name">BMC automated deployments with Metal<sup>3</sup></span></a></li><li><a href="quickstart-elemental.html" class=" "><span class="title-number">2 </span><span class="title-name">Remote host onboarding with Elemental</span></a></li><li><a href="quickstart-eib.html" class=" "><span class="title-number">3 </span><span class="title-name">Standalone clusters with Edge Image Builder</span></a></li></ol></li><li><a href="id-components.html" class="has-children "><span class="title-number">II </span><span class="title-name">Components</span></a><ol><li><a href="components-rancher.html" class=" "><span class="title-number">4 </span><span class="title-name">Rancher</span></a></li><li><a href="components-rancher-dashboard-extensions.html" class=" "><span class="title-number">5 </span><span class="title-name">Rancher Dashboard Extensions</span></a></li><li><a href="components-rancher-turtles.html" class=" "><span class="title-number">6 </span><span class="title-name">Rancher Turtles</span></a></li><li><a href="components-fleet.html" class=" "><span class="title-number">7 </span><span class="title-name">Fleet</span></a></li><li><a href="components-slmicro.html" class=" "><span class="title-number">8 </span><span class="title-name">SLE Micro</span></a></li><li><a href="components-metal3.html" class=" "><span class="title-number">9 </span><span class="title-name">Metal<sup>3</sup></span></a></li><li><a href="components-eib.html" class=" "><span class="title-number">10 </span><span class="title-name">Edge Image Builder</span></a></li><li><a href="components-nmc.html" class=" "><span class="title-number">11 </span><span class="title-name">Edge Networking</span></a></li><li><a href="components-elemental.html" class=" "><span class="title-number">12 </span><span class="title-name">Elemental</span></a></li><li><a href="components-akri.html" class=" "><span class="title-number">13 </span><span class="title-name">Akri</span></a></li><li><a href="components-k3s.html" class=" "><span class="title-number">14 </span><span class="title-name">K3s</span></a></li><li><a href="components-rke2.html" class=" "><span class="title-number">15 </span><span class="title-name">RKE2</span></a></li><li><a href="components-longhorn.html" class=" "><span class="title-number">16 </span><span class="title-name">Longhorn</span></a></li><li><a href="components-neuvector.html" class=" "><span class="title-number">17 </span><span class="title-name">NeuVector</span></a></li><li><a href="components-metallb.html" class=" "><span class="title-number">18 </span><span class="title-name">MetalLB</span></a></li><li><a href="components-kubevirt.html" class=" "><span class="title-number">19 </span><span class="title-name">Edge Virtualization</span></a></li><li><a href="components-system-upgrade-controller.html" class=" "><span class="title-number">20 </span><span class="title-name">System Upgrade Controller</span></a></li><li><a href="components-upgrade-controller.html" class=" "><span class="title-number">21 </span><span class="title-name">Upgrade Controller</span></a></li></ol></li><li><a href="id-how-to-guides.html" class="has-children "><span class="title-number">III </span><span class="title-name">How-To Guides</span></a><ol><li><a href="guides-metallb-k3s.html" class=" "><span class="title-number">22 </span><span class="title-name">MetalLB on K3s (using L2)</span></a></li><li><a href="guides-metallb-kubernetes.html" class=" "><span class="title-number">23 </span><span class="title-name">MetalLB in front of the Kubernetes API server</span></a></li><li><a href="id-air-gapped-deployments-with-edge-image-builder.html" class=" "><span class="title-number">24 </span><span class="title-name">Air-gapped deployments with Edge Image Builder</span></a></li><li><a href="guides-kiwi-builder-images.html" class=" "><span class="title-number">25 </span><span class="title-name">Building Updated SUSE Linux Micro Images with Kiwi</span></a></li></ol></li><li><a href="id-third-party-integration.html" class="has-children "><span class="title-number">IV </span><span class="title-name">Third-Party Integration</span></a><ol><li><a href="integrations-nats.html" class=" "><span class="title-number">26 </span><span class="title-name">NATS</span></a></li><li><a href="id-nvidia-gpus-on-sle-micro.html" class=" "><span class="title-number">27 </span><span class="title-name">NVIDIA GPUs on SLE Micro</span></a></li></ol></li><li class="active"><a href="day-2-operations.html" class="has-children you-are-here"><span class="title-number">V </span><span class="title-name">Day 2 Operations</span></a><ol><li><a href="day2-migration.html" class=" "><span class="title-number">28 </span><span class="title-name">Edge 3.1 migration</span></a></li><li><a href="day2-mgmt-cluster.html" class=" "><span class="title-number">29 </span><span class="title-name">Management Cluster</span></a></li><li><a href="day2-downstream-clusters.html" class=" you-are-here"><span class="title-number">30 </span><span class="title-name">Downstream clusters</span></a></li></ol></li><li><a href="id-product-documentation.html" class="has-children "><span class="title-number">VI </span><span class="title-name">Product Documentation</span></a><ol><li><a href="atip.html" class=" "><span class="title-number">31 </span><span class="title-name">SUSE Adaptive Telco Infrastructure Platform (ATIP)</span></a></li><li><a href="atip-architecture.html" class=" "><span class="title-number">32 </span><span class="title-name">Concept &amp; Architecture</span></a></li><li><a href="atip-requirements.html" class=" "><span class="title-number">33 </span><span class="title-name">Requirements &amp; Assumptions</span></a></li><li><a href="atip-management-cluster.html" class=" "><span class="title-number">34 </span><span class="title-name">Setting up the management cluster</span></a></li><li><a href="atip-features.html" class=" "><span class="title-number">35 </span><span class="title-name">Telco features configuration</span></a></li><li><a href="atip-automated-provisioning.html" class=" "><span class="title-number">36 </span><span class="title-name">Fully automated directed network provisioning</span></a></li><li><a href="atip-lifecycle.html" class=" "><span class="title-number">37 </span><span class="title-name">Lifecycle actions</span></a></li></ol></li><li><a href="id-appendix.html" class="has-children "><span class="title-number">VII </span><span class="title-name">Appendix</span></a><ol><li><a href="id-release-notes.html" class=" "><span class="title-number">38 </span><span class="title-name">Release Notes</span></a></li></ol></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="day2-downstream-clusters" data-id-title="Downstream clusters"><div class="titlepage"><div><div><div class="title-container"><h1 class="title"><span class="title-number-name"><span class="title-number">30 </span><span class="title-name">Downstream clusters</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#">#</a></h1><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers how to do various <code class="literal">Day 2</code> operations for different parts of your downstream cluster using your <code class="literal">management cluster</code>.</p><section class="sect1" id="id-introduction" data-id-title="Introduction"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">30.1 </span><span class="title-name">Introduction</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-introduction">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section is meant to be a <span class="strong"><strong>starting point</strong></span> for the <code class="literal">Day 2</code> operations documentation. You can find the following information.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>The default components (<a class="xref" href="day2-downstream-clusters.html#day2-downstream-components" title="30.1.1. Components">Section 30.1.1, “Components”</a>) used to achieve <code class="literal">Day 2</code> operations over multiple downstream clusters.</p></li><li class="listitem"><p>Determining which <code class="literal">Day 2</code> resources should you use for your specific use-case (<a class="xref" href="day2-downstream-clusters.html#day2-determine-use-case" title="30.1.2. Determine your use-case">Section 30.1.2, “Determine your use-case”</a>).</p></li><li class="listitem"><p>The suggested workflow sequence (<a class="xref" href="day2-downstream-clusters.html#day2-upgrade-workflow" title="30.1.3. Day 2 workflow">Section 30.1.3, “Day 2 workflow”</a>) for <code class="literal">Day 2</code> operations.</p></li></ol></div><section class="sect2" id="day2-downstream-components" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.1.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-downstream-components">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Below you can find a description of the default components that should be set up on either your <code class="literal">management cluster</code> or your <code class="literal">downstream clusters</code> so that you can successfully perform <code class="literal">Day 2</code> operations.</p><section class="sect3" id="id-rancher" data-id-title="Rancher"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.1.1.1 </span><span class="title-name">Rancher</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-rancher">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.5.3.4.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>For use-cases where you want to utilize Fleet (<a class="xref" href="components-fleet.html" title="Chapter 7. Fleet">Chapter 7, <em>Fleet</em></a>) without Rancher, you can skip the Rancher component altogether.</p></div><p>Responsible for the management of your <code class="literal">downstream clusters</code>. Should be deployed on your <code class="literal">management cluster</code>.</p><p>For more information, see <a class="xref" href="components-rancher.html" title="Chapter 4. Rancher">Chapter 4, <em>Rancher</em></a>.</p></section><section class="sect3" id="id-fleet" data-id-title="Fleet"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.1.1.2 </span><span class="title-name">Fleet</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-fleet">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Responsible for multi-cluster resource deployment.</p><p>Typically offered by the <code class="literal">Rancher</code> component. For use-cases where <code class="literal">Rancher</code> is not used, can be deployed as a standalone component.</p><p>For more information on installing Fleet as a standalone component, see Fleet’s <a class="link" href="https://fleet.rancher.io/installation" target="_blank">Installation Details</a>.</p><p>For more information regarding the Fleet component, see <a class="xref" href="components-fleet.html" title="Chapter 7. Fleet">Chapter 7, <em>Fleet</em></a>.</p><div id="id-1.7.5.3.4.4.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>This documentation heavily relies on <code class="literal">Fleet</code> and more specifically on the <code class="literal">GitRepo</code> and <code class="literal">Bundle</code> resources (more on this in <a class="xref" href="day2-downstream-clusters.html#day2-determine-use-case" title="30.1.2. Determine your use-case">Section 30.1.2, “Determine your use-case”</a>) for establishing a GitOps way of automating the deployment of resources related to <code class="literal">Day 2</code> operations.</p><p>For use-cases, where a third party GitOps tool usage is desired, see:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>For <code class="literal">OS upgrades</code> - <a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-third-party" title="30.2.4.3. SUC Plan deployment - third-party GitOps workflow">Section 30.2.4.3, “SUC Plan deployment - third-party GitOps workflow”</a></p></li><li class="listitem"><p>For <code class="literal">Kubernetes distribution upgrades</code> - <a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-third-party" title="30.3.4.3. SUC Plan deployment - third-party GitOps workflow">Section 30.3.4.3, “SUC Plan deployment - third-party GitOps workflow”</a></p></li><li class="listitem"><p>For <code class="literal">EIB deployed Helm chart upgrades</code> - <a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-third-party" title="30.4.3.3.4. Helm chart upgrade using a third-party GitOps tool">Section 30.4.3.3.4, “Helm chart upgrade using a third-party GitOps tool”</a></p></li><li class="listitem"><p>For <code class="literal">non-EIB deployed Helm chart upgrades</code> - retrieve the chart version supported by the desired Edge release from the <a class="xref" href="id-release-notes.html#release-notes" title="38.1. Abstract">Section 38.1, “Abstract”</a> page and populate the chart version and URL in your third party GitOps tool</p></li></ol></div></div></section><section class="sect3" id="id-system-upgrade-controller-suc" data-id-title="System Upgrade Controller (SUC)"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.1.1.3 </span><span class="title-name">System Upgrade Controller (SUC)</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-system-upgrade-controller-suc">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="strong"><strong>System Upgrade Controller (SUC)</strong></span> is responsible for executing tasks on specified nodes based on configuration data provided through a custom resource, called a <code class="literal">Plan</code>.</p><div id="id-1.7.5.3.4.5.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>In order for <span class="strong"><strong>SUC</strong></span> to be able to support different <span class="strong"><strong>Day 2</strong></span> operations, it is important that it is deployed on each <span class="strong"><strong>downstream</strong></span> cluster that requires an upgrade.</p></div><p>For more information about the <span class="strong"><strong>SUC</strong></span> component and how it fits in the Edge stack, see the System Upgrade Controller (<a class="xref" href="components-system-upgrade-controller.html" title="Chapter 20. System Upgrade Controller">Chapter 20, <em>System Upgrade Controller</em></a>) component documentation.</p><p>For information on how to deploy <span class="strong"><strong>SUC</strong></span> on your downstream clusters, first determine your use-case (<a class="xref" href="day2-downstream-clusters.html#day2-determine-use-case" title="30.1.2. Determine your use-case">Section 30.1.2, “Determine your use-case”</a>) and then refer to System Upgrade Controller installation - GitRepo (<a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-fleet-gitrepo" title="20.2.1.1. System Upgrade Controller installation - GitRepo">Section 20.2.1.1, “System Upgrade Controller installation - GitRepo”</a>), or System Upgrade Controller installation - Bundle (<a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-fleet-bundle" title="20.2.1.2. System Upgrade Controller installation - Bundle">Section 20.2.1.2, “System Upgrade Controller installation - Bundle”</a>).</p></section></section><section class="sect2" id="day2-determine-use-case" data-id-title="Determine your use-case"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.1.2 </span><span class="title-name">Determine your use-case</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-determine-use-case">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>As mentioned previously, resources related to <code class="literal">Day 2</code> operations are propagated to downstream clusters using Fleet’s <code class="literal">GitRepo</code> and <code class="literal">Bundle</code> resources.</p><p>Below you can find more information regarding what these resources do and for which use-cases should they be used for <code class="literal">Day 2</code> operations.</p><section class="sect3" id="id-gitrepo" data-id-title="GitRepo"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.1.2.1 </span><span class="title-name">GitRepo</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-gitrepo">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <code class="literal">GitRepo</code> is a Fleet (<a class="xref" href="components-fleet.html" title="Chapter 7. Fleet">Chapter 7, <em>Fleet</em></a>) resource that represents a Git repository from which <code class="literal">Fleet</code> can create <code class="literal">Bundles</code>. Each <code class="literal">Bundle</code> is created based on configuration paths defined inside of the <code class="literal">GitRepo</code> resource. For more information, see the <a class="link" href="https://fleet.rancher.io/gitrepo-add" target="_blank">GitRepo</a> documentation.</p><p>In terms of <code class="literal">Day 2</code> operations, <code class="literal">GitRepo</code> resources are normally used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> on <span class="strong"><strong>non air-gapped</strong></span> environments that utilize a <span class="emphasis"><em>Fleet GitOps</em></span> approach.</p><p>Alternatively, <code class="literal">GitRepo</code> resources can also be used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> on <span class="strong"><strong>air-gapped</strong></span> environments, <span class="strong"><strong>if you mirror your repository setup through a local git server</strong></span>.</p></section><section class="sect3" id="id-bundle" data-id-title="Bundle"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.1.2.2 </span><span class="title-name">Bundle</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-bundle">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><code class="literal">Bundles</code> hold <span class="strong"><strong>raw</strong></span> Kubernetes resources that will be deployed on the targeted cluster. Usually they are created from a <code class="literal">GitRepo</code> resource, but there are use-cases where they can be deployed manually. For more information refer to the <a class="link" href="https://fleet.rancher.io/bundle-add" target="_blank">Bundle</a> documentation.</p><p>In terms of <code class="literal">Day 2</code> operations, <code class="literal">Bundle</code> resources are normally used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> on <span class="strong"><strong>air-gapped</strong></span> environments that do not use some form of <span class="emphasis"><em>local GitOps</em></span> procedure (e.g. a <span class="strong"><strong>local git server</strong></span>).</p><p>Alternatively, if your use-case does not allow for a <span class="emphasis"><em>GitOps</em></span> workflow (e.g. using a Git repository), <span class="strong"><strong>Bundle</strong></span> resources could also be used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> on <span class="strong"><strong>non air-gapped</strong></span> environments.</p></section></section><section class="sect2" id="day2-upgrade-workflow" data-id-title="Day 2 workflow"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.1.3 </span><span class="title-name">Day 2 workflow</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-upgrade-workflow">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The following is a <code class="literal">Day 2</code> workflow that should be followed when upgrading a downstream cluster to a specific Edge release.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>OS upgrade (<a class="xref" href="day2-downstream-clusters.html#day2-os-upgrade" title="30.2. OS upgrade">Section 30.2, “OS upgrade”</a>)</p></li><li class="listitem"><p>Kubernetes version upgrade (<a class="xref" href="day2-downstream-clusters.html#day2-k8s-upgrade" title="30.3. Kubernetes version upgrade">Section 30.3, “Kubernetes version upgrade”</a>)</p></li><li class="listitem"><p>Helm chart upgrade (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade" title="30.4. Helm chart upgrade">Section 30.4, “Helm chart upgrade”</a>)</p></li></ol></div></section></section><section class="sect1" id="day2-os-upgrade" data-id-title="OS upgrade"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">30.2 </span><span class="title-name">OS upgrade</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-os-upgrade">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><section class="sect2" id="id-components-2" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.2.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-components-2">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers the custom components that the <code class="literal">OS upgrade</code> process uses over the default <code class="literal">Day 2</code> components (<a class="xref" href="day2-downstream-clusters.html#day2-downstream-components" title="30.1.1. Components">Section 30.1.1, “Components”</a>).</p><section class="sect3" id="id-systemd-service" data-id-title="systemd.service"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.2.1.1 </span><span class="title-name">systemd.service</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-systemd-service">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A different <a class="link" href="https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html" target="_blank">systemd.service</a> is created depending on what upgrade your OS requires from one Edge version to another:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For Edge versions that require the same OS version (e.g. <code class="literal">6.0</code>), the <code class="literal">os-pkg-update.service</code> will be created. It uses the <a class="link" href="https://kubic.opensuse.org/documentation/man-pages/transactional-update.8.html" target="_blank">transactional-update</a> command to perform a <a class="link" href="https://en.opensuse.org/SDB:Zypper_usage#Updating_packages" target="_blank">normal package upgrade</a>.</p></li><li class="listitem"><p>For Edge versions that require a OS version migration (e.g <code class="literal">5.5</code> → <code class="literal">6.0</code>), the <code class="literal">os-migration.service</code> will be created. It uses <a class="link" href="https://kubic.opensuse.org/documentation/man-pages/transactional-update.8.html" target="_blank">transactional-update</a> to perform:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>First a <a class="link" href="https://en.opensuse.org/SDB:Zypper_usage#Updating_packages" target="_blank">normal package upgrade</a>. Done in order to ensure that all packages are with the latest version before the migration. Mitigating any failures related to old package version.</p></li><li class="listitem"><p>After that it proceeds with the OS migration process by utilizing the <code class="literal">zypper migration</code> command.</p></li></ul></div></li></ul></div><p>Shipped through a <span class="strong"><strong>SUC plan</strong></span>, which should be located on each <span class="strong"><strong>downstream cluster</strong></span> that is in need of an OS upgrade.</p></section></section><section class="sect2" id="id-requirements" data-id-title="Requirements"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.2.2 </span><span class="title-name">Requirements</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-requirements">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>General:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>SCC registered machine</strong></span> - All downstream cluster nodes should be registered to <code class="literal"><a class="link" href="https://scc.suse.com/" target="_blank">https://scc.suse.com/</a></code>. This is needed so that the <code class="literal">os-pkg-update.service/os-migration.service</code> can successfully connect to the needed OS RPM repositories.</p><div id="id-1.7.5.4.3.3.1.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>For Edge releases that require a new OS version (e.g Edge 3.1), make sure that your SCC key supports the migration to the new version (e.g. for Edge 3.1, the SCC key should support SLE Micro <code class="literal">5.5</code> → <code class="literal">6.0</code> migration).</p></div></li><li class="listitem"><p><span class="strong"><strong>Make sure that SUC Plan tolerations match node tolerations</strong></span> - If your Kubernetes cluster nodes have custom <span class="strong"><strong>taints</strong></span>, make sure to add <a class="link" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank">tolerations</a> for those taints in the <span class="strong"><strong>SUC Plans</strong></span>. By default <span class="strong"><strong>SUC Plans</strong></span> have tolerations only for <span class="strong"><strong>control-plane</strong></span> nodes. Default tolerations include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>CriticalAddonsOnly=true:NoExecute</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/control-plane:NoSchedule</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/etcd:NoExecute</em></span></p><div id="id-1.7.5.4.3.3.2.2.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Any additional tolerations must be added under the <code class="literal">.spec.tolerations</code> section of each Plan. <span class="strong"><strong>SUC Plans</strong></span> related to the OS upgrade can be found in the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> repository under <code class="literal">fleets/day2/system-upgrade-controller-plans/os-upgrade</code>. <span class="strong"><strong>Make sure you use the Plans from a valid repository <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</strong></span></p><p>An example of defining custom tolerations for the <span class="strong"><strong>control-plane</strong></span> SUC Plan, would look like this:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: os-upgrade-control-plane
spec:
  ...
  tolerations:
  # default tolerations
  - key: "CriticalAddonsOnly"
    operator: "Equal"
    value: "true"
    effect: "NoExecute"
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Equal"
    effect: "NoSchedule"
  - key: "node-role.kubernetes.io/etcd"
    operator: "Equal"
    effect: "NoExecute"
  # custom toleration
  - key: "foo"
    operator: "Equal"
    value: "bar"
    effect: "NoSchedule"
...</pre></div></div></li></ul></div></li></ol></div><p><span class="emphasis"><em>Air-gapped:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>Mirror SUSE RPM repositories</strong></span> - OS RPM repositories should be locally mirrored so that <code class="literal">os-pkg-update.service/os-migration.service</code> can have access to them. This can be achieved by using either <a class="link" href="https://documentation.suse.com/sles/15-SP6/html/SLES-all/book-rmt.html" target="_blank">RMT</a> or <a class="link" href="https://documentation.suse.com/suma/5.0/en/suse-manager/index.html" target="_blank">SUMA</a>.</p></li></ol></div></section><section class="sect2" id="id-update-procedure" data-id-title="Update procedure"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.2.3 </span><span class="title-name">Update procedure</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-update-procedure">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.5.4.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This section assumes you will be deploying the <code class="literal">OS upgrade</code> <span class="strong"><strong>SUC Plan</strong></span> using Fleet (<a class="xref" href="components-fleet.html" title="Chapter 7. Fleet">Chapter 7, <em>Fleet</em></a>). If you intend to deploy the <span class="strong"><strong>SUC Plan</strong></span> using a different approach, refer to <a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-third-party" title="30.2.4.3. SUC Plan deployment - third-party GitOps workflow">Section 30.2.4.3, “SUC Plan deployment - third-party GitOps workflow”</a>.</p></div><div id="id-1.7.5.4.4.3" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>For environments previously upgraded using this procedure, users should ensure that <span class="strong"><strong>one</strong></span> of the following steps is completed:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">Remove any previously deployed SUC Plans related to older Edge release versions from the downstream cluster</code> - can be done by removing the desired <span class="emphasis"><em>downstream</em></span> cluster from the existing <code class="literal">GitRepo/Bundle</code> target configuration, or removing the <code class="literal">GitRepo/Bundle</code> resource altogether.</p></li><li class="listitem"><p><code class="literal">Reuse the existing GitRepo/Bundle resource</code> - can be done by pointing the resource’s revision to a new tag that holds the correct fleets for the desired <code class="literal">suse-edge/fleet-examples</code> <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a>.</p></li></ul></div><p>This is done in order to avoid clashes between <code class="literal">SUC Plans</code> for older Edge release versions.</p><p>If users attempt to upgrade, while there are existing <code class="literal">SUC Plans</code> on the <span class="emphasis"><em>downstream</em></span> cluster, they will see the following fleet error:</p><div class="verbatim-wrap highlight bash"><pre class="screen">Not installed: Unable to continue with install: Plan &lt;plan_name&gt; in namespace &lt;plan_namespace&gt; exists and cannot be imported into the current release: invalid ownership metadata; annotation validation error..</pre></div></div><p>The <code class="literal">OS upgrade procedure</code> revolves around deploying <span class="strong"><strong>SUC Plans</strong></span> to downstream clusters. These plans hold information about how and on which nodes to deploy the <code class="literal">os-pkg-update.service/os-migration.service</code>. For information regarding the structure of a <span class="strong"><strong>SUC Plan</strong></span>, refer to the <a class="link" href="https://github.com/rancher/system-upgrade-controller?tab=readme-ov-file#example-plans" target="_blank">upstream</a> documentation.</p><p><code class="literal">OS upgrade</code> SUC Plans are shipped in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Through a <code class="literal">GitRepo</code> resources - <a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo" title="30.2.4.1. SUC Plan deployment - GitRepo resource">Section 30.2.4.1, “SUC Plan deployment - GitRepo resource”</a></p></li><li class="listitem"><p>Through a <code class="literal">Bundle</code> resource - <a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle" title="30.2.4.2. SUC Plan deployment - Bundle resource">Section 30.2.4.2, “SUC Plan deployment - Bundle resource”</a></p></li></ul></div><p>To determine which resource you should use, refer to <a class="xref" href="day2-downstream-clusters.html#day2-determine-use-case" title="30.1.2. Determine your use-case">Section 30.1.2, “Determine your use-case”</a>.</p><p>For a full overview of what happens during the <span class="emphasis"><em>upgrade procedure</em></span>, refer to the <a class="xref" href="day2-downstream-clusters.html#os-update-overview" title="30.2.3.1. Overview">Section 30.2.3.1, “Overview”</a> section.</p><section class="sect3" id="os-update-overview" data-id-title="Overview"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.2.3.1 </span><span class="title-name">Overview</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#os-update-overview">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section aims to describe the full workflow that the <span class="strong"><strong><span class="emphasis"><em>OS upgrade process</em></span></strong></span> goes through from start to finish.</p><div class="figure" id="id-1.7.5.4.4.9.3"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_os_pkg_update_diagram.png"><img src="images/day2_os_pkg_update_diagram.png" width="NaN" alt="day2 os pkg update diagram" title="day2 os pkg update diagram"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.1: </span><span class="title-name">OS upgrade workflow </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.4.4.9.3">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>OS upgrade steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Based on their use-case, the user determines whether to use a <span class="strong"><strong>GitRepo</strong></span> or a <span class="strong"><strong>Bundle</strong></span> resource for the deployment of the <code class="literal">OS upgrade SUC Plans</code> to the desired downstream clusters. For information on how to map a <span class="strong"><strong>GitRepo/Bundle</strong></span> to a specific set of downstream clusters, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>If you are unsure whether you should use a <span class="strong"><strong>GitRepo</strong></span> or a <span class="strong"><strong>Bundle</strong></span> resource for the <span class="strong"><strong>SUC Plan</strong></span> deployment, refer to <a class="xref" href="day2-downstream-clusters.html#day2-determine-use-case" title="30.1.2. Determine your use-case">Section 30.1.2, “Determine your use-case”</a>.</p></li><li class="listitem"><p>For <span class="strong"><strong>GitRepo/Bundle</strong></span> configuration options, refer to <a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo" title="30.2.4.1. SUC Plan deployment - GitRepo resource">Section 30.2.4.1, “SUC Plan deployment - GitRepo resource”</a> or <a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle" title="30.2.4.2. SUC Plan deployment - Bundle resource">Section 30.2.4.2, “SUC Plan deployment - Bundle resource”</a>.</p></li></ol></div></li><li class="listitem"><p>The user deploys the configured <span class="strong"><strong>GitRepo/Bundle</strong></span> resource to the <code class="literal">fleet-default</code> namespace in his <code class="literal">management cluster</code>. This is done either <span class="strong"><strong>manually</strong></span> or through the <span class="strong"><strong>Rancher UI</strong></span> if such is available.</p></li><li class="listitem"><p>Fleet (<a class="xref" href="components-fleet.html" title="Chapter 7. Fleet">Chapter 7, <em>Fleet</em></a>) constantly monitors the <code class="literal">fleet-default</code> namespace and immediately detects the newly deployed <span class="strong"><strong>GitRepo/Bundle</strong></span> resource. For more information regarding what namespaces does Fleet monitor, refer to Fleet’s <a class="link" href="https://fleet.rancher.io/namespaces" target="_blank">Namespaces</a> documentation.</p></li><li class="listitem"><p>If the user has deployed a <span class="strong"><strong>GitRepo</strong></span> resource, <code class="literal">Fleet</code> will reconcile the <span class="strong"><strong>GitRepo</strong></span> and based on its <span class="strong"><strong>paths</strong></span> and <span class="strong"><strong>fleet.yaml</strong></span> configurations it will deploy a <span class="strong"><strong>Bundle</strong></span> resource in the <code class="literal">fleet-default</code> namespace. For more information, refer to Fleet’s <a class="link" href="https://fleet.rancher.io/gitrepo-content" target="_blank">GitRepo Contents</a> documentation.</p></li><li class="listitem"><p><code class="literal">Fleet</code> then proceeds to deploy the <code class="literal">Kubernetes resources</code> from this <span class="strong"><strong>Bundle</strong></span> to all the targeted <code class="literal">downstream clusters</code>. In the context of <code class="literal">OS upgrades</code>, Fleet deploys the following resources from the <span class="strong"><strong>Bundle</strong></span>:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><span class="strong"><strong>Worker SUC Plan</strong></span> - instructs <span class="strong"><strong>SUC</strong></span> on how to do an OS upgrade on cluster <span class="strong"><strong><span class="emphasis"><em>worker</em></span></strong></span> nodes.  It is <span class="strong"><strong>not</strong></span> interpreted if the cluster consists only from <span class="emphasis"><em>control-plane</em></span> nodes. It executes after all control-plane <span class="strong"><strong>SUC</strong></span> plans have completed successfully.</p></li><li class="listitem"><p><span class="strong"><strong>Control Plane SUC Plan</strong></span> - instructs <span class="strong"><strong>SUC</strong></span> on how to do an OS upgrade on cluster <span class="strong"><strong><span class="emphasis"><em>control-plane</em></span></strong></span> nodes.</p></li><li class="listitem"><p><span class="strong"><strong>Script Secret</strong></span> - referenced in each <span class="strong"><strong>SUC Plan</strong></span>; ships an <code class="literal">upgrade.sh</code> script responsible for creating the <code class="literal">os-pkg-update.service/os-migration.service</code> which will do the actual OS upgrade.</p></li><li class="listitem"><p><span class="strong"><strong>Script Data ConfigMap</strong></span> - referenced in each <span class="strong"><strong>SUC Plan</strong></span>; ships configurations used by the <code class="literal">upgrade.sh</code> script.</p><div id="id-1.7.5.4.4.9.5.5.2.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The above resources will be deployed in the <code class="literal">cattle-system</code> namespace of each downstream cluster.</p></div></li></ol></div></li><li class="listitem"><p>On the downstream cluster, <span class="strong"><strong>SUC</strong></span> picks up the newly deployed <span class="strong"><strong>SUC Plans</strong></span> and deploys an <span class="strong"><strong><span class="emphasis"><em>Update Pod</em></span></strong></span> on each node that matches the <span class="strong"><strong>node selector</strong></span> defined in the <span class="strong"><strong>SUC Plan</strong></span>. For information how to monitor the <span class="strong"><strong>SUC Plan Pod</strong></span>, refer to <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="20.3. Monitoring System Upgrade Controller Plans">Section 20.3, “Monitoring System Upgrade Controller Plans”</a>.</p></li><li class="listitem"><p>The <span class="strong"><strong>Update Pod</strong></span> (deployed on each node) <span class="strong"><strong>mounts</strong></span> the script Secret and <span class="strong"><strong>executes</strong></span> the <code class="literal">upgrade.sh</code> script that the Secret ships.</p></li><li class="listitem"><p>The <code class="literal">upgrade.sh</code> proceeds to do the following:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Based on its configurations, determine whether the OS needs a package update, or it needs to be migrated.</p></li><li class="listitem"><p>Based on the above outcome it will create either a <code class="literal">os-pkg-update.service</code> (for package updates), or a <code class="literal">os-migration.service</code> (for migration). The service will be of type <span class="strong"><strong>oneshot</strong></span> and will adopt the following workflow:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>For <code class="literal">os-pkg-update.service</code>:</p><div class="orderedlist"><ol class="orderedlist" type="A"><li class="listitem"><p>Update all package versions on the node OS, by running <code class="literal">transactional-update cleanup up</code></p></li><li class="listitem"><p>After a successful <code class="literal">transactional-update</code>, schedule a system <span class="strong"><strong>reboot</strong></span> so that the package version updates can take effect</p></li></ol></div></li><li class="listitem"><p>For <code class="literal">os-migration.service</code>:</p><div class="orderedlist"><ol class="orderedlist" type="A"><li class="listitem"><p>Update all package versions on the node OS, by running <code class="literal">transactional-update cleanup up</code>. This is done to ensure that no old package versions cause an OS migration error.</p></li><li class="listitem"><p>Proceed to migrate the OS to the desired values. Migration is done by utilizing the <code class="literal">zypper migration</code> command.</p></li><li class="listitem"><p>Schedule a system <span class="strong"><strong>reboot</strong></span> so that the migration can take effect</p></li></ol></div></li></ol></div></li><li class="listitem"><p>Start the <code class="literal">os-pkg-update.service/os-migration.service</code> and wait for it to complete.</p></li><li class="listitem"><p>Cleanup the <code class="literal">os-pkg-update.service/os-migration.service</code> after the <span class="strong"><strong><span class="emphasis"><em>systemd.service</em></span></strong></span> has done its job. It is removed from the system to ensure that no accidental executions/reboots happen in the future.</p></li></ol></div></li></ol></div><p>The OS upgrade procedure finishes with the <span class="strong"><strong><span class="emphasis"><em>system reboot</em></span></strong></span>. After the reboot, the OS package versions are upgraded and if the Edge release requires it, the OS might be migrated as well.</p></section></section><section class="sect2" id="os-pkg-suc-plan-deployment" data-id-title="OS upgrade - SUC Plan deployment"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.2.4 </span><span class="title-name">OS upgrade - SUC Plan deployment</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#os-pkg-suc-plan-deployment">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section describes how to orchestrate the deployment of <span class="strong"><strong>SUC Plans</strong></span> related OS upgrades using Fleet’s <span class="strong"><strong>GitRepo</strong></span> and <span class="strong"><strong>Bundle</strong></span> resources.</p><section class="sect3" id="os-upgrade-suc-plan-deployment-git-repo" data-id-title="SUC Plan deployment - GitRepo resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.2.4.1 </span><span class="title-name">SUC Plan deployment - GitRepo resource</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>GitRepo</strong></span> resource, that ships the needed <code class="literal">OS upgrade</code> <span class="strong"><strong>SUC Plans</strong></span>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo-rancher" title="30.2.4.1.1. GitRepo creation - Rancher UI">Section 30.2.4.1.1, “GitRepo creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo-manual" title="30.2.4.1.2. GitRepo creation - manual">Section 30.2.4.1.2, “GitRepo creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the OS upgrade process of the nodes of your targeted cluster, refer to the <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="20.3. Monitoring System Upgrade Controller Plans">Section 20.3, “Monitoring System Upgrade Controller Plans”</a> documentation.</p><section class="sect4" id="os-upgrade-suc-plan-deployment-git-repo-rancher" data-id-title="GitRepo creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.2.4.1.1 </span><span class="title-name">GitRepo creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>To create a <code class="literal">GitRepo</code> resource through the Rancher UI, follow their official <a class="link" href="https://ranchermanager.docs.rancher.com/v2.9/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">documentation</a>.</p><p>The Edge team maintains a ready to use <a class="link" href="https://github.com/suse-edge/fleet-examples/tree/release-3.1.1/fleets/day2/system-upgrade-controller-plans/os-upgrade" target="_blank">fleet</a> that users can add as a <code class="literal">path</code> for their GitRepo resource.</p><div id="id-1.7.5.4.5.3.5.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Always use this fleet from a valid Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p>For use-cases where no custom tolerations need to be included to the <code class="literal">SUC plans</code> that the fleet ships, users can directly refer the <code class="literal">os-upgrade</code> fleet from the <code class="literal">suse-edge/fleet-examples</code> repository.</p><p>In cases where custom tolerations are needed, users should refer the <code class="literal">os-upgrade</code> fleet from a separate repository, allowing them to add the tolerations to the SUC plans as required.</p><p>An example of how a <code class="literal">GitRepo</code> can be configured to use the fleet from the <code class="literal">suse-edge/fleet-examples</code> repository, can be viewed <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.1.1/gitrepos/day2/os-upgrade-gitrepo.yaml" target="_blank">here</a>.</p></section><section class="sect4" id="os-upgrade-suc-plan-deployment-git-repo-manual" data-id-title="GitRepo creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.2.4.1.2 </span><span class="title-name">GitRepo creation - manual</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-git-repo-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Pull the <span class="strong"><strong>GitRepo</strong></span> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o os-upgrade-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.1.1/gitrepos/day2/os-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>Edit the <span class="strong"><strong>GitRepo</strong></span> configuration, under <code class="literal">spec.targets</code> specify your desired target list. By default the <code class="literal">GitRepo</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any downstream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters change the default <code class="literal">GitRepo</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>GitRepo</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f os-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>GitRepo</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get gitrepo os-upgrade -n fleet-default

# Example output
NAME            REPO                                              COMMIT         BUNDLEDEPLOYMENTS-READY   STATUS
os-upgrade      https://github.com/suse-edge/fleet-examples.git   release-3.1.1  0/0</pre></div></li></ol></div></section></section><section class="sect3" id="os-upgrade-suc-plan-deployment-bundle" data-id-title="SUC Plan deployment - Bundle resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.2.4.2 </span><span class="title-name">SUC Plan deployment - Bundle resource</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>Bundle</strong></span> resource, that ships the needed <code class="literal">OS upgrade</code> <span class="strong"><strong>SUC Plans</strong></span>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle-rancher" title="30.2.4.2.1. Bundle creation - Rancher UI">Section 30.2.4.2.1, “Bundle creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle-manual" title="30.2.4.2.2. Bundle creation - manual">Section 30.2.4.2.2, “Bundle creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the OS upgrade process of the nodes of your targeted cluster, refer to the <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="20.3. Monitoring System Upgrade Controller Plans">Section 20.3, “Monitoring System Upgrade Controller Plans”</a> documentation.</p><section class="sect4" id="os-upgrade-suc-plan-deployment-bundle-rancher" data-id-title="Bundle creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.2.4.2.1 </span><span class="title-name">Bundle creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The Edge team maintains a ready to use <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.1.1/bundles/day2/system-upgrade-controller-plans/os-upgrade/os-upgrade-bundle.yaml" target="_blank">bundle</a> that can be used in the below steps.</p><div id="id-1.7.5.4.5.4.5.3" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Always use this bundle from a valid Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p>To create a bundle through Rancher’s UI:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, click <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Advanced</strong></span> &gt; <span class="strong"><strong>Bundles</strong></span></p></li><li class="listitem"><p>Select <span class="strong"><strong>Create from YAML</strong></span></p></li><li class="listitem"><p>From here you can create the Bundle in one of the following ways:</p><div id="id-1.7.5.4.5.4.5.5.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There might be use-cases where you would need to include custom tolerations to the <code class="literal">SUC plans</code> that the bundle ships. Make sure to include those tolerations in the bundle that will be generated by the below steps.</p></div><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>By manually copying the <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.1.1/bundles/day2/system-upgrade-controller-plans/os-upgrade/os-upgrade-bundle.yaml" target="_blank">bundle content</a> from <code class="literal">suse-edge/fleet-examples</code> to the <span class="strong"><strong>Create from YAML</strong></span> page.</p></li><li class="listitem"><p>By cloning the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository from the desired <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag and selecting the <span class="strong"><strong>Read from File</strong></span> option in the <span class="strong"><strong>Create from YAML</strong></span> page. From there, navigate to the bundle location (<code class="literal">bundles/day2/system-upgrade-controller-plans/os-upgrade</code>) and select the bundle file. This will auto-populate the <span class="strong"><strong>Create from YAML</strong></span> page with the bundle content.</p></li></ol></div></li><li class="listitem"><p>Change the <span class="strong"><strong>target</strong></span> clusters for the <code class="literal">Bundle</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all downstream clusters change the default Bundle <code class="literal">.spec.targets</code> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>For a more granular downstream cluster mappings, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p></li></ul></div></li><li class="listitem"><p>Select <span class="strong"><strong>Create</strong></span></p></li></ol></div></section><section class="sect4" id="os-upgrade-suc-plan-deployment-bundle-manual" data-id-title="Bundle creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.2.4.2.2 </span><span class="title-name">Bundle creation - manual</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-bundle-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Pull the <span class="strong"><strong>Bundle</strong></span> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o os-upgrade-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.1.1/bundles/day2/system-upgrade-controller-plans/os-upgrade/os-upgrade-bundle.yaml</pre></div></li><li class="listitem"><p>Edit the <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> configurations, under <code class="literal">spec.targets</code> provide your desired target list. By default the <code class="literal">Bundle</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any downstream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters change the default <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>Bundle</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f os-upgrade-bundle.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>Bundle</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get bundles -n fleet-default</pre></div></li></ol></div></section></section><section class="sect3" id="os-upgrade-suc-plan-deployment-third-party" data-id-title="SUC Plan deployment - third-party GitOps workflow"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.2.4.3 </span><span class="title-name">SUC Plan deployment - third-party GitOps workflow</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#os-upgrade-suc-plan-deployment-third-party">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>There might be use-cases where users would like to incorporate the OS upgrade <span class="strong"><strong>SUC Plans</strong></span> to their own third-party GitOps workflow (e.g. <code class="literal">Flux</code>).</p><p>To get the OS upgrade resources that you need, first determine the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag of the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository that you would like to use.</p><p>After that, resources can be found at <code class="literal">fleets/day2/system-upgrade-controller-plans/os-upgrade</code>, where:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">plan-control-plane.yaml</code> - <code class="literal">system-upgrade-controller</code> Plan resource for <span class="strong"><strong>control-plane</strong></span> nodes.</p></li><li class="listitem"><p><code class="literal">plan-worker.yaml</code> - <code class="literal">system-upgrade-controller</code> Plan resource for <span class="strong"><strong>worker</strong></span> nodes.</p></li><li class="listitem"><p><code class="literal">secret.yaml</code> - secret that ships the <code class="literal">upgrade.sh</code> script.</p></li><li class="listitem"><p><code class="literal">config-map.yaml</code> - ConfigMap that provides upgrade configurations that are consumed by the <code class="literal">upgrade.sh</code> script.</p></li></ul></div><div id="id-1.7.5.4.5.5.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>These <code class="literal">Plan</code> resources are interpreted by the <code class="literal">system-upgrade-controller</code> and should be deployed on each downstream cluster that you wish to upgrade. For information on how to deploy the <code class="literal">system-upgrade-controller</code>, see <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-install" title="20.2. Installing the System Upgrade Controller">Section 20.2, “Installing the System Upgrade Controller”</a>.</p></div><p>To better understand how your GitOps workflow can be used to deploy the <span class="strong"><strong>SUC Plans</strong></span> for OS upgrade, it can be beneficial to take a look at the overview (<a class="xref" href="day2-downstream-clusters.html#os-update-overview" title="30.2.3.1. Overview">Section 30.2.3.1, “Overview”</a>) of the update procedure using <code class="literal">Fleet</code>.</p></section></section></section><section class="sect1" id="day2-k8s-upgrade" data-id-title="Kubernetes version upgrade"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">30.3 </span><span class="title-name">Kubernetes version upgrade</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-k8s-upgrade">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.5.5.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>This section covers Kubernetes upgrades for downstream clusters that have <span class="strong"><strong>NOT</strong></span> been created through a Rancher (<a class="xref" href="components-rancher.html" title="Chapter 4. Rancher">Chapter 4, <em>Rancher</em></a>) instance. For information on how to upgrade the Kubernetes version of <code class="literal">Rancher</code> created clusters, see <a class="link" href="https://ranchermanager.docs.rancher.com/v2.9/getting-started/installation-and-upgrade/upgrade-and-roll-back-kubernetes#upgrading-the-kubernetes-version" target="_blank">Upgrading and Rolling Back Kubernetes</a>.</p></div><section class="sect2" id="id-components-3" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.3.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-components-3">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers the custom components that the <code class="literal">Kubernetes upgrade</code> process uses over the default <code class="literal">Day 2</code> components (<a class="xref" href="day2-downstream-clusters.html#day2-downstream-components" title="30.1.1. Components">Section 30.1.1, “Components”</a>).</p><section class="sect3" id="id-rke2-upgrade" data-id-title="rke2-upgrade"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.3.1.1 </span><span class="title-name">rke2-upgrade</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-rke2-upgrade">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Image responsible for upgrading the RKE2 version of a specific node.</p><p>Shipped through a Pod created by <span class="strong"><strong>SUC</strong></span> based on a <span class="strong"><strong>SUC Plan</strong></span>. The Plan should be located on each <span class="strong"><strong>downstream cluster</strong></span> that is in need of a RKE2 upgrade.</p><p>For more information regarding how the <code class="literal">rke2-upgrade</code> image performs the upgrade, see the <a class="link" href="https://github.com/rancher/rke2-upgrade/tree/master" target="_blank">upstream</a> documentation.</p></section><section class="sect3" id="id-k3s-upgrade" data-id-title="k3s-upgrade"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.3.1.2 </span><span class="title-name">k3s-upgrade</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-k3s-upgrade">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Image responsible for upgrading the K3s version of a specific node.</p><p>Shipped through a Pod created by <span class="strong"><strong>SUC</strong></span> based on a <span class="strong"><strong>SUC Plan</strong></span>. The Plan should be located on each <span class="strong"><strong>downstream cluster</strong></span> that is in need of a K3s upgrade.</p><p>For more information regarding how the <code class="literal">k3s-upgrade</code> image performs the upgrade, see the <a class="link" href="https://github.com/k3s-io/k3s-upgrade" target="_blank">upstream</a> documentation.</p></section></section><section class="sect2" id="id-requirements-2" data-id-title="Requirements"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.3.2 </span><span class="title-name">Requirements</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-requirements-2">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>Backup your Kubernetes distribution:</strong></span></p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>For <span class="strong"><strong>imported RKE2 clusters</strong></span>, see the <a class="link" href="https://docs.rke2.io/backup_restore" target="_blank">RKE2 Backup and Restore</a> documentation.</p></li><li class="listitem"><p>For <span class="strong"><strong>imported K3s clusters</strong></span>, see the <a class="link" href="https://docs.k3s.io/datastore/backup-restore" target="_blank">K3s Backup and Restore</a> documentation.</p></li></ol></div></li><li class="listitem"><p><span class="strong"><strong>Make sure that SUC Plan tolerations match node tolerations</strong></span> - If your Kubernetes cluster nodes have custom <span class="strong"><strong>taints</strong></span>, make sure to add <a class="link" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank">tolerations</a> for those taints in the <span class="strong"><strong>SUC Plans</strong></span>. By default <span class="strong"><strong>SUC Plans</strong></span> have tolerations only for <span class="strong"><strong>control-plane</strong></span> nodes. Default tolerations include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>CriticalAddonsOnly=true:NoExecute</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/control-plane:NoSchedule</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/etcd:NoExecute</em></span></p><div id="id-1.7.5.5.4.2.2.2.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Any additional tolerations must be added under the <code class="literal">.spec.tolerations</code> section of each Plan. <span class="strong"><strong>SUC Plans</strong></span> related to the Kubernetes version upgrade can be found in the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> repository under:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <span class="strong"><strong>RKE2</strong></span> - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade</code></p></li><li class="listitem"><p>For <span class="strong"><strong>K3s</strong></span>  - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade</code></p></li></ul></div><p><span class="strong"><strong>Make sure you use the Plans from a valid repository <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</strong></span></p><p>An example of defining custom tolerations for the RKE2 <span class="strong"><strong>control-plane</strong></span> SUC Plan, would look like this:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: rke2-upgrade-control-plane
spec:
  ...
  tolerations:
  # default tolerations
  - key: "CriticalAddonsOnly"
    operator: "Equal"
    value: "true"
    effect: "NoExecute"
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Equal"
    effect: "NoSchedule"
  - key: "node-role.kubernetes.io/etcd"
    operator: "Equal"
    effect: "NoExecute"
  # custom toleration
  - key: "foo"
    operator: "Equal"
    value: "bar"
    effect: "NoSchedule"
...</pre></div></div></li></ul></div></li></ol></div></section><section class="sect2" id="id-upgrade-procedure" data-id-title="Upgrade procedure"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.3.3 </span><span class="title-name">Upgrade procedure</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-upgrade-procedure">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.5.5.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This section assumes you will be deploying <span class="strong"><strong>SUC Plans</strong></span> using Fleet (<a class="xref" href="components-fleet.html" title="Chapter 7. Fleet">Chapter 7, <em>Fleet</em></a>). If you intend to deploy the <span class="strong"><strong>SUC Plan</strong></span> using a different approach, refer to <a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-third-party" title="30.3.4.3. SUC Plan deployment - third-party GitOps workflow">Section 30.3.4.3, “SUC Plan deployment - third-party GitOps workflow”</a>.</p></div><div id="id-1.7.5.5.5.3" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>For environments previously upgraded using this procedure, users should ensure that <span class="strong"><strong>one</strong></span> of the following steps is completed:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">Remove any previously deployed SUC Plans related to older Edge release versions from the downstream cluster</code> - can be done by removing the desired <span class="emphasis"><em>downstream</em></span> cluster from the existing <code class="literal">GitRepo/Bundle</code> target configuration, or removing the <code class="literal">GitRepo/Bundle</code> resource altogether.</p></li><li class="listitem"><p><code class="literal">Reuse the existing GitRepo/Bundle resource</code> - can be done by pointing the resource’s revision to a new tag that holds the correct fleets for the desired <code class="literal">suse-edge/fleet-examples</code> <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a>.</p></li></ul></div><p>This is done in order to avoid clashes between <code class="literal">SUC Plans</code> for older Edge release versions.</p><p>If users attempt to upgrade, while there are existing <code class="literal">SUC Plans</code> on the <span class="emphasis"><em>downstream</em></span> cluster, they will see the following fleet error:</p><div class="verbatim-wrap highlight bash"><pre class="screen">Not installed: Unable to continue with install: Plan &lt;plan_name&gt; in namespace &lt;plan_namespace&gt; exists and cannot be imported into the current release: invalid ownership metadata; annotation validation error..</pre></div></div><p>The <code class="literal">Kubernetes version upgrade procedure</code> revolves around deploying <span class="strong"><strong>SUC Plans</strong></span> to downstream clusters. These plans hold information that instructs the <span class="strong"><strong>SUC</strong></span> on which nodes to create Pods which run the <code class="literal">rke2/k3s-upgrade</code> images. For information regarding the structure of a <span class="strong"><strong>SUC Plan</strong></span>, refer to the <a class="link" href="https://github.com/rancher/system-upgrade-controller?tab=readme-ov-file#example-plans" target="_blank">upstream</a> documentation.</p><p><code class="literal">Kubernetes upgrade</code> Plans are shipped in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Through a <code class="literal">GitRepo</code> resources - <a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo" title="30.3.4.1. SUC Plan deployment - GitRepo resource">Section 30.3.4.1, “SUC Plan deployment - GitRepo resource”</a></p></li><li class="listitem"><p>Through a <code class="literal">Bundle</code> resource - <a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle" title="30.3.4.2. SUC Plan deployment - Bundle resource">Section 30.3.4.2, “SUC Plan deployment - Bundle resource”</a></p></li></ul></div><p>To determine which resource you should use, refer to <a class="xref" href="day2-downstream-clusters.html#day2-determine-use-case" title="30.1.2. Determine your use-case">Section 30.1.2, “Determine your use-case”</a>.</p><p>For a full overview of what happens during the <span class="emphasis"><em>update procedure</em></span>, refer to the <a class="xref" href="day2-downstream-clusters.html#k8s-version-upgrade-overview" title="30.3.3.1. Overview">Section 30.3.3.1, “Overview”</a> section.</p><section class="sect3" id="k8s-version-upgrade-overview" data-id-title="Overview"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.3.3.1 </span><span class="title-name">Overview</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#k8s-version-upgrade-overview">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section aims to describe the full workflow that the <span class="strong"><strong><span class="emphasis"><em>Kubernetes version upgrade process</em></span></strong></span> goes through from start to finish.</p><div class="figure" id="id-1.7.5.5.5.9.3"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_k8s_version_upgrade_diagram.png"><img src="images/day2_k8s_version_upgrade_diagram.png" width="NaN" alt="day2 k8s version upgrade diagram" title="day2 k8s version upgrade diagram"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.2: </span><span class="title-name">Kubernetes version upgrade workflow </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.5.5.9.3">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>Kubernetes version upgrade steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Based on his use-case, the user determines whether to use a <span class="strong"><strong>GitRepo</strong></span> or a <span class="strong"><strong>Bundle</strong></span> resource for the deployment of the <code class="literal">Kubernetes upgrade SUC Plans</code> to the desired downstream clusters. For information on how to map a <span class="strong"><strong>GitRepo/Bundle</strong></span> to a specific set of downstream clusters, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>If you are unsure whether you should use a <span class="strong"><strong>GitRepo</strong></span> or a <span class="strong"><strong>Bundle</strong></span> resource for the <span class="strong"><strong>SUC Plan</strong></span> deployment, refer to <a class="xref" href="day2-downstream-clusters.html#day2-determine-use-case" title="30.1.2. Determine your use-case">Section 30.1.2, “Determine your use-case”</a>.</p></li><li class="listitem"><p>For <span class="strong"><strong>GitRepo/Bundle</strong></span> configuration options, refer to <a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo" title="30.3.4.1. SUC Plan deployment - GitRepo resource">Section 30.3.4.1, “SUC Plan deployment - GitRepo resource”</a> or <a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle" title="30.3.4.2. SUC Plan deployment - Bundle resource">Section 30.3.4.2, “SUC Plan deployment - Bundle resource”</a>.</p></li></ol></div></li><li class="listitem"><p>The user deploys the configured <span class="strong"><strong>GitRepo/Bundle</strong></span> resource to the <code class="literal">fleet-default</code> namespace in his <code class="literal">management cluster</code>. This is done either <span class="strong"><strong>manually</strong></span> or through the <span class="strong"><strong>Rancher UI</strong></span> if such is available.</p></li><li class="listitem"><p>Fleet (<a class="xref" href="components-fleet.html" title="Chapter 7. Fleet">Chapter 7, <em>Fleet</em></a>) constantly monitors the <code class="literal">fleet-default</code> namespace and immediately detects the newly deployed <span class="strong"><strong>GitRepo/Bundle</strong></span> resource. For more information regarding what namespaces does Fleet monitor, refer to Fleet’s <a class="link" href="https://fleet.rancher.io/namespaces" target="_blank">Namespaces</a> documentation.</p></li><li class="listitem"><p>If the user has deployed a <span class="strong"><strong>GitRepo</strong></span> resource, <code class="literal">Fleet</code> will reconcile the <span class="strong"><strong>GitRepo</strong></span> and based on its <span class="strong"><strong>paths</strong></span> and <span class="strong"><strong>fleet.yaml</strong></span> configurations it will deploy a <span class="strong"><strong>Bundle</strong></span> resource in the <code class="literal">fleet-default</code> namespace. For more information, refer to Fleet’s <a class="link" href="https://fleet.rancher.io/gitrepo-content" target="_blank">GitRepo Contents</a> documentation.</p></li><li class="listitem"><p><code class="literal">Fleet</code> then proceeds to deploy the <code class="literal">Kubernetes resources</code> from this <span class="strong"><strong>Bundle</strong></span> to all the targeted <code class="literal">downstream clusters</code>. In the context of the <code class="literal">Kubernetes version upgrade</code>, Fleet deploys the following resources from the <span class="strong"><strong>Bundle</strong></span> (depending on the Kubernetes distribution):</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><code class="literal">rke2-upgrade-worker</code>/<code class="literal">k3s-upgrade-worker</code> - instructs <span class="strong"><strong>SUC</strong></span> on how to do a Kubernetes upgrade on cluster <span class="strong"><strong><span class="emphasis"><em>worker</em></span></strong></span> nodes. Will <span class="strong"><strong>not</strong></span> be interpreted if the cluster consists only from <span class="emphasis"><em>control-plane</em></span> nodes.</p></li><li class="listitem"><p><code class="literal">rke2-upgrade-control-plane</code>/<code class="literal">k3s-upgrade-control-plane</code> - instructs <span class="strong"><strong>SUC</strong></span> on how to do a Kubernetes upgrade on cluster <span class="strong"><strong><span class="emphasis"><em>control-plane</em></span></strong></span> nodes.</p><div id="id-1.7.5.5.5.9.5.5.2.2.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The above <span class="strong"><strong>SUC Plans</strong></span> will be deployed in the <code class="literal">cattle-system</code> namespace of each downstream cluster.</p></div></li></ol></div></li><li class="listitem"><p>On the downstream cluster, <span class="strong"><strong>SUC</strong></span> picks up the newly deployed <span class="strong"><strong>SUC Plans</strong></span> and deploys an <span class="strong"><strong><span class="emphasis"><em>Update Pod</em></span></strong></span> on each node that matches the <span class="strong"><strong>node selector</strong></span> defined in the <span class="strong"><strong>SUC Plan</strong></span>. For information how to monitor the <span class="strong"><strong>SUC Plan Pod</strong></span>, refer to <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="20.3. Monitoring System Upgrade Controller Plans">Section 20.3, “Monitoring System Upgrade Controller Plans”</a>.</p></li><li class="listitem"><p>Depending on which <span class="strong"><strong>SUC Plans</strong></span> you have deployed, the <span class="strong"><strong>Update Pod</strong></span> will run either a <a class="link" href="https://hub.docker.com/r/rancher/rke2-upgrade/tags" target="_blank">rke2-upgrade</a> or a <a class="link" href="https://hub.docker.com/r/rancher/k3s-upgrade/tags" target="_blank">k3s-upgrade</a> image and will execute the following workflow on <span class="strong"><strong>each</strong></span> cluster node:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cordon/" target="_blank">Cordon</a> cluster node - to ensure that no pods are scheduled accidentally on this node while it is being upgraded, we mark it as <code class="literal">unschedulable</code>.</p></li><li class="listitem"><p>Replace the <code class="literal">rke2/k3s</code> binary that is installed on the node OS with the binary shipped by the <code class="literal">rke2-upgrade/k3s-upgrade</code> image that the Pod is currently running.</p></li><li class="listitem"><p>Kill the <code class="literal">rke2/k3s</code> process that is running on the node OS - this instructs the <span class="strong"><strong>supervisor</strong></span> to automatically restart the <code class="literal">rke2/k3s</code> process using the new version.</p></li><li class="listitem"><p><a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_uncordon/" target="_blank">Uncordon</a> cluster node - after the successful Kubernetes distribution upgrade, the node is again marked as <code class="literal">schedulable</code>.</p><div id="id-1.7.5.5.5.9.5.7.2.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>For further information regarding how the <code class="literal">rke2-upgrade</code> and <code class="literal">k3s-upgrade</code> images work, see the <a class="link" href="https://github.com/rancher/rke2-upgrade" target="_blank">rke2-upgrade</a> and <a class="link" href="https://github.com/k3s-io/k3s-upgrade" target="_blank">k3s-upgrade</a> upstream projects.</p></div></li></ol></div></li></ol></div><p>With the above steps executed, the Kubernetes version of each cluster node should have been upgraded to the desired Edge compatible <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a>.</p></section></section><section class="sect2" id="k8s-upgrade-suc-plan-deployment" data-id-title="Kubernetes version upgrade - SUC Plan deployment"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.3.4 </span><span class="title-name">Kubernetes version upgrade - SUC Plan deployment</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section describes how to orchestrate the deployment of <span class="strong"><strong>SUC Plans</strong></span> related Kubernetes upgrades using Fleet’s <span class="strong"><strong>GitRepo</strong></span> and <span class="strong"><strong>Bundle</strong></span> resources.</p><section class="sect3" id="k8s-upgrade-suc-plan-deployment-git-repo" data-id-title="SUC Plan deployment - GitRepo resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.3.4.1 </span><span class="title-name">SUC Plan deployment - GitRepo resource</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>GitRepo</strong></span> resource, that ships the needed <code class="literal">Kubernetes upgrade</code> <span class="strong"><strong>SUC Plans</strong></span>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo-rancher" title="30.3.4.1.1. GitRepo creation - Rancher UI">Section 30.3.4.1.1, “GitRepo creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo-manual" title="30.3.4.1.2. GitRepo creation - manual">Section 30.3.4.1.2, “GitRepo creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the Kubernetes upgrade process of the nodes of your targeted cluster, refer to the <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="20.3. Monitoring System Upgrade Controller Plans">Section 20.3, “Monitoring System Upgrade Controller Plans”</a> documentation.</p><section class="sect4" id="k8s-upgrade-suc-plan-deployment-git-repo-rancher" data-id-title="GitRepo creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.3.4.1.1 </span><span class="title-name">GitRepo creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>To create a <code class="literal">GitRepo</code> resource through the Rancher UI, follow their official <a class="link" href="https://ranchermanager.docs.rancher.com/v2.9/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">documentation</a>.</p><p>The Edge team maintains ready to use fleets for both <a class="link" href="https://github.com/suse-edge/fleet-examples/tree/release-3.1.1/fleets/day2/system-upgrade-controller-plans/rke2-upgrade" target="_blank">rke2</a> and <a class="link" href="https://github.com/suse-edge/fleet-examples/tree/release-3.1.1/fleets/day2/system-upgrade-controller-plans/k3s-upgrade" target="_blank">k3s</a> Kubernetes distributions, that users can add as a <code class="literal">path</code> for their GitRepo resource.</p><div id="id-1.7.5.5.6.3.5.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Always use this fleets from a valid Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p>For use-cases where no custom tolerations need to be included to the <code class="literal">SUC plans</code> that these fleets ship, users can directly refer the fleets from the <code class="literal">suse-edge/fleet-examples</code> repository.</p><p>In cases where custom tolerations are needed, users should refer the fleets from a separate repository, allowing them to add the tolerations to the SUC plans as required.</p><p>Configuration examples for a <code class="literal">GitRepo</code> resource using the fleets from <code class="literal">suse-edge/fleet-examples</code> repository:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.1.1/gitrepos/day2/rke2-upgrade-gitrepo.yaml" target="_blank">RKE2</a></p></li><li class="listitem"><p><a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.1.1/gitrepos/day2/k3s-upgrade-gitrepo.yaml" target="_blank">K3s</a></p></li></ul></div></section><section class="sect4" id="k8s-upgrade-suc-plan-deployment-git-repo-manual" data-id-title="GitRepo creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.3.4.1.2 </span><span class="title-name">GitRepo creation - manual</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-git-repo-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Pull the <span class="strong"><strong>GitRepo</strong></span> resource:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <span class="strong"><strong>RKE2</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o rke2-upgrade-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.1.1/gitrepos/day2/rke2-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>For <span class="strong"><strong>K3s</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o k3s-upgrade-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.1.1/gitrepos/day2/k3s-upgrade-gitrepo.yaml</pre></div></li></ul></div></li><li class="listitem"><p>Edit the <span class="strong"><strong>GitRepo</strong></span> configuration, under <code class="literal">spec.targets</code> specify your desired target list. By default the <code class="literal">GitRepo</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any downstream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters change the default <code class="literal">GitRepo</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>GitRepo</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># RKE2
kubectl apply -f rke2-upgrade-gitrepo.yaml

# K3s
kubectl apply -f k3s-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>GitRepo</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># RKE2
kubectl get gitrepo rke2-upgrade -n fleet-default

# K3s
kubectl get gitrepo k3s-upgrade -n fleet-default

# Example output
NAME           REPO                                              COMMIT          BUNDLEDEPLOYMENTS-READY   STATUS
k3s-upgrade    https://github.com/suse-edge/fleet-examples.git   release-3.1.1   0/0
rke2-upgrade   https://github.com/suse-edge/fleet-examples.git   release-3.1.1   0/0</pre></div></li></ol></div></section></section><section class="sect3" id="k8s-upgrade-suc-plan-deployment-bundle" data-id-title="SUC Plan deployment - Bundle resource"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.3.4.2 </span><span class="title-name">SUC Plan deployment - Bundle resource</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>Bundle</strong></span> resource, that ships the needed <code class="literal">Kubernetes upgrade</code> <span class="strong"><strong>SUC Plans</strong></span>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle-rancher" title="30.3.4.2.1. Bundle creation - Rancher UI">Section 30.3.4.2.1, “Bundle creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle-manual" title="30.3.4.2.2. Bundle creation - manual">Section 30.3.4.2.2, “Bundle creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the Kubernetes upgrade process of the nodes of your targeted cluster, refer to the <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="20.3. Monitoring System Upgrade Controller Plans">Section 20.3, “Monitoring System Upgrade Controller Plans”</a> documentation.</p><section class="sect4" id="k8s-upgrade-suc-plan-deployment-bundle-rancher" data-id-title="Bundle creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.3.4.2.1 </span><span class="title-name">Bundle creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle-rancher">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The Edge team maintains ready to use bundles for both <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.1.1/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml" target="_blank">rke2</a> and <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.1.1/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml" target="_blank">k3s</a> Kubernetes distributions that can be used in the below steps.</p><div id="id-1.7.5.5.6.4.5.3" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Always use this bundle from a valid Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p>To create a bundle through Rancher’s UI:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, click <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Advanced</strong></span> &gt; <span class="strong"><strong>Bundles</strong></span></p></li><li class="listitem"><p>Select <span class="strong"><strong>Create from YAML</strong></span></p></li><li class="listitem"><p>From here you can create the Bundle in one of the following ways:</p><div id="id-1.7.5.5.6.4.5.5.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There might be use-cases where you would need to include custom tolerations to the <code class="literal">SUC plans</code> that the bundle ships. Make sure to include those tolerations in the bundle that will be generated by the below steps.</p></div><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>By manually copying the bundle content for <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.1.1/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml" target="_blank">RKE2</a> or <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.1.1/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml" target="_blank">K3s</a> from <code class="literal">suse-edge/fleet-examples</code> to the <span class="strong"><strong>Create from YAML</strong></span> page.</p></li><li class="listitem"><p>By cloning the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository from the desired <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag and selecting the <span class="strong"><strong>Read from File</strong></span> option in the <span class="strong"><strong>Create from YAML</strong></span> page. From there, navigate to the bundle that you need (<code class="literal">bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml</code> for RKE2 and <code class="literal">bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml</code> for K3s). This will auto-populate the <span class="strong"><strong>Create from YAML</strong></span> page with the bundle content.</p></li></ol></div></li><li class="listitem"><p>Change the <span class="strong"><strong>target</strong></span> clusters for the <code class="literal">Bundle</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all downstream clusters change the default Bundle <code class="literal">.spec.targets</code> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>For a more granular downstream cluster mappings, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p></li></ul></div></li><li class="listitem"><p><span class="strong"><strong>Create</strong></span></p></li></ol></div></section><section class="sect4" id="k8s-upgrade-suc-plan-deployment-bundle-manual" data-id-title="Bundle creation - manual"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.3.4.2.2 </span><span class="title-name">Bundle creation - manual</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-bundle-manual">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Pull the <span class="strong"><strong>Bundle</strong></span> resources:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <span class="strong"><strong>RKE2</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o rke2-plan-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.1.1/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml</pre></div></li><li class="listitem"><p>For <span class="strong"><strong>K3s</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o k3s-plan-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.1.1/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml</pre></div></li></ul></div></li><li class="listitem"><p>Edit the <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> configurations, under <code class="literal">spec.targets</code> provide your desired target list. By default the <code class="literal">Bundle</code> resources from the <code class="literal">suse-edge/fleet-examples</code> are <span class="strong"><strong>NOT</strong></span> mapped to any downstream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To match all clusters change the default <code class="literal">Bundle</code> <span class="strong"><strong>target</strong></span> to:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterSelector: {}</pre></div></li><li class="listitem"><p>Alternatively, if you want a more granular cluster selection see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a></p></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>Bundle</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For RKE2
kubectl apply -f rke2-plan-bundle.yaml

# For K3s
kubectl apply -f k3s-plan-bundle.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>Bundle</strong></span> resource under the <code class="literal">fleet-default</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For RKE2
kubectl get bundles rke2-upgrade -n fleet-default

# For K3s
kubectl get bundles k3s-upgrade -n fleet-default

# Example output
NAME           BUNDLEDEPLOYMENTS-READY   STATUS
k3s-upgrade    0/0
rke2-upgrade   0/0</pre></div></li></ol></div></section></section><section class="sect3" id="k8s-upgrade-suc-plan-deployment-third-party" data-id-title="SUC Plan deployment - third-party GitOps workflow"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.3.4.3 </span><span class="title-name">SUC Plan deployment - third-party GitOps workflow</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#k8s-upgrade-suc-plan-deployment-third-party">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>There might be use-cases where users would like to incorporate the Kubernetes upgrade resources to their own third-party GitOps workflow (e.g. <code class="literal">Flux</code>).</p><p>To get the upgrade resources that you need, first determine the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag of the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository that you would like to use.</p><p>After that, the resources can be found at:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For a RKE2 cluster upgrade:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">control-plane</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade/plan-control-plane.yaml</code></p></li><li class="listitem"><p>For <code class="literal">worker</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade/plan-worker.yaml</code></p></li></ul></div></li><li class="listitem"><p>For a K3s cluster upgrade:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">control-plane</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade/plan-control-plane.yaml</code></p></li><li class="listitem"><p>For <code class="literal">worker</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade/plan-worker.yaml</code></p></li></ul></div></li></ul></div><div id="id-1.7.5.5.6.5.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>These <code class="literal">Plan</code> resources are interpreted by the <code class="literal">system-upgrade-controller</code> and should be deployed on each downstream cluster that you wish to upgrade. For information on how to deploy the <code class="literal">system-upgrade-controller</code>, see <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-install" title="20.2. Installing the System Upgrade Controller">Section 20.2, “Installing the System Upgrade Controller”</a>.</p></div><p>To better understand how your GitOps workflow can be used to deploy the <span class="strong"><strong>SUC Plans</strong></span> for Kubernetes version upgrade, it can be beneficial to take a look at the overview (<a class="xref" href="day2-downstream-clusters.html#k8s-version-upgrade-overview" title="30.3.3.1. Overview">Section 30.3.3.1, “Overview”</a>) of the update procedure using <code class="literal">Fleet</code>.</p></section></section></section><section class="sect1" id="day2-helm-upgrade" data-id-title="Helm chart upgrade"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">30.4 </span><span class="title-name">Helm chart upgrade</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.5.6.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The below sections focus on using <code class="literal">Fleet</code> functionalities to achieve a Helm chart update.</p><p>For use-cases, where a third party GitOps tool usage is desired, see:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">EIB deployed Helm chart upgrades</code> - <a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-third-party" title="30.4.3.3.4. Helm chart upgrade using a third-party GitOps tool">Section 30.4.3.3.4, “Helm chart upgrade using a third-party GitOps tool”</a>.</p></li><li class="listitem"><p>For <code class="literal">non-EIB deployed Helm chart upgrades</code> - retrieve the chart version supported by the desired Edge release from the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="38.1. Abstract">Section 38.1, “Abstract”</a>) page and populate the chart version and URL in your third party GitOps tool.</p></li></ul></div></div><section class="sect2" id="id-components-4" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.4.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-components-4">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Apart from the default <code class="literal">Day 2</code> components (<a class="xref" href="day2-downstream-clusters.html#day2-downstream-components" title="30.1.1. Components">Section 30.1.1, “Components”</a>), no other custom components are needed for this operation.</p></section><section class="sect2" id="id-preparation-for-air-gapped-environments" data-id-title="Preparation for air-gapped environments"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.4.2 </span><span class="title-name">Preparation for air-gapped environments</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-preparation-for-air-gapped-environments">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><section class="sect3" id="id-ensure-that-you-have-access-to-your-helm-chart-upgrade-fleet" data-id-title="Ensure that you have access to your Helm chart upgrade Fleet"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.2.1 </span><span class="title-name">Ensure that you have access to your Helm chart upgrade Fleet</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-ensure-that-you-have-access-to-your-helm-chart-upgrade-fleet">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Depending on what your environment supports, you can take one of the following options:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Host your chart’s Fleet resources on a local Git server that is accessible by your <code class="literal">management cluster</code>.</p></li><li class="listitem"><p>Use Fleet’s CLI to <a class="link" href="https://fleet.rancher.io/bundle-add#convert-a-helm-chart-into-a-bundle" target="_blank">convert a Helm chart into a Bundle</a> that you can directly use and will not need to be hosted somewhere. Fleet’s CLI can be retrieved from their <a class="link" href="https://github.com/rancher/fleet/releases" target="_blank">release</a> page, for Mac users there is a <a class="link" href="https://formulae.brew.sh/formula/fleet-cli" target="_blank">fleet-cli</a> Homebrew Formulae.</p></li></ol></div></section><section class="sect3" id="id-find-the-required-assets-for-your-edge-release-version" data-id-title="Find the required assets for your Edge release version"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.2.2 </span><span class="title-name">Find the required assets for your Edge release version</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-find-the-required-assets-for-your-edge-release-version">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Go to the Day 2 <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> page and find the Edge 3.X.Y release that you want to upgrade your chart to and click <span class="strong"><strong>Assets</strong></span>.</p></li><li class="listitem"><p>From the <span class="strong"><strong>"Assets"</strong></span> section, download the following files:</p><div class="informaltable"><table style="border-collapse: collapse; border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><colgroup><col class="col_1"/><col class="col_2"/></colgroup><tbody><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="strong"><strong>Release File</strong></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p><span class="strong"><strong>Description</strong></span></p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-save-images.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Pulls the images specified in the <code class="literal">edge-release-images.txt</code> file and packages them inside of a '.tar.gz' archive.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-save-oci-artefacts.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Pulls the OCI chart images related to the specific Edge release and packages them inside of a '.tar.gz' archive.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-load-images.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Loads images from a '.tar.gz' archive, retags and pushes them to a private registry.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-load-oci-artefacts.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Takes a directory containing Edge OCI '.tgz' chart packages and loads them to a private registry.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-release-helm-oci-artefacts.txt</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Contains a list of OCI chart images related to a specific Edge release.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; "><p><span class="emphasis"><em>edge-release-images.txt</em></span></p></td><td style="text-align: left; vertical-align: top; "><p>Contains a list of images related to a specific Edge release.</p></td></tr></tbody></table></div></li></ol></div></section><section class="sect3" id="id-create-the-edge-release-images-archive" data-id-title="Create the Edge release images archive"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.2.3 </span><span class="title-name">Create the Edge release images archive</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-create-the-edge-release-images-archive">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On a machine with internet access:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Make <code class="literal">edge-save-images.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-save-images.sh</pre></div></li><li class="listitem"><p>Generate the image archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-save-images.sh --source-registry registry.suse.com</pre></div></li><li class="listitem"><p>This will create a ready to load archive named <code class="literal">edge-images.tar.gz</code>.</p><div id="id-1.7.5.6.4.4.3.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>If the <code class="literal">-i|--images</code> option is specified, the name of the archive may differ.</p></div></li><li class="listitem"><p>Copy this archive to your <span class="strong"><strong>air-gapped</strong></span> machine:</p><div class="verbatim-wrap highlight bash"><pre class="screen">scp edge-images.tar.gz &lt;user&gt;@&lt;machine_ip&gt;:/path</pre></div></li></ol></div></section><section class="sect3" id="id-create-the-edge-oci-chart-images-archive" data-id-title="Create the Edge OCI chart images archive"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.2.4 </span><span class="title-name">Create the Edge OCI chart images archive</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-create-the-edge-oci-chart-images-archive">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On a machine with internet access:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Make <code class="literal">edge-save-oci-artefacts.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-save-oci-artefacts.sh</pre></div></li><li class="listitem"><p>Generate the OCI chart image archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-save-oci-artefacts.sh --source-registry registry.suse.com</pre></div></li><li class="listitem"><p>This will create an archive named <code class="literal">oci-artefacts.tar.gz</code>.</p><div id="id-1.7.5.6.4.5.3.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>If the <code class="literal">-a|--archive</code> option is specified, the name of the archive may differ.</p></div></li><li class="listitem"><p>Copy this archive to your <span class="strong"><strong>air-gapped</strong></span> machine:</p><div class="verbatim-wrap highlight bash"><pre class="screen">scp oci-artefacts.tar.gz &lt;user&gt;@&lt;machine_ip&gt;:/path</pre></div></li></ol></div></section><section class="sect3" id="id-load-edge-release-images-to-your-air-gapped-machine" data-id-title="Load Edge release images to your air-gapped machine"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.2.5 </span><span class="title-name">Load Edge release images to your air-gapped machine</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-load-edge-release-images-to-your-air-gapped-machine">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On your air-gapped machine:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log into your private registry (if required):</p><div class="verbatim-wrap highlight bash"><pre class="screen">podman login &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt;</pre></div></li><li class="listitem"><p>Make <code class="literal">edge-load-images.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-load-images.sh</pre></div></li><li class="listitem"><p>Execute the script, passing the previously <span class="strong"><strong>copied</strong></span> <code class="literal">edge-images.tar.gz</code> archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-load-images.sh --source-registry registry.suse.com --registry &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt; --images edge-images.tar.gz</pre></div><div id="id-1.7.5.6.4.6.3.3.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This will load all images from the <code class="literal">edge-images.tar.gz</code>, retag and push them to the registry specified under the <code class="literal">--registry</code> option.</p></div></li></ol></div></section><section class="sect3" id="id-load-the-edge-oci-chart-images-to-your-air-gapped-machine" data-id-title="Load the Edge OCI chart images to your air-gapped machine"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.2.6 </span><span class="title-name">Load the Edge OCI chart images to your air-gapped machine</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-load-the-edge-oci-chart-images-to-your-air-gapped-machine">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On your air-gapped machine:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log into your private registry (if required):</p><div class="verbatim-wrap highlight bash"><pre class="screen">podman login &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt;</pre></div></li><li class="listitem"><p>Make <code class="literal">edge-load-oci-artefacts.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-load-oci-artefacts.sh</pre></div></li><li class="listitem"><p>Untar the copied <code class="literal">oci-artefacts.tar.gz</code> archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">tar -xvf oci-artefacts.tar.gz</pre></div></li><li class="listitem"><p>This will produce a directory with the naming template <code class="literal">edge-release-oci-tgz-&lt;date&gt;</code></p></li><li class="listitem"><p>Pass this directory to the <code class="literal">edge-load-oci-artefacts.sh</code> script to load the Edge OCI chart images to your private registry:</p><div id="id-1.7.5.6.4.7.3.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This script assumes the <code class="literal">helm</code> CLI has been pre-installed on your environment. For Helm installation instructions, see <a class="link" href="https://helm.sh/docs/intro/install/" target="_blank">Installing Helm</a>.</p></div><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-load-oci-artefacts.sh --archive-directory edge-release-oci-tgz-&lt;date&gt; --registry &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt; --source-registry registry.suse.com</pre></div></li></ol></div></section><section class="sect3" id="id-create-registry-mirrors-pointing-to-your-private-registry-for-your-kubernetes-distribution" data-id-title="Create registry mirrors pointing to your private registry for your Kubernetes distribution"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.2.7 </span><span class="title-name">Create registry mirrors pointing to your private registry for your Kubernetes distribution</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-create-registry-mirrors-pointing-to-your-private-registry-for-your-kubernetes-distribution">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>For RKE2, see <a class="link" href="https://docs.rke2.io/install/containerd_registry_configuration" target="_blank">Containerd Registry Configuration</a></p><p>For K3s, see <a class="link" href="https://docs.k3s.io/installation/registry-mirror" target="_blank">Embedded Registry Mirror</a></p></section></section><section class="sect2" id="id-upgrade-procedure-2" data-id-title="Upgrade procedure"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">30.4.3 </span><span class="title-name">Upgrade procedure</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-upgrade-procedure-2">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section focuses on the following Helm upgrade procedure use-cases:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>I have a new cluster and would like to deploy and manage a SUSE Helm chart (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster" title="30.4.3.1. I have a new cluster and would like to deploy and manage a SUSE Helm chart">Section 30.4.3.1, “I have a new cluster and would like to deploy and manage a SUSE Helm chart”</a>)</p></li><li class="listitem"><p>I would like to upgrade a Fleet managed Helm chart (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-fleet-managed-chart" title="30.4.3.2. I would like to upgrade a Fleet managed Helm chart">Section 30.4.3.2, “I would like to upgrade a Fleet managed Helm chart”</a>)</p></li><li class="listitem"><p>I would like to upgrade an EIB deployed Helm chart (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart" title="30.4.3.3. I would like to upgrade an EIB deployed Helm chart">Section 30.4.3.3, “I would like to upgrade an EIB deployed Helm chart”</a>)</p></li></ol></div><div id="id-1.7.5.6.5.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Manually deployed Helm charts cannot be reliably upgraded. We suggest to redeploy the helm chart using the <a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster" title="30.4.3.1. I have a new cluster and would like to deploy and manage a SUSE Helm chart">Section 30.4.3.1, “I have a new cluster and would like to deploy and manage a SUSE Helm chart”</a> method.</p></div><section class="sect3" id="day2-helm-upgrade-new-cluster" data-id-title="I have a new cluster and would like to deploy and manage a SUSE Helm chart"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.3.1 </span><span class="title-name">I have a new cluster and would like to deploy and manage a SUSE Helm chart</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>For users that want to manage their Helm chart lifecycle through Fleet.</p><p>This section covers how to:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Prepare your Fleet resources (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-prepare-fleet" title="30.4.3.1.1. Prepare your Fleet resources">Section 30.4.3.1.1, “Prepare your Fleet resources”</a>).</p></li><li class="listitem"><p>Deploy your Fleet resources (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-deploy-fleet" title="30.4.3.1.2. Deploy your Fleet">Section 30.4.3.1.2, “Deploy your Fleet”</a>).</p></li><li class="listitem"><p>Manage the deployed Helm chart (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-manage-chart" title="30.4.3.1.3. Managing the deployed Helm chart">Section 30.4.3.1.3, “Managing the deployed Helm chart”</a>).</p></li></ol></div><section class="sect4" id="day2-helm-upgrade-new-cluster-prepare-fleet" data-id-title="Prepare your Fleet resources"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.4.3.1.1 </span><span class="title-name">Prepare your Fleet resources</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-prepare-fleet">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Acquire the Chart’s Fleet resources from the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you wish to use</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>From the selected Edge release tag revision, navigate to the Helm chart fleet - <code class="literal">fleets/day2/chart-templates/&lt;chart&gt;</code></p></li><li class="listitem"><p><span class="strong"><strong>If you intend to use a GitOps workflow</strong></span>, copy the chart Fleet directory to the Git repository from where you will do GitOps.</p></li><li class="listitem"><p><span class="strong"><strong>Optionally</strong></span>, if the Helm chart requires configurations to its <span class="strong"><strong>values</strong></span>, edit the <code class="literal">.helm.values</code> configuration inside the <code class="literal">fleet.yaml</code> file of the copied directory.</p></li><li class="listitem"><p><span class="strong"><strong>Optionally</strong></span>, there may be use-cases where you need to add additional resources to your chart’s fleet so that it can better fit your environment. For information on how to enhance your Fleet directory, see <a class="link" href="https://fleet.rancher.io/gitrepo-content" target="_blank">Git Repository Contents</a>.</p></li></ol></div></li></ol></div><p>An <span class="strong"><strong>example</strong></span> for the <code class="literal">longhorn</code> helm chart would look like:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>User Git repository structure:</p><div class="verbatim-wrap highlight bash"><pre class="screen">&lt;user_repository_root&gt;
├── longhorn
│   └── fleet.yaml
└── longhorn-crd
    └── fleet.yaml</pre></div></li><li class="listitem"><p><code class="literal">fleet.yaml</code> content populated with user <code class="literal">longhorn</code> data:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">defaultNamespace: longhorn-system

helm:
  releaseName: "longhorn"
  chart: "longhorn"
  repo: "https://charts.rancher.io/"
  version: "104.2.0+up1.7.1"
  takeOwnership: true
  # custom chart value overrides
  values:
    # Example for user provided custom values content
    defaultSettings:
      deletingConfirmationFlag: true

# https://fleet.rancher.io/bundle-diffs
diff:
  comparePatches:
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: engineimages.longhorn.io
    operations:
    - {"op":"remove", "path":"/status/conditions"}
    - {"op":"remove", "path":"/status/storedVersions"}
    - {"op":"remove", "path":"/status/acceptedNames"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: nodes.longhorn.io
    operations:
    - {"op":"remove", "path":"/status/conditions"}
    - {"op":"remove", "path":"/status/storedVersions"}
    - {"op":"remove", "path":"/status/acceptedNames"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: volumes.longhorn.io
    operations:
    - {"op":"remove", "path":"/status/conditions"}
    - {"op":"remove", "path":"/status/storedVersions"}
    - {"op":"remove", "path":"/status/acceptedNames"}</pre></div><div id="id-1.7.5.6.5.5.5.4.2.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>These are just example values that are used to illustrate custom configurations over the <code class="literal">longhorn</code> chart. They should <span class="strong"><strong>NOT</strong></span> be treated as deployment guidelines for the <code class="literal">longhorn</code> chart.</p></div></li></ul></div></section><section class="sect4" id="day2-helm-upgrade-new-cluster-deploy-fleet" data-id-title="Deploy your Fleet"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.4.3.1.2 </span><span class="title-name">Deploy your Fleet</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-deploy-fleet">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>If the environment supports working with a GitOps workflow, you can deploy your Chart Fleet by either using a GitRepo (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-deploy-fleet-gitrepo" title="30.4.3.1.2.1. GitRepo">Section 30.4.3.1.2.1, “GitRepo”</a>) or Bundle (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-deploy-fleet-bundle" title="30.4.3.1.2.2. Bundle">Section 30.4.3.1.2.2, “Bundle”</a>).</p><div id="id-1.7.5.6.5.5.6.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>While deploying your Fleet, if you get a <code class="literal">Modified</code> message, make sure to add a corresponding <code class="literal">comparePatches</code> entry to the Fleet’s <code class="literal">diff</code> section. For more information, see <a class="link" href="https://fleet.rancher.io/bundle-diffs" target="_blank">Generating Diffs to Ignore Modified GitRepos</a>.</p></div><section class="sect5" id="day2-helm-upgrade-new-cluster-deploy-fleet-gitrepo" data-id-title="GitRepo"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">30.4.3.1.2.1 </span><span class="title-name">GitRepo</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-deploy-fleet-gitrepo">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Fleet’s <a class="link" href="https://fleet.rancher.io/ref-gitrepo" target="_blank">GitRepo</a> resource holds information on how to access your chart’s Fleet resources and to which clusters it needs to apply those resources.</p><p>The <code class="literal">GitRepo</code> resource can be deployed through the <a class="link" href="https://ranchermanager.docs.rancher.com/v2.9/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">Rancher UI</a>, or manually, by <a class="link" href="https://fleet.rancher.io/tut-deployment" target="_blank">deploying</a> the resource to the <code class="literal">management cluster</code>.</p><p><span class="emphasis"><em>Example <span class="strong"><strong>Longhorn</strong></span> <code class="literal">GitRepo</code> resource for <span class="strong"><strong>manual</strong></span> deployment:</em></span></p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: fleet.cattle.io/v1alpha1
kind: GitRepo
metadata:
  name: longhorn-git-repo
  namespace: fleet-default
spec:
  # If using a tag
  # revision: &lt;user_repository_tag&gt;
  #
  # If using a branch
  # branch: &lt;user_repository_branch&gt;
  paths:
  # As seen in the 'Prepare your Fleet resources' example
  - longhorn
  - longhorn-crd
  repo: &lt;user_repository_url&gt;
  targets:
  # Match all clusters
  - clusterSelector: {}</pre></div></section><section class="sect5" id="day2-helm-upgrade-new-cluster-deploy-fleet-bundle" data-id-title="Bundle"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">30.4.3.1.2.2 </span><span class="title-name">Bundle</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-deploy-fleet-bundle">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><a class="link" href="https://fleet.rancher.io/bundle-add" target="_blank">Bundle</a> resources hold the raw Kubernetes resources that need to be deployed by Fleet. Normally it is encouraged to use the <code class="literal">GitRepo</code> approach, but for use-cases where the environment is air-gapped and cannot support a local Git server, <code class="literal">Bundles</code> can help you in propagating your Helm chart Fleet to your target clusters.</p><p>The <code class="literal">Bundle</code> can be deployed either through the Rancher UI (<code class="literal">Continuous Delivery → Advanced → Bundles → Create from YAML</code>) or by manually deploying the <code class="literal">Bundle</code> resource in the correct Fleet namespace. For information about Fleet namespaces, see the upstream <a class="link" href="https://fleet.rancher.io/namespaces#gitrepos-bundles-clusters-clustergroups" target="_blank">documentation</a>.</p><p><span class="emphasis"><em>Example <span class="strong"><strong>Longhorn</strong></span> <code class="literal">Bundle</code> resource deployment using a <span class="strong"><strong>manual</strong></span> approach:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Navigate to the <code class="literal">Longhorn</code> Chart fleet located under <code class="literal">fleets/day2/chart-templates/longhorn/longhorn</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd fleets/day2/chart-templates/longhorn/longhorn</pre></div></li><li class="listitem"><p>Create a <code class="literal">targets.yaml</code> file that will instruct Fleet to which clusters it should deploy the Helm chart. In this case, we will deploy to a single downstream cluster. For information on how to map more complex targets, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; targets.yaml &lt;&lt;EOF
targets:
- clusterName: foo
EOF</pre></div></li><li class="listitem"><p>Convert the <code class="literal">Longhorn</code> Helm chart Fleet to a Bundle resource. For more information, see <a class="link" href="https://fleet.rancher.io/bundle-add#convert-a-helm-chart-into-a-bundle" target="_blank">Convert a Helm Chart into a Bundle</a>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">fleet apply --compress --targets-file=targets.yaml -n fleet-default -o - longhorn-bundle &gt; longhorn-bundle.yaml</pre></div></li><li class="listitem"><p>Navigate to the <code class="literal">Longhorn CRD</code> Chart fleet located under <code class="literal">fleets/day2/chart-templates/longhorn/longhorn-crd</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd fleets/day2/chart-templates/longhorn/longhorn-crd</pre></div></li><li class="listitem"><p>Create a <code class="literal">targets.yaml</code> file that will instruct Fleet to which clusters it should deploy the Helm chart. In this case, we will deploy to a single downstream cluster. For information on how to map more complex targets, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; targets.yaml &lt;&lt;EOF
targets:
- clusterName: foo
EOF</pre></div></li><li class="listitem"><p>Convert the <code class="literal">Longhorn CRD</code> Helm chart Fleet to a Bundle resource. For more information, see <a class="link" href="https://fleet.rancher.io/bundle-add#convert-a-helm-chart-into-a-bundle" target="_blank">Convert a Helm Chart into a Bundle</a>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">fleet apply --compress --targets-file=targets.yaml -n fleet-default -o - longhorn-crd-bundle &gt; longhorn-crd-bundle.yaml</pre></div></li><li class="listitem"><p>Deploy <code class="literal">longhorn-bundle.yaml</code> and <code class="literal">longhorn-crd-bundle.yaml</code> to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f longhorn-crd-bundle.yaml
kubectl apply -f longhorn-bundle.yaml</pre></div></li></ol></div><p>Following these steps will ensure that <code class="literal">Longhorn</code> is deployed on all of the specified target clusters.</p></section></section><section class="sect4" id="day2-helm-upgrade-new-cluster-manage-chart" data-id-title="Managing the deployed Helm chart"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.4.3.1.3 </span><span class="title-name">Managing the deployed Helm chart</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-new-cluster-manage-chart">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Once deployed with Fleet, for Helm chart upgrades, see <a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-fleet-managed-chart" title="30.4.3.2. I would like to upgrade a Fleet managed Helm chart">Section 30.4.3.2, “I would like to upgrade a Fleet managed Helm chart”</a>.</p></section></section><section class="sect3" id="day2-helm-upgrade-fleet-managed-chart" data-id-title="I would like to upgrade a Fleet managed Helm chart"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.3.2 </span><span class="title-name">I would like to upgrade a Fleet managed Helm chart</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-fleet-managed-chart">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Determine the version to which you need to upgrade your chart so that it is compatible with the desired Edge release. Helm chart version per Edge release can be viewed from the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="38.1. Abstract">Section 38.1, “Abstract”</a>).</p></li><li class="listitem"><p>In your Fleet monitored Git repository, edit the Helm chart’s <code class="literal">fleet.yaml</code> file with the correct chart <span class="strong"><strong>version</strong></span> and <span class="strong"><strong>repository</strong></span> from the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="38.1. Abstract">Section 38.1, “Abstract”</a>).</p></li><li class="listitem"><p>After committing and pushing the changes to your repository, this will trigger an upgrade of the desired Helm chart</p></li></ol></div></section><section class="sect3" id="day2-helm-upgrade-eib-chart" data-id-title="I would like to upgrade an EIB deployed Helm chart"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">30.4.3.3 </span><span class="title-name">I would like to upgrade an EIB deployed Helm chart</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>EIB deploys Helm charts by creating a <code class="literal">HelmChart</code> resource and utilizing the <code class="literal">helm-controller</code> introduced by the <a class="link" href="https://docs.rke2.io/helm" target="_blank">RKE2</a>/<a class="link" href="https://docs.k3s.io/helm" target="_blank">K3s</a> Helm integration feature.</p><p>To ensure that an EIB deployed Helm chart is successfully upgraded, users need to do an upgrade over the <code class="literal">HelmChart</code> resources created for the Helm chart by EIB.</p><p>Below you can find information on:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The general overview (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-overview" title="30.4.3.3.1. Overview">Section 30.4.3.3.1, “Overview”</a>) of the EIB deployed Helm chart upgrade process.</p></li><li class="listitem"><p>The necessary upgrade steps (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="30.4.3.3.2. Upgrade Steps">Section 30.4.3.3.2, “Upgrade Steps”</a>) needed for a successful EIB deployed Helm chart upgrade.</p></li><li class="listitem"><p>An example (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-example" title="30.4.3.3.3. Example">Section 30.4.3.3.3, “Example”</a>) showcasing a <a class="link" href="https://longhorn.io" target="_blank">Longhorn</a> chart upgrade using the explained method.</p></li><li class="listitem"><p>How to use the upgrade process with a different GitOps tool (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-third-party" title="30.4.3.3.4. Helm chart upgrade using a third-party GitOps tool">Section 30.4.3.3.4, “Helm chart upgrade using a third-party GitOps tool”</a>).</p></li></ul></div><section class="sect4" id="day2-helm-upgrade-eib-chart-overview" data-id-title="Overview"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.4.3.3.1 </span><span class="title-name">Overview</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-overview">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section is meant to give a high overview of the steps that need to be taken in order to upgrade one or multiple Helm charts that have been deployed by EIB. For a detailed explanation of the steps needed for a Helm chart upgrade, see <a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="30.4.3.3.2. Upgrade Steps">Section 30.4.3.3.2, “Upgrade Steps”</a>.</p><div class="figure" id="id-1.7.5.6.5.7.6.3"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_diagram.png"><img src="images/day2_helm_chart_upgrade_diagram.png" width="NaN" alt="day2 helm chart upgrade diagram" title="day2 helm chart upgrade diagram"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.3: </span><span class="title-name">Helm chart upgrade workflow </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.6.3">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>The workflow begins with the user <a class="link" href="https://helm.sh/docs/helm/helm_pull/" target="_blank">pulling</a> the new Helm chart archive(s) that he wishes to upgrade his chart(s) to.</p></li><li class="listitem"><p>The archive(s) should then be placed in a directory that will be processed by the <code class="literal">generate-chart-upgrade-data.sh</code> script.</p></li><li class="listitem"><p>The user then proceeds to execute the <code class="literal">generate-chart-upgrade-data.sh</code> script which will generate a Kubernetes <a class="link" href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank">Secret</a> YAML file for each Helm chart archive in the provided archive directory. These secrets will be automatically placed under the Fleet that will be used to upgrade the Helm charts. This is further explained in the upgrade steps (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="30.4.3.3.2. Upgrade Steps">Section 30.4.3.3.2, “Upgrade Steps”</a>) section.</p></li><li class="listitem"><p>After the script finishes successfully, the user should continue to the configuration and deployment of either a <code class="literal">Bundle</code> or a <code class="literal">GitRepo</code> resource that will ship all the needed K8s resources to the target clusters.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>The resource is deployed on the <code class="literal">management cluster</code> under the <code class="literal">fleet-default</code> namespace.</p></li></ol></div></li><li class="listitem"><p>Fleet (<a class="xref" href="components-fleet.html" title="Chapter 7. Fleet">Chapter 7, <em>Fleet</em></a>) detects the deployed resource, parses its data and deploys its resources to the specified target clusters. The most notable resources that are deployed are:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><code class="literal">eib-charts-upgrader</code> - a Job that deploys the <code class="literal">Chart Upgrade Pod</code>. The <code class="literal">eib-charts-upgrader-script</code> as well as all <code class="literal">helm chart upgrade data</code> secrets are mounted inside of the <code class="literal">Chart Upgrade Pod</code>.</p></li><li class="listitem"><p><code class="literal">eib-charts-upgrader-script</code> - a Secret shipping the script that will be used by the <code class="literal">Chart Upgrade Pod</code> to patch an existing <code class="literal">HelmChart</code> resource.</p></li><li class="listitem"><p><code class="literal">Helm chart upgrade data</code> secrets - Secret YAML files created by the <code class="literal">generate-chart-upgrade-data.sh</code> script based on the user provided data. <span class="strong"><strong>Secret YAML files should not be edited.</strong></span></p></li></ol></div></li><li class="listitem"><p>Once the <code class="literal">Chart Upgrade Pod</code> has been deployed, the script from the <code class="literal">eib-charts-upgrader-script</code> secret is executed, which does the following:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Process all the Helm chart upgrade data provided by the other secrets.</p></li><li class="listitem"><p>Check if there is a <code class="literal">HelmChart</code> resource for each of the provided chart upgrade data.</p></li><li class="listitem"><p>Proceed to patch the <code class="literal">HelmChart</code> resource with the data provided from the secret for the corresponding Helm chart.</p></li></ol></div></li><li class="listitem"><p>RKE2/K3s helm-controller constantly monitors for edits over the existing <code class="literal">HelmChart</code> resource. It detects the patch of the <code class="literal">HelmChart</code>, reconciles the changes and then proceeds to upgrade the chart behind the <code class="literal">HelmChart</code> resource.</p></li></ol></div></section><section class="sect4" id="day2-helm-upgrade-eib-chart-upgrade-steps" data-id-title="Upgrade Steps"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.4.3.3.2 </span><span class="title-name">Upgrade Steps</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Clone the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> repository from the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release tag</a> that you wish to use.</p></li><li class="listitem"><p>Create a directory in which you will store the pulled Helm chart archive(s).</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir archives</pre></div></li><li class="listitem"><p>Inside of the newly created archive directory, <a class="link" href="https://helm.sh/docs/helm/helm_pull/" target="_blank">pull</a> the Helm chart archive(s) that you wish to upgrade to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd archives
helm pull [chart URL | repo/chartname]

# Alternatively if you want to pull a specific version:
# helm pull [chart URL | repo/chartname] --version 0.0.0</pre></div></li><li class="listitem"><p>From the desired <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release tag</a> download the <code class="literal">generate-chart-upgrade-data.sh</code> script.</p></li><li class="listitem"><p>Execute the <code class="literal">generate-chart-upgrade-data.sh</code> script:</p><div id="id-1.7.5.6.5.7.7.2.5.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Users should not make any changes over what the <code class="literal">generate-chart-upgrade-data.sh</code> script generates.</p></div><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x ./generate-chart-upgrade-data.sh

./generate-chart-upgrade-data.sh --archive-dir /foo/bar/archives/ --fleet-path /foo/bar/fleet-examples/fleets/day2/eib-charts-upgrader</pre></div><p>The script will go through the following logic:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Validate that the user has provided <code class="literal">--fleet-path</code> points to a valid Fleet that can initiate a Helm chart upgrade.</p></li><li class="listitem"><p>Process all Helm chart archives from the user-created archives dir (e.g. <code class="literal">/foo/bar/archives/</code>).</p></li><li class="listitem"><p>For each Helm chart archive create a <code class="literal">Kubernetes Secret YAML</code> resource. This resource will hold:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>The <code class="literal">name</code> of the <code class="literal">HelmChart</code> resource that needs to be patched.</p></li><li class="listitem"><p>The new <code class="literal">version</code> for the <code class="literal">HelmChart</code> resource.</p></li><li class="listitem"><p>The <code class="literal">base64</code> encoded Helm chart archive that will be used to replace the <code class="literal">HelmChart’s</code> currently running configuration.</p></li></ol></div></li><li class="listitem"><p>Each <code class="literal">Kubernetes Secret YAML</code> resource will be transferred to the <code class="literal">base/secrets</code> directory inside of the path to the <code class="literal">eib-charts-upgrader</code> Fleet that was given under <code class="literal">--fleet-path</code>.</p></li><li class="listitem"><p>Furthermore the <code class="literal">generate-chart-upgrade-data.sh</code> script ensures that the secrets that it moved will be picked up and used in the Helm chart upgrade logic. It does that by:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>Editing the <code class="literal">base/secrets/kustomization.yaml</code> file to include the newly added resources.</p></li><li class="listitem"><p>Edit the <code class="literal">base/patches/job-patch.yaml</code> file to include the newly added secrets to the mount configurations.</p></li></ol></div></li></ol></div></li><li class="listitem"><p>After a successful <code class="literal">generate-chart-upgrade-data.sh</code> run you should have the changes inside of the following directories of the <code class="literal">suse-edge/fleet-examples</code> repository:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><code class="literal">fleets/day2/eib-charts-upgrader/base/patches</code></p></li><li class="listitem"><p><code class="literal">fleets/day2/eib-charts-upgrader/base/secrets</code></p></li></ol></div></li></ol></div><p>The steps below depend on the environment that you are running:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>For an environment that supports GitOps (e.g. is non air-gapped, or is air-gapped, but allows for local Git server support):</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Copy the <code class="literal">fleets/day2/eib-charts-upgrader</code> Fleet to the repository that you will use for GitOps. Make sure that the Fleet includes the changes that have been made by the <code class="literal">generate-chart-upgrade-data.sh</code> script.</p></li><li class="listitem"><p>Configure a <code class="literal">GitRepo</code> resource that will be used to ship all the resources of the <code class="literal">eib-charts-upgrader</code> Fleet.</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>For <code class="literal">GitRepo</code> configuration and deployment through the Rancher UI, see <a class="link" href="https://ranchermanager.docs.rancher.com/v2.9/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">Accessing Fleet in the Rancher UI</a>.</p></li><li class="listitem"><p>For <code class="literal">GitRepo</code> manual configuration and deployment, see <a class="link" href="https://fleet.rancher.io/tut-deployment" target="_blank">Creating a Deployment</a>.</p></li></ol></div></li></ol></div></li><li class="listitem"><p>For an environment that does not support GitOps (e.g. is air-gapped and does not allow local Git server usage):</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Download the <code class="literal">fleet-cli</code> binary from the <code class="literal">rancher/fleet</code> <a class="link" href="https://github.com/rancher/fleet/releases" target="_blank">releases</a> page. For Mac users, there is a Homebrew Formulae that can be used - <a class="link" href="https://formulae.brew.sh/formula/fleet-cli" target="_blank">fleet-cli</a>.</p></li><li class="listitem"><p>Navigate to the <code class="literal">eib-charts-upgrader</code> Fleet:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd /foo/bar/fleet-examples/fleets/day2/eib-charts-upgrader</pre></div></li><li class="listitem"><p>Create a <code class="literal">targets.yaml</code> file that will instruct Fleet where to deploy your resources:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; targets.yaml &lt;&lt;EOF
targets:
- clusterSelector: {} # Change this with your target data
EOF</pre></div><p>For information on how to map target clusters, see the upstream <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">documentation</a>.</p></li><li class="listitem"><p>Use the <code class="literal">fleet-cli</code> to convert the Fleet to a <code class="literal">Bundle</code> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">fleet apply --compress --targets-file=targets.yaml -n fleet-default -o - eib-charts-upgrade &gt; bundle.yaml</pre></div><p>This will create a Bundle (<code class="literal">bundle.yaml</code>) that will hold all the templated resource from the <code class="literal">eib-charts-upgrader</code> Fleet.</p><p>For more information regarding the <code class="literal">fleet apply</code> command, see <a class="link" href="https://fleet.rancher.io/cli/fleet-cli/fleet_apply" target="_blank">fleet apply</a>.</p><p>For more information regarding converting Fleets to Bundles, see <a class="link" href="https://fleet.rancher.io/bundle-add#convert-a-helm-chart-into-a-bundle" target="_blank">Convert a Helm Chart into a Bundle</a>.</p></li><li class="listitem"><p>Deploy the <code class="literal">Bundle</code>. This can be done in one of two ways:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>Through Rancher’s UI - Navigate to <span class="strong"><strong>Continuous Delivery → Advanced → Bundles → Create from YAML</strong></span> and either paste the <code class="literal">bundle.yaml</code> contents, or click the <code class="literal">Read from File</code> option and pass the file itself.</p></li><li class="listitem"><p>Manually - Deploy the <code class="literal">bundle.yaml</code> file manually inside of your <code class="literal">management cluster</code>.</p></li></ol></div></li></ol></div></li></ol></div><p>Executing these steps will result in a successfully deployed <code class="literal">GitRepo/Bundle</code> resource. The resource will be picked up by Fleet and its contents will be deployed onto the target clusters that the user has specified in the previous steps. For an overview of the process, refer to the overview (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-overview" title="30.4.3.3.1. Overview">Section 30.4.3.3.1, “Overview”</a>) section.</p><p>For information on how to track the upgrade process, you can refer to the Example (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-example" title="30.4.3.3.3. Example">Section 30.4.3.3.3, “Example”</a>) section of this documentation.</p><div id="id-1.7.5.6.5.7.7.7" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Once the chart upgrade has been successfully verified, remove the <code class="literal">Bundle/GitRepo</code> resource.</p><p>This will remove the no longer necessary upgrade resources from your downstream cluster, ensuring that no future version clashes might occur.</p></div></section><section class="sect4" id="day2-helm-upgrade-eib-chart-example" data-id-title="Example"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.4.3.3.3 </span><span class="title-name">Example</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-example">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.5.6.5.7.8.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The example below illustrates how to do an upgrade of an EIB deployed Helm chart from one version to another. The versions in the example should <span class="strong"><strong>not</strong></span> be treated as version recommendations. Version recommendations for a specific Edge release, should be taken from the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="38.1. Abstract">Section 38.1, “Abstract”</a>).</p></div><p><span class="emphasis"><em>Use-case:</em></span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A cluster named <code class="literal">doc-example</code> is running Ranchers' <a class="link" href="https://longhorn.io" target="_blank">Longhorn</a> <code class="literal">103.3.0+up1.6.1</code> version.</p></li><li class="listitem"><p>The cluster has been deployed through EIB, using the following image definition <span class="emphasis"><em>snippet</em></span>:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kubernetes:
  helm:
    charts:
    - name: longhorn-crd
      repositoryName: rancher-charts
      targetNamespace: longhorn-system
      createNamespace: true
      version: 103.3.0+up1.6.1
    - name: longhorn
      repositoryName: rancher-charts
      targetNamespace: longhorn-system
      createNamespace: true
      version: 103.3.0+up1.6.1
    repositories:
    - name: rancher-charts
      url: https://charts.rancher.io/
...</pre></div><div class="figure" id="id-1.7.5.6.5.7.8.4.2.3"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_1.png"><img src="images/day2_helm_chart_upgrade_example_1.png" width="NaN" alt="day2 helm chart upgrade example 1" title="day2 helm chart upgrade example 1"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.4: </span><span class="title-name">doc-example installed Longhorn version </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.8.4.2.3">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li><li class="listitem"><p><code class="literal">Longhorn</code> needs to be upgraded to a version that is compatible with the Edge 3.1 release. Meaning it needs to be upgraded to <code class="literal">104.2.0+up1.7.1</code>.</p></li><li class="listitem"><p>It is assumed that the <code class="literal">management cluster</code> in charge of managing the <code class="literal">doc-example</code> cluster is <span class="strong"><strong>air-gapped</strong></span>, without support for a local Git server and has a working Rancher setup.</p></li></ul></div><p>Follow the Upgrade Steps (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="30.4.3.3.2. Upgrade Steps">Section 30.4.3.3.2, “Upgrade Steps”</a>):</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Clone the <code class="literal">suse-edge/fleet-example</code> repository from the <code class="literal">release-3.1.1</code> tag.</p><div class="verbatim-wrap highlight bash"><pre class="screen">git clone -b release-3.1.1 https://github.com/suse-edge/fleet-examples.git</pre></div></li><li class="listitem"><p>Create a directory where the <code class="literal">Longhorn</code> upgrade archive will be stored.</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir archives</pre></div></li><li class="listitem"><p>Pull the desired <code class="literal">Longhorn</code> chart archive version:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># First add the Rancher Helm chart repository
helm repo add rancher-charts https://charts.rancher.io/

# Pull the Longhorn 1.7.1 CRD archive
helm pull rancher-charts/longhorn-crd --version 104.2.0+up1.7.1

# Pull the Longhorn 1.7.1 chart archive
helm pull rancher-charts/longhorn --version 104.2.0+up1.7.1</pre></div></li><li class="listitem"><p>Outside of the <code class="literal">archives</code> directory, download the <code class="literal">generate-chart-upgrade-data.sh</code> script from the <code class="literal">release-3.1.1</code> release tag.</p></li><li class="listitem"><p>Directory setup should look similar to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">.
├── archives
|   ├── longhorn-104.2.0+up1.7.1.tgz
│   └── longhorn-crd-104.2.0+up1.7.1.tgz
├── fleet-examples
...
│   ├── fleets
│   │   ├── day2
|   |   |   ├── ...
│   │   │   ├── eib-charts-upgrader
│   │   │   │   ├── base
│   │   │   │   │   ├── job.yaml
│   │   │   │   │   ├── kustomization.yaml
│   │   │   │   │   ├── patches
│   │   │   │   │   │   └── job-patch.yaml
│   │   │   │   │   ├── rbac
│   │   │   │   │   │   ├── cluster-role-binding.yaml
│   │   │   │   │   │   ├── cluster-role.yaml
│   │   │   │   │   │   ├── kustomization.yaml
│   │   │   │   │   │   └── sa.yaml
│   │   │   │   │   └── secrets
│   │   │   │   │       ├── eib-charts-upgrader-script.yaml
│   │   │   │   │       └── kustomization.yaml
│   │   │   │   ├── fleet.yaml
│   │   │   │   └── kustomization.yaml
│   │   │   └── ...
│   └── ...
└── generate-chart-upgrade-data.sh</pre></div></li><li class="listitem"><p>Execute the <code class="literal">generate-chart-upgrade-data.sh</code> script:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># First make the script executable
chmod +x ./generate-chart-upgrade-data.sh

# Then execute the script
./generate-chart-upgrade-data.sh --archive-dir ./archives --fleet-path ./fleet-examples/fleets/day2/eib-charts-upgrader</pre></div><p>The directory structure after the script execution should look similar to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">.
├── archives
|   ├── longhorn-104.2.0+up1.7.1.tgz
│   └── longhorn-crd-104.2.0+up1.7.1.tgz
├── fleet-examples
...
│   ├── fleets
│   │   ├── day2
│   │   │   ├── ...
│   │   │   ├── eib-charts-upgrader
│   │   │   │   ├── base
│   │   │   │   │   ├── job.yaml
│   │   │   │   │   ├── kustomization.yaml
│   │   │   │   │   ├── patches
│   │   │   │   │   │   └── job-patch.yaml
│   │   │   │   │   ├── rbac
│   │   │   │   │   │   ├── cluster-role-binding.yaml
│   │   │   │   │   │   ├── cluster-role.yaml
│   │   │   │   │   │   ├── kustomization.yaml
│   │   │   │   │   │   └── sa.yaml
│   │   │   │   │   └── secrets
│   │   │   │   │       ├── eib-charts-upgrader-script.yaml
│   │   │   │   │       ├── kustomization.yaml
│   │   │   │   │       ├── longhorn-104-2-0-up1-7-1.yaml &lt;- secret created by the generate-chart-upgrade-data.sh script
│   │   │   │   │       └── longhorn-crd-104-2-0-up1-7-1.yaml &lt;- secret created by the generate-chart-upgrade-data.sh script
│   │   │   │   ├── fleet.yaml
│   │   │   │   └── kustomization.yaml
│   │   │   └── ...
│   └── ...
└── generate-chart-upgrade-data.sh</pre></div><p>The files changed in git should look like this:</p><div class="figure" id="id-1.7.5.6.5.7.8.6.6.6"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_2.png"><img src="images/day2_helm_chart_upgrade_example_2.png" width="NaN" alt="day2 helm chart upgrade example 2" title="day2 helm chart upgrade example 2"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.5: </span><span class="title-name">Changes over fleet-examples made by generate-chart-upgrade-data.sh </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.8.6.6.6">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li><li class="listitem"><p>Since the <code class="literal">management cluster</code> does not support for a GitOps workflow, a <code class="literal">Bundle</code> needs to be created for the <code class="literal">eib-charts-upgrader</code> Fleet:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>First, navigate to the Fleet itself:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd ./fleet-examples/fleets/day2/eib-charts-upgrader</pre></div></li><li class="listitem"><p>Then create a <code class="literal">targets.yaml</code> file targeting the <code class="literal">doc-example</code> cluster:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; targets.yaml &lt;&lt;EOF
targets:
- clusterName: doc-example
EOF</pre></div></li><li class="listitem"><p>Then use the <code class="literal">fleet-cli</code> binary to convert the Fleet to a Bundle:</p><div class="verbatim-wrap highlight bash"><pre class="screen">fleet apply --compress --targets-file=targets.yaml -n fleet-default -o - eib-charts-upgrade &gt; bundle.yaml</pre></div></li><li class="listitem"><p>Now, transfer the <code class="literal">bundle.yaml</code> on your <code class="literal">management cluster</code> machine.</p></li></ol></div></li><li class="listitem"><p>Since the <code class="literal">management cluster</code> is running <code class="literal">Rancher</code>, deploy the Bundle through the Rancher UI:</p><div class="figure" id="id-1.7.5.6.5.7.8.6.8.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_3.png"><img src="images/day2_helm_chart_upgrade_example_3.png" width="NaN" alt="day2 helm chart upgrade example 3" title="day2 helm chart upgrade example 3"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.6: </span><span class="title-name">Deploy Bundle through Rancher UI </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.8.6.8.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>From here, select <span class="strong"><strong>Read from File</strong></span> and find the <code class="literal">bundle.yaml</code> file on your system.</p><p>This will auto-populate the <code class="literal">Bundle</code> inside of Rancher’s UI:</p><div class="figure" id="id-1.7.5.6.5.7.8.6.8.5"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_4.png"><img src="images/day2_helm_chart_upgrade_example_4.png" width="NaN" alt="day2 helm chart upgrade example 4" title="day2 helm chart upgrade example 4"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.7: </span><span class="title-name">Auto-populated Bundle snippet </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.8.6.8.5">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>Select <span class="strong"><strong>Create</strong></span>.</p></li><li class="listitem"><p>After a successful deployment, your Bundle would look similar to:</p><div class="figure" id="id-1.7.5.6.5.7.8.6.9.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_5.png"><img src="images/day2_helm_chart_upgrade_example_5.png" width="NaN" alt="day2 helm chart upgrade example 5" title="day2 helm chart upgrade example 5"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.8: </span><span class="title-name">Successfully deployed Bundle </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.8.6.9.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li></ol></div><p>After the successful deployment of the <code class="literal">Bundle</code>, to monitor the upgrade process:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>First, verify the logs of the <code class="literal">Upgrade Pod</code>:</p><div class="figure" id="id-1.7.5.6.5.7.8.8.1.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_6.png"><img src="images/day2_helm_chart_upgrade_example_6.png" width="NaN" alt="day2 helm chart upgrade example 6" title="day2 helm chart upgrade example 6"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.9: </span><span class="title-name">View the upgrade pod logs </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.8.8.1.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li><li class="listitem"><p>Now verify the logs of the Pod created for the upgrade by the helm-controller:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>The Pod name will be with the following template - <code class="literal">helm-install-longhorn-&lt;random-suffix&gt;</code></p></li><li class="listitem"><p>The Pod will be in the namespace where the <code class="literal">HelmChart</code> resource was deployed. In our case this is <code class="literal">default</code>.</p><div class="figure" id="id-1.7.5.6.5.7.8.8.2.2.2.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_8.png"><img src="images/day2_helm_chart_upgrade_example_8.png" width="NaN" alt="day2 helm chart upgrade example 8" title="day2 helm chart upgrade example 8"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.10: </span><span class="title-name">Logs for successfully upgraded Longhorn chart </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.8.8.2.2.2.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li></ol></div></li><li class="listitem"><p>Check that the HelmChart version has been bumped:</p><div class="figure" id="id-1.7.5.6.5.7.8.8.3.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_9.png"><img src="images/day2_helm_chart_upgrade_example_9.png" width="NaN" alt="day2 helm chart upgrade example 9" title="day2 helm chart upgrade example 9"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.11: </span><span class="title-name">Bumped Longhorn version </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.8.8.3.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li><li class="listitem"><p>Finally check that the Longhorn Pods are running:</p><div class="figure" id="id-1.7.5.6.5.7.8.8.4.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_10.png"><img src="images/day2_helm_chart_upgrade_example_10.png" width="NaN" alt="day2 helm chart upgrade example 10" title="day2 helm chart upgrade example 10"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 30.12: </span><span class="title-name">Example for validating the instance-manager pod </span></span><a title="Permalink" class="permalink" href="day2-downstream-clusters.html#id-1.7.5.6.5.7.8.8.4.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li></ol></div><p>After making the above validations, it is safe to assume that the Longhorn Helm chart has been upgraded from <code class="literal">103.3.0+up1.6.1</code> to <code class="literal">104.2.0+up1.7.1</code>.</p></section><section class="sect4" id="day2-helm-upgrade-eib-chart-third-party" data-id-title="Helm chart upgrade using a third-party GitOps tool"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">30.4.3.3.4 </span><span class="title-name">Helm chart upgrade using a third-party GitOps tool</span></span> <a title="Permalink" class="permalink" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-third-party">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>There might be use-cases where users would like to use this upgrade procedure with a GitOps workflow other than Fleet (e.g. <code class="literal">Flux</code>).</p><p>To produce the resources needed for the upgrade procedure, you can use the <code class="literal">generate-chart-upgrade-data.sh</code> script to populate the <code class="literal">eib-charts-upgrader</code> Fleet with the user provided data. For more information on how to do this, see the upgrade steps (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="30.4.3.3.2. Upgrade Steps">Section 30.4.3.3.2, “Upgrade Steps”</a>).</p><p>After you have the full setup, you can use <a class="link" href="https://kustomize.io" target="_blank">kustomize</a> to generate a full working solution that you can deploy in your cluster:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd /foo/bar/fleets/day2/eib-charts-upgrader

kustomize build .</pre></div><p>If you want to include the solution to your GitOps workflow, you can remove the <code class="literal">fleet.yaml</code> file and use what is left as a valid <code class="literal">Kustomize</code> setup. Just do not forget to first run the <code class="literal">generate-chart-upgrade-data.sh</code> script, so that it can populate the <code class="literal">Kustomize</code> setup with the data for the Helm charts that you wish to upgrade to.</p><p>To understand how this workflow is intended to be used, it can be beneficial to look at the overview (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-overview" title="30.4.3.3.1. Overview">Section 30.4.3.3.1, “Overview”</a>) and upgrade steps (<a class="xref" href="day2-downstream-clusters.html#day2-helm-upgrade-eib-chart-upgrade-steps" title="30.4.3.3.2. Upgrade Steps">Section 30.4.3.3.2, “Upgrade Steps”</a>) sections as well.</p></section></section></section></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="day2-mgmt-cluster.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Chapter 29 </span>Management Cluster</span></a> </div><div><a class="pagination-link next" href="id-product-documentation.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Part VI </span>Product Documentation</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="section"><a href="day2-downstream-clusters.html#id-introduction"><span class="title-number">30.1 </span><span class="title-name">Introduction</span></a></span></li><li><span class="section"><a href="day2-downstream-clusters.html#day2-os-upgrade"><span class="title-number">30.2 </span><span class="title-name">OS upgrade</span></a></span></li><li><span class="section"><a href="day2-downstream-clusters.html#day2-k8s-upgrade"><span class="title-number">30.3 </span><span class="title-name">Kubernetes version upgrade</span></a></span></li><li><span class="section"><a href="day2-downstream-clusters.html#day2-helm-upgrade"><span class="title-number">30.4 </span><span class="title-name">Helm chart upgrade</span></a></span></li></ul></div><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter/X"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2025</span></div></div></footer></body></html>