<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>SUSE Edge Documentation | Edge 3.1 migration</title><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"/>
<meta name="title" content="Edge 3.1 migration"/>
<meta name="description" content="This section offers migration guidelines for existing Edge 3.0 (including minor releases such as 3.0.1 and 3.0.2) management and downstream clusters …"/>
<meta name="book-title" content="SUSE Edge Documentation"/>
<meta name="chapter-title" content="Chapter 26. Edge 3.1 migration"/>
<meta name="tracker-url" content="https://github.com/suse-edge/suse-edge.github.io/issues/new"/>
<meta name="tracker-type" content="gh"/>
<meta name="publisher" content="SUSE"/><meta property="og:title" content="Edge 3.1 migration"/>
<meta property="og:description" content="This section offers migration guidelines for existing Edge …"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Edge 3.1 migration"/>
<meta name="twitter:description" content="This section offers migration guidelines for existing Edge …"/>
<script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": ["TechArticle"],
    "image": "https://www.suse.com/assets/img/suse-white-logo-green.svg",
    
     "isPartOf": {
      "@type": "CreativeWorkSeries",
      "name": "Products &amp; Solutions"
    },
    

    "headline": "Edge 3.1 migration",
  
    "description": "Edge 3.1 migration",
      
    "author": [
      {
        "@type": "Corporation",
        "name": "SUSE Product &amp; Solution Documentation Team",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    ],
      

    "about": [
      
    ],
  
    "sameAs": [
          "https://www.facebook.com/SUSEWorldwide/about",
          "https://www.youtube.com/channel/UCHTfqIzPKz4f_dri36lAQGA",
          "https://twitter.com/SUSE",
          "https://www.linkedin.com/company/suse"
    ],
    "publisher": {
      "@type": "Corporation",
      "name": "SUSE",
      "url": "https://documentation.suse.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    }
  }</script>
<link rel="prev" href="day-2-operations.html" title="Part V. Day 2 Operations"/><link rel="next" href="day2-mgmt-cluster.html" title="Chapter 27. Management Cluster"/><script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/script-purejs.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="wide offline js-off"><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">SUSE Edge Documentation</a><span> / </span><a class="crumb" href="day-2-operations.html">Day 2 Operations</a><span> / </span><a class="crumb" href="day2-migration.html">Edge 3.1 migration</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title">SUSE Edge Documentation</div><ol><li><a href="id-suse-edge-documentation.html" class=" "><span class="title-number"> </span><span class="title-name">SUSE Edge Documentation</span></a></li><li><a href="id-quick-starts.html" class="has-children "><span class="title-number">I </span><span class="title-name">Quick Starts</span></a><ol><li><a href="quickstart-metal3.html" class=" "><span class="title-number">1 </span><span class="title-name">BMC automated deployments with Metal<sup>3</sup></span></a></li><li><a href="quickstart-elemental.html" class=" "><span class="title-number">2 </span><span class="title-name">Remote host onboarding with Elemental</span></a></li><li><a href="quickstart-eib.html" class=" "><span class="title-number">3 </span><span class="title-name">Standalone clusters with Edge Image Builder</span></a></li></ol></li><li><a href="id-components-used.html" class="has-children "><span class="title-number">II </span><span class="title-name">Components Used</span></a><ol><li><a href="components-rancher.html" class=" "><span class="title-number">4 </span><span class="title-name">Rancher</span></a></li><li><a href="components-rancher-dashboard-extensions.html" class=" "><span class="title-number">5 </span><span class="title-name">Rancher Dashboard Extensions</span></a></li><li><a href="components-fleet.html" class=" "><span class="title-number">6 </span><span class="title-name">Fleet</span></a></li><li><a href="components-slmicro.html" class=" "><span class="title-number">7 </span><span class="title-name">SLE Micro</span></a></li><li><a href="components-metal3.html" class=" "><span class="title-number">8 </span><span class="title-name">Metal<sup>3</sup></span></a></li><li><a href="components-eib.html" class=" "><span class="title-number">9 </span><span class="title-name">Edge Image Builder</span></a></li><li><a href="components-nmc.html" class=" "><span class="title-number">10 </span><span class="title-name">Edge Networking</span></a></li><li><a href="components-elemental.html" class=" "><span class="title-number">11 </span><span class="title-name">Elemental</span></a></li><li><a href="components-akri.html" class=" "><span class="title-number">12 </span><span class="title-name">Akri</span></a></li><li><a href="components-k3s.html" class=" "><span class="title-number">13 </span><span class="title-name">K3s</span></a></li><li><a href="components-rke2.html" class=" "><span class="title-number">14 </span><span class="title-name">RKE2</span></a></li><li><a href="components-longhorn.html" class=" "><span class="title-number">15 </span><span class="title-name">Longhorn</span></a></li><li><a href="components-neuvector.html" class=" "><span class="title-number">16 </span><span class="title-name">NeuVector</span></a></li><li><a href="components-metallb.html" class=" "><span class="title-number">17 </span><span class="title-name">MetalLB</span></a></li><li><a href="components-kubevirt.html" class=" "><span class="title-number">18 </span><span class="title-name">Edge Virtualization</span></a></li><li><a href="components-system-upgrade-controller.html" class=" "><span class="title-number">19 </span><span class="title-name">System Upgrade Controller</span></a></li><li><a href="components-upgrade-controller.html" class=" "><span class="title-number">20 </span><span class="title-name">Upgrade Controller</span></a></li></ol></li><li><a href="id-how-to-guides.html" class="has-children "><span class="title-number">III </span><span class="title-name">How-To Guides</span></a><ol><li><a href="guides-metallb-k3s.html" class=" "><span class="title-number">21 </span><span class="title-name">MetalLB on K3s (using L2)</span></a></li><li><a href="guides-metallb-kubernetes.html" class=" "><span class="title-number">22 </span><span class="title-name">MetalLB in front of the Kubernetes API server</span></a></li><li><a href="id-air-gapped-deployments-with-edge-image-builder.html" class=" "><span class="title-number">23 </span><span class="title-name">Air-gapped deployments with Edge Image Builder</span></a></li></ol></li><li><a href="id-third-party-integration.html" class="has-children "><span class="title-number">IV </span><span class="title-name">Third-Party Integration</span></a><ol><li><a href="integrations-nats.html" class=" "><span class="title-number">24 </span><span class="title-name">NATS</span></a></li><li><a href="id-nvidia-gpus-on-sle-micro.html" class=" "><span class="title-number">25 </span><span class="title-name">NVIDIA GPUs on SLE Micro</span></a></li></ol></li><li class="active"><a href="day-2-operations.html" class="has-children you-are-here"><span class="title-number">V </span><span class="title-name">Day 2 Operations</span></a><ol><li><a href="day2-migration.html" class=" you-are-here"><span class="title-number">26 </span><span class="title-name">Edge 3.1 migration</span></a></li><li><a href="day2-mgmt-cluster.html" class=" "><span class="title-number">27 </span><span class="title-name">Management Cluster</span></a></li><li><a href="day2-downstream-clusters.html" class=" "><span class="title-number">28 </span><span class="title-name">Downstream clusters</span></a></li></ol></li><li><a href="id-product-documentation.html" class="has-children "><span class="title-number">VI </span><span class="title-name">Product Documentation</span></a><ol><li><a href="atip.html" class=" "><span class="title-number">29 </span><span class="title-name">SUSE Adaptive Telco Infrastructure Platform (ATIP)</span></a></li><li><a href="atip-architecture.html" class=" "><span class="title-number">30 </span><span class="title-name">Concept &amp; Architecture</span></a></li><li><a href="atip-requirements.html" class=" "><span class="title-number">31 </span><span class="title-name">Requirements &amp; Assumptions</span></a></li><li><a href="atip-management-cluster.html" class=" "><span class="title-number">32 </span><span class="title-name">Setting up the management cluster</span></a></li><li><a href="atip-features.html" class=" "><span class="title-number">33 </span><span class="title-name">Telco features configuration</span></a></li><li><a href="atip-automated-provisioning.html" class=" "><span class="title-number">34 </span><span class="title-name">Fully automated directed network provisioning</span></a></li><li><a href="atip-lifecycle.html" class=" "><span class="title-number">35 </span><span class="title-name">Lifecycle actions</span></a></li></ol></li><li><a href="id-appendix.html" class="has-children "><span class="title-number">VII </span><span class="title-name">Appendix</span></a><ol><li><a href="id-release-notes.html" class=" "><span class="title-number">36 </span><span class="title-name">Release Notes</span></a></li></ol></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="day2-migration" data-id-title="Edge 3.1 migration"><div class="titlepage"><div><div><div class="title-container"><h1 class="title"><span class="title-number-name"><span class="title-number">26 </span><span class="title-name">Edge 3.1 migration</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#">#</a></h1><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section offers migration guidelines for existing <code class="literal">Edge 3.0</code> (including minor releases such as 3.0.1 and 3.0.2) <span class="strong"><strong>management</strong></span> and <span class="strong"><strong>downstream</strong></span> clusters to <code class="literal">Edge 3.1.0</code>.</p><p>For a list of <code class="literal">Edge 3.1.0</code> component versions, refer to the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="36.1. Abstract">Section 36.1, “Abstract”</a>).</p><section class="sect1" id="day2-migration-mgmt" data-id-title="Management cluster"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">26.1 </span><span class="title-name">Management cluster</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers how to migrate a <code class="literal">management</code> cluster from <code class="literal">Edge 3.0</code> to <code class="literal">Edge 3.1.0</code>.</p><p><code class="literal">Management</code> cluster components should be migrated in the following order:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Operating System (OS) (<a class="xref" href="day2-migration.html#day2-migration-mgmt-os" title="26.1.1. Operating System (OS)">Section 26.1.1, “Operating System (OS)”</a>)</p></li><li class="listitem"><p>RKE2 (<a class="xref" href="day2-migration.html#day2-migration-mgmt-rke2" title="26.1.2. RKE2">Section 26.1.2, “RKE2”</a>)</p></li><li class="listitem"><p>Edge Helm charts (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm" title="26.1.3. Edge Helm charts">Section 26.1.3, “Edge Helm charts”</a>)</p></li></ol></div><section class="sect2" id="day2-migration-mgmt-os" data-id-title="Operating System (OS)"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">26.1.1 </span><span class="title-name">Operating System (OS)</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-os">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers the steps needed to migrate your <code class="literal">management</code> cluster nodes' OS to an <code class="literal">Edge 3.1.0</code> supported version.</p><div id="id-1.7.3.4.5.3" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>The below steps should be done for each node of the <code class="literal">management</code> cluster.</p><p>To avoid any unforeseen problems, migrate the cluster’s <code class="literal">control-plane</code> nodes first and the <code class="literal">worker</code> nodes second.</p></div><section class="sect3" id="id-prerequisites-11" data-id-title="Prerequisites"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">26.1.1.1 </span><span class="title-name">Prerequisites</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#id-prerequisites-11">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">SCC registered nodes</code> -  ensure your cluster nodes' OS are registered with a subscription key that supports the operating system version specified in the <code class="literal">Edge 3.1</code> release (<a class="xref" href="id-release-notes.html#release-notes" title="36.1. Abstract">Section 36.1, “Abstract”</a>).</p></li></ul></div><p><span class="emphasis"><em>Air-gapped:</em></span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">Mirror SUSE RPM repositories</code> - RPM repositories related to the operating system that is specified in the <code class="literal">Edge 3.1.0</code> release (<a class="xref" href="id-release-notes.html#release-notes" title="36.1. Abstract">Section 36.1, “Abstract”</a>) should be locally mirrored, so that <code class="literal">transactional-update</code> has access to them. This can be achieved by using either <a class="link" href="https://documentation.suse.com/sles/15-SP6/html/SLES-all/book-rmt.html" target="_blank">RMT</a> or <a class="link" href="https://documentation.suse.com/suma/5.0/en/suse-manager/index.html" target="_blank">SUMA</a>.</p></li></ul></div></section><section class="sect3" id="id-migration-steps" data-id-title="Migration steps"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">26.1.1.2 </span><span class="title-name">Migration steps</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#id-migration-steps">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.3.4.5.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The below steps assume you are running as <code class="literal">root</code> and that <code class="literal">kubectl</code> has been configured to connect to the <code class="literal">management</code> cluster.</p></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Mark the node as unschedulable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl cordon &lt;node_name&gt;</pre></div><p>For a full list of the options for the <code class="literal">cordon</code> command, see <a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cordon/" target="_blank">kubectl cordon</a>.</p></li><li class="listitem"><p><span class="strong"><strong>Optionally</strong></span>, there might be use-cases where you would like to <code class="literal">drain</code> the nodes' workloads:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl drain &lt;node&gt;</pre></div><p>For a full list of the options for the <code class="literal">drain</code> command, see <a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_drain/" target="_blank">kubectl drain</a>.</p></li><li class="listitem"><p>Before a migration, you need to ensure that packages on your current OS are updated. To do this, execute:</p><div class="verbatim-wrap highlight bash"><pre class="screen">transactional-update</pre></div><p>The above command executes <a class="link" href="https://en.opensuse.org/SDB:Zypper_usage#Updating_packages" target="_blank">zypper up</a> to update the OS packages. For more information on <code class="literal">transactional-update</code>, see the <a class="link" href="https://documentation.suse.com/smart/systems-management/html/Micro-transactional-updates/index.html" target="_blank">transactional-update guide</a>.</p></li><li class="listitem"><p>Proceed to do the OS migration:</p><div class="verbatim-wrap highlight bash"><pre class="screen">transactional-update --continue migration</pre></div><div id="id-1.7.3.4.5.5.3.4.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The <code class="literal">--continue</code> option is used here to reuse the previous snapshot without having to reboot the system.</p></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>If your subscription key supports the <code class="literal">SUSE Linux Micro 6.0</code> version, you will be prompted with something similar to:</p><div class="informalfigure"><div class="mediaobject"><a href="images/day2-migration-os-migration-prompt.png"><img src="images/day2-migration-os-migration-prompt.png" width="NaN" alt="day2 migration os migration prompt" title="day2 migration os migration prompt"/></a></div></div><p>Select the <code class="literal">number</code> that corresponds to <code class="literal">SUSE Linux Micro 6.0 &lt;arch&gt;</code>.</p><div id="id-1.7.3.4.5.5.3.4.4.1.4" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The <code class="literal">Edge 3.1.0</code> release supports <span class="strong"><strong>only</strong></span> the <code class="literal">SUSE Linux Micro 6.0</code> operating system.</p></div></li></ul></div></li><li class="listitem"><p>After a successful <code class="literal">transactional-update</code> run, for the changes to take effect on the system you would need to reboot:</p><div class="verbatim-wrap highlight bash"><pre class="screen">reboot</pre></div></li><li class="listitem"><p>After the host has been rebooted, validate that the operating system is migrated to <code class="literal">SUSE Linux Micro 6.0</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat /etc/os-release</pre></div><p>Output should be similar to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">NAME="SL-Micro"
VERSION="6.0"
VERSION_ID="6.0"
PRETTY_NAME="SUSE Linux Micro 6.0"
ID="sl-micro"
ID_LIKE="suse"
ANSI_COLOR="0;32"
CPE_NAME="cpe:/o:suse:sl-micro:6.0"
HOME_URL="https://www.suse.com/products/micro/"
DOCUMENTATION_URL="https://documentation.suse.com/sl-micro/6.0/"</pre></div><div id="id-1.7.3.4.5.5.3.6.5" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>In case something failed with the migration, you can rollback to the last working snapshot using:</p><div class="verbatim-wrap highlight bash"><pre class="screen">transactional-update rollback last</pre></div><p>You would need to reboot your system for the <code class="literal">rollback</code> to take effect. See <a class="link" href="https://documentation.suse.com/smart/systems-management/html/Micro-transactional-updates/index.html#tr-up-rollback" target="_blank">the official <code class="literal">transactional-update</code> documentation</a> for more information about the rollback procedure.</p></div></li><li class="listitem"><p>Mark the node as schedulable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl uncordon &lt;node_name&gt;</pre></div></li></ol></div></section></section><section class="sect2" id="day2-migration-mgmt-rke2" data-id-title="RKE2"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">26.1.2 </span><span class="title-name">RKE2</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-rke2">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.3.4.6.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>The below steps should be done for each node of the <code class="literal">management</code> cluster.</p><p>As the <a class="link" href="https://docs.rke2.io/upgrade/manual_upgrade" target="_blank">RKE2 documentation</a> explains, the upgrade procedure requires to upgrade the clusters' <code class="literal">control-plane</code> nodes one at a time and once all have been upgraded, the <code class="literal">agent</code> nodes.</p></div><div id="id-1.7.3.4.6.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>To ensure <span class="strong"><strong>disaster recovery</strong></span>, we advise to do a backup of the RKE2 cluster data. For information on how to do this, check <a class="link" href="https://docs.rke2.io/backup_restore" target="_blank">the RKE2 backup and restore guide</a>. The default location for the <code class="literal">rke2</code> binary is <code class="literal">/opt/rke2/bin</code>.</p></div><p>You can upgrade the RKE2 version to a <code class="literal">Edge 3.1.0</code> compatible version using the RKE2 installation script as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Mark the node as unschedulable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl cordon &lt;node_name&gt;</pre></div><p>For a full list of the options for the <code class="literal">cordon</code> command, see <a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cordon/" target="_blank">kubectl cordon</a>.</p></li><li class="listitem"><p><span class="strong"><strong>Optionally</strong></span>, there might be use-cases where you would like to <code class="literal">drain</code> the nodes' workloads:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl drain &lt;node&gt;</pre></div><p>For a full list of the options for the <code class="literal">drain</code> command, see <a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_drain/" target="_blank">kubectl drain</a>.</p></li><li class="listitem"><p>Use the RKE2 installation script to install the correct <code class="literal">Edge 3.1.0</code> compatible RKE2 version:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION=v1.30.3+rke2r1 sh -</pre></div></li><li class="listitem"><p>Restart the <code class="literal">rke2</code> process:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For control-plane nodes:
systemctl restart rke2-server

# For worker nodes:
systemctl restart rke2-agent</pre></div></li><li class="listitem"><p>Validate that the nodes' RKE2 version is upgraded:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get nodes</pre></div></li><li class="listitem"><p>Mark the node as schedulable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl uncordon &lt;node_name&gt;</pre></div></li></ol></div></section><section class="sect2" id="day2-migration-mgmt-helm" data-id-title="Edge Helm charts"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">26.1.3 </span><span class="title-name">Edge Helm charts</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-helm">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.3.4.7.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This section assumes you have installed <code class="literal">helm</code> on your system and you have a valid <code class="literal">kubeconfig</code> pointing to the desired cluster. For <code class="literal">helm</code> installation instructions, check the <a class="link" href="https://helm.sh/docs/intro/install" target="_blank">Installing Helm</a> guide.</p></div><p>This section provides guidelines for upgrading the Helm chart components that make up a specific Edge release. It covers the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Known limitations (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-limitations" title="26.1.3.1. Known Limitations">Section 26.1.3.1, “Known Limitations”</a>) that the upgrade process has.</p></li><li class="listitem"><p>How to migrate (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-capi" title="26.1.3.2. Cluster API controllers migration">Section 26.1.3.2, “Cluster API controllers migration”</a>) Cluster API controllers through the <code class="literal">Rancher Turtles</code> Helm chart.</p></li><li class="listitem"><p>How to upgrade Edge Helm charts (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-eib" title="26.1.3.3. Edge Helm chart upgrade - EIB">Section 26.1.3.3, “Edge Helm chart upgrade - EIB”</a>) deployed through EIB (<a class="xref" href="components-eib.html" title="Chapter 9. Edge Image Builder">Chapter 9, <em>Edge Image Builder</em></a>).</p></li><li class="listitem"><p>How to upgrade Edge Helm charts (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-non-eib" title="26.1.3.4. Edge Helm chart upgrade - non-EIB">Section 26.1.3.4, “Edge Helm chart upgrade - non-EIB”</a>) deployed through non-EIB means.</p></li></ul></div><section class="sect3" id="day2-migration-mgmt-helm-limitations" data-id-title="Known Limitations"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">26.1.3.1 </span><span class="title-name">Known Limitations</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-helm-limitations">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers known limitations to the current migration process. Users should first go through the steps described here before moving to upgrade their helm charts.</p><section class="sect4" id="id-rancher-upgrade" data-id-title="Rancher upgrade"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">26.1.3.1.1 </span><span class="title-name">Rancher upgrade</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#id-rancher-upgrade">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>With the current RKE2 version that <code class="literal">Edge 3.1.0</code> utilizes, there is an issue where all ingresses that do not contain an <code class="literal">IngressClass</code> are ignored by the ingress controller. To mitigate this, users would need to manually add the name of the default <code class="literal">IngressClass</code> to the default <code class="literal">Rancher</code> Ingress.</p><p>For more information on the problem that the below steps fix, see the <a class="link" href="https://github.com/rancher/rke2/issues/6510" target="_blank">upstream</a> RKE2 issue and more specifically <a class="link" href="https://github.com/rancher/rke2/issues/6510#issuecomment-2311231917" target="_blank">this</a> comment.</p><div id="id-1.7.3.4.7.5.3.4" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>In some cases the default <code class="literal">IngressClass</code> might have a different name than <code class="literal">nginx</code>.</p><p>Make sure to validate the name by running:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get ingressclass</pre></div></div><p>Before upgrading <code class="literal">Rancher</code>, make sure to execute the following command:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>If <code class="literal">Rancher</code> was deployed through EIB (<a class="xref" href="components-eib.html" title="Chapter 9. Edge Image Builder">Chapter 9, <em>Edge Image Builder</em></a>):</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl patch helmchart rancher -n &lt;namespace&gt; --type='merge' -p '{"spec":{"set":{"ingress.ingressClassName":"nginx"}}}'</pre></div></li><li class="listitem"><p>If <code class="literal">Rancher</code> was deployed through Helm, add the <code class="literal">--set ingress.ingressClassName=nginx</code> flag to your <a class="link" href="https://helm.sh/docs/helm/helm_upgrade/" target="_blank">upgrade</a> command. For a full example of how to utilize this option, see the following example (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-non-eib-example" title="26.1.3.4.1. Example">Section 26.1.3.4.1, “Example”</a>).</p></li></ul></div></section></section><section class="sect3" id="day2-migration-mgmt-helm-capi" data-id-title="Cluster API controllers migration"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">26.1.3.2 </span><span class="title-name">Cluster API controllers migration</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-helm-capi">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>From <code class="literal">Edge 3.1.0</code>, Cluster API (CAPI) controllers on a Metal<sup>3</sup> management cluster are managed via <a class="link" href="https://turtles.docs.rancher.com" target="_blank">Rancher Turtles</a>.</p><p>To migrate the CAPI controllers versions to <code class="literal">Edge 3.1.0</code> compatible versions, install the <code class="literal">Rancher Turtles</code> chart:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm install rancher-turtles oci://registry.suse.com/edge/3.1/rancher-turtles-chart --version 0.3.2 --namespace rancher-turtles-system --create-namespace</pre></div><p>After some time, the controller pods running in the <code class="literal">capi-system</code>, <code class="literal">capm3-system</code>, <code class="literal">rke2-bootstrap-system</code> and <code class="literal">rke2-control-plane-system</code> namespaces are upgraded with the <code class="literal">Edge 3.1.0</code> compatible controller versions.</p><p>For information on how to install <code class="literal">Rancher Turtles</code> in an air-gapped environment, refer to Rancher Turtles air-gapped installation (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-capi-air-gapped" title="26.1.3.2.1. Rancher Turtles air-gapped installation">Section 26.1.3.2.1, “Rancher Turtles air-gapped installation”</a>).</p><section class="sect4" id="day2-migration-mgmt-helm-capi-air-gapped" data-id-title="Rancher Turtles air-gapped installation"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">26.1.3.2.1 </span><span class="title-name">Rancher Turtles air-gapped installation</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-helm-capi-air-gapped">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.3.4.7.6.7.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The below steps assume that <code class="literal">kubectl</code> has been configured to connect to the <code class="literal">management</code> cluster that you wish to upgrade.</p></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Before installing the below mentioned <code class="literal">rancher-turtles-airgap-resources</code> Helm chart, ensure that it will have the correct ownership over the <code class="literal">clusterctl</code> created namespaces:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p><code class="literal">capi-system</code> ownership change:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl label namespace capi-system app.kubernetes.io/managed-by=Helm --overwrite

kubectl annotate namespace capi-system meta.helm.sh/release-name=rancher-turtles-airgap-resources --overwrite
kubectl annotate namespace capi-system meta.helm.sh/release-namespace=rancher-turtles-system --overwrite</pre></div></li><li class="listitem"><p><code class="literal">capm3-system</code> ownership change:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl label namespace capm3-system app.kubernetes.io/managed-by=Helm --overwrite

kubectl annotate namespace capm3-system meta.helm.sh/release-name=rancher-turtles-airgap-resources --overwrite
kubectl annotate namespace capm3-system meta.helm.sh/release-namespace=rancher-turtles-system --overwrite</pre></div></li><li class="listitem"><p><code class="literal">rke2-bootstrap-system</code> ownership change:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl label namespace rke2-bootstrap-system app.kubernetes.io/managed-by=Helm --overwrite

kubectl annotate namespace rke2-bootstrap-system meta.helm.sh/release-name=rancher-turtles-airgap-resources --overwrite
kubectl annotate namespace rke2-bootstrap-system meta.helm.sh/release-namespace=rancher-turtles-system --overwrite</pre></div></li><li class="listitem"><p><code class="literal">rke2-control-plane-system</code> ownership change:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl label namespace rke2-control-plane-system app.kubernetes.io/managed-by=Helm --overwrite

kubectl annotate namespace rke2-control-plane-system meta.helm.sh/release-name=rancher-turtles-airgap-resources --overwrite
kubectl annotate namespace rke2-control-plane-system meta.helm.sh/release-namespace=rancher-turtles-system --overwrite</pre></div></li></ol></div></li><li class="listitem"><p>Pull the <code class="literal">rancher-turtles-airgap-resources</code> and <code class="literal">rancher-turtles</code> chart archives:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm pull oci://registry.suse.com/edge/3.1/rancher-turtles-airgap-resources-chart --version 0.3.2
helm pull oci://registry.suse.com/edge/3.1/rancher-turtles-chart --version 0.3.2</pre></div></li><li class="listitem"><p>To provide the needed resources for an air-gapped installation of the <code class="literal">Rancher Turtles</code> Helm chart, install the <code class="literal">rancher-turtles-airgap-resources</code> Helm chart:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm install rancher-turtles-airgap-resources ./rancher-turtles-airgap-resources-chart-0.3.2.tgz --namespace rancher-turtles-system --create-namespace</pre></div></li><li class="listitem"><p>Configure the <code class="literal">cluster-api-operator</code> in the <code class="literal">Rancher Turtles</code> Helm chart to fetch controller data from correct locations:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; values.yaml &lt;&lt;EOF
cluster-api-operator:
  cluster-api:
    core:
      fetchConfig:
        selector: "{\"matchLabels\": {\"provider-components\": \"core\"}}"
    rke2:
      bootstrap:
        fetchConfig:
          selector: "{\"matchLabels\": {\"provider-components\": \"rke2-bootstrap\"}}"
      controlPlane:
        fetchConfig:
          selector: "{\"matchLabels\": {\"provider-components\": \"rke2-control-plane\"}}"
    metal3:
      infrastructure:
        fetchConfig:
          selector: "{\"matchLabels\": {\"provider-components\": \"metal3\"}}"
EOF</pre></div></li><li class="listitem"><p>Install <code class="literal">Rancher Turtles</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm install rancher-turtles ./rancher-turtles-chart-0.3.2.tgz --namespace rancher-turtles-system --create-namespace --values values.yaml</pre></div></li></ol></div><p>After some time, the controller pods running in the <code class="literal">capi-system</code>, <code class="literal">capm3-system</code>, <code class="literal">rke2-bootstrap-system</code> and <code class="literal">rke2-control-plane-system</code> namespaces will be upgraded with the <code class="literal">Edge 3.1.0</code> compatible controller versions.</p></section></section><section class="sect3" id="day2-migration-mgmt-helm-eib" data-id-title="Edge Helm chart upgrade - EIB"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">26.1.3.3 </span><span class="title-name">Edge Helm chart upgrade - EIB</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-helm-eib">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section explains how to upgrade a Helm chart from the Edge component stack, deployed via EIB (<a class="xref" href="components-eib.html" title="Chapter 9. Edge Image Builder">Chapter 9, <em>Edge Image Builder</em></a>), to an <code class="literal">Edge 3.1.0</code> compatible version.</p><section class="sect4" id="id-prerequisites-12" data-id-title="Prerequisites"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">26.1.3.3.1 </span><span class="title-name">Prerequisites</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#id-prerequisites-12">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>In <code class="literal">Edge 3.1</code>, EIB changes the way it deploys charts and <span class="strong"><strong>no longer uses</strong></span> the <a class="link" href="https://docs.rke2.io/helm#automatically-deploying-manifests-and-helm-charts" target="_blank">RKE2</a>/<a class="link" href="https://docs.k3s.io/installation/packaged-components#auto-deploying-manifests-addons" target="_blank">K3s</a> manifest auto-deploy mechanism.</p><p>This means that, before upgrading to an <code class="literal">Edge 3.1.0</code> compatible version, any Helm charts deployed on an <code class="literal">Edge 3.0</code> environment using EIB should have their chart manifests removed from the manifests directory of the relevant Kubernetes distribution.</p><div id="id-1.7.3.4.7.7.3.4" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.svg"/><div class="admon-title">Warning</div><p>If this is not done, any chart upgrade will be reverted by the RKE2/K3s process upon restart of the process or the operating system.</p></div><div id="id-1.7.3.4.7.7.3.5" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Deleting manifests from the RKE2/K3s directory will <span class="strong"><strong>not</strong></span> result in the resources being removed from the cluster.</p><p>As per the <a class="link" href="https://docs.rke2.io/helm#automatically-deploying-manifests-and-helm-charts" target="_blank">RKE2</a>/<a class="link" href="https://docs.k3s.io/installation/packaged-components#auto-deploying-manifests-addons" target="_blank">K3s</a> documentation:</p><div class="blockquote"><blockquote class="blockquote"><p>"Deleting files out of this directory will not delete the corresponding resources from the cluster."</p></blockquote></div></div><p>Removing any EIB deployed chart manifests involves the following steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>To ensure disaster recovery, make a backup of each EIB deployed manifest:</p><div id="id-1.7.3.4.7.7.3.7.1.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>EIB deployed manifests will have the <code class="literal">"edge.suse.com/source: edge-image-builder"</code> label.</p></div><div id="id-1.7.3.4.7.7.3.7.1.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Make sure that the <code class="literal">&lt;backup_location&gt;</code> that you provide to the below command exists.</p></div><div class="verbatim-wrap highlight bash"><pre class="screen">grep -lrIZ 'edge.suse.com/source: edge-image-builder' /var/lib/rancher/rke2/server/manifests | xargs -0 -I{} cp {} &lt;backup_location&gt;</pre></div></li><li class="listitem"><p>Remove all EIB deployed manifests:</p><div class="verbatim-wrap highlight bash"><pre class="screen">grep -lrIZ 'edge.suse.com/source: edge-image-builder' /var/lib/rancher/rke2/server/manifests | xargs -0 rm -f --</pre></div></li></ol></div></section><section class="sect4" id="day2-migration-mgmt-helm-upgrade-steps" data-id-title="Upgrade steps"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">26.1.3.3.2 </span><span class="title-name">Upgrade steps</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-helm-upgrade-steps">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.7.3.4.7.7.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The below steps assume that <code class="literal">kubectl</code> has been configured to connect to the <code class="literal">management</code> cluster that you wish to upgrade.</p></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Locate the <code class="literal">Edge 3.1</code> compatible chart version that you wish to migrate to by looking at the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="36.1. Abstract">Section 36.1, “Abstract”</a>).</p></li><li class="listitem"><p><a class="link" href="https://helm.sh/docs/helm/helm_pull/" target="_blank">Pull</a> the desired Helm chart version:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For charts hosted in HTTP repositories:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm repo add &lt;chart_repo_name&gt; &lt;chart_repo_urls&gt;

helm pull &lt;chart_repo_name&gt;/&lt;chart_name&gt; --version=X.Y.Z</pre></div></li><li class="listitem"><p>For charts hosted in OCI registries:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm pull oci://&lt;chart_oci_url&gt; --version=X.Y.Z</pre></div></li></ul></div></li><li class="listitem"><p>Encode the pulled chart archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">base64 -w 0 &lt;chart_name&gt;-X.Y.Z.tgz  &gt; &lt;chart_name&gt;-X.Y.Z.txt</pre></div></li><li class="listitem"><p>Check the Known Limitations (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-limitations" title="26.1.3.1. Known Limitations">Section 26.1.3.1, “Known Limitations”</a>) section if there are any additional steps that need to be done for the charts.</p></li><li class="listitem"><p>Patch the existing <code class="literal">HelmChart</code> resource:</p><div id="id-1.7.3.4.7.7.4.3.5.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Make sure to pass the <code class="literal">HelmChart</code> <span class="strong"><strong>name</strong></span>, <span class="strong"><strong>namespace</strong></span>, <span class="strong"><strong>encoded file</strong></span> and <span class="strong"><strong>version</strong></span> to the command below.</p></div><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl patch helmchart &lt;helmchart_name&gt; --type=merge -p "{\"spec\":{\"chartContent\":\"$(cat &lt;helmchart_name&gt;-X.Y.Z.txt)\", \"version\":\"&lt;helmchart_version&gt;\"}}" -n &lt;helmchart_namespace&gt;</pre></div></li><li class="listitem"><p>This will signal the <a class="link" href="https://github.com/k3s-io/helm-controller" target="_blank">helm-controller</a> to schedule a Job that will create a Pod that will upgrade the desired Helm chart. To view the logs of the created Pod, follow these steps:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Locate the created Pod:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get pods -l helmcharts.helm.cattle.io/chart=&lt;helmchart_name&gt; -n &lt;namespace&gt;</pre></div></li><li class="listitem"><p>View the Pod logs:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl logs &lt;pod_name&gt; -n &lt;namespace&gt;</pre></div></li></ol></div></li></ol></div><p>A <code class="literal">Completed</code> Pod with non-error logs would result in a successful upgrade of the desired Helm chart.</p><p>For a full example of how to upgrade a Helm chart deployed through EIB, refer to the Example (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-example" title="26.1.3.3.3. Example">Section 26.1.3.3.3, “Example”</a>) section.</p></section><section class="sect4" id="day2-migration-mgmt-helm-example" data-id-title="Example"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">26.1.3.3.3 </span><span class="title-name">Example</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-helm-example">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section provides an example of upgrading the <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> Helm charts to a version compatible with the <code class="literal">Edge 3.1.0</code> release. It follows the steps outlined in the "Upgrade Steps" (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-upgrade-steps" title="26.1.3.3.2. Upgrade steps">Section 26.1.3.3.2, “Upgrade steps”</a>) section.</p><p><span class="emphasis"><em>Use-case:</em></span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Current <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> charts need to be upgraded to an <code class="literal">Edge 3.1.0</code> compatible version.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">Rancher</code> is deployed through EIB and its <code class="literal">HelmChart</code> is deployed in the <code class="literal">default</code> namespace.</p></li><li class="listitem"><p><code class="literal">Metal<sup>3</sup></code> is deployed through EIB and its <code class="literal">HelmChart</code> is deployed in the <code class="literal">kube-system</code> namespace.</p></li></ul></div></li></ul></div><p><span class="emphasis"><em>Steps:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Locate the desired versions for <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> from the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="36.1. Abstract">Section 36.1, “Abstract”</a>). For <code class="literal">Edge 3.1.0</code>, these versions would be <code class="literal">2.9.1</code> for <span class="emphasis"><em>Rancher</em></span> and <code class="literal">0.8.1</code> for <span class="emphasis"><em>Metal<sup>3</sup></em></span>.</p></li><li class="listitem"><p>Pull the desired chart versions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">Rancher</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm repo add rancher-prime https://charts.rancher.com/server-charts/prime
helm pull rancher-prime/rancher --version=2.9.1</pre></div></li><li class="listitem"><p>For <code class="literal">Metal<sup>3</sup></code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm pull oci://registry.suse.com/edge/3.1/metal3-chart --version=0.8.1</pre></div></li></ul></div></li><li class="listitem"><p>Encode the <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> Helm charts:</p><div class="verbatim-wrap highlight bash"><pre class="screen">base64 -w 0 rancher-2.9.1.tgz &gt; rancher-2.9.1.txt
base64 -w 0 metal3-chart-0.8.1.tgz &gt; metal3-chart-0.8.1.txt</pre></div></li><li class="listitem"><p>The directory structure should look similar to this:</p><div class="verbatim-wrap highlight bash"><pre class="screen">.
├── metal3-chart-0.8.1.tgz
├── metal3-chart-0.8.1.txt
├── rancher-2.9.1.tgz
└── rancher-2.9.1.txt</pre></div></li><li class="listitem"><p>Check the Known Limitations (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-limitations" title="26.1.3.1. Known Limitations">Section 26.1.3.1, “Known Limitations”</a>) section if there are any additional steps that need to be done for the charts.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">Rancher</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Execute the command described in the <code class="literal">Known Limitations</code> section:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># In this example the rancher helmchart is in the 'default' namespace
kubectl patch helmchart rancher -n default --type='merge' -p '{"spec":{"set":{"ingress.ingressClassName":"nginx"}}}'</pre></div></li><li class="listitem"><p>Validate that the <code class="literal">ingressClassName</code> property was successfully added:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get ingress rancher -n cattle-system -o yaml | grep -w ingressClassName

# Example output
  ingressClassName: nginx</pre></div></li></ul></div></li></ul></div></li><li class="listitem"><p>Patch the <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> HelmChart resources:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Rancher deployed in the default namespace
kubectl patch helmchart rancher --type=merge -p "{\"spec\":{\"chartContent\":\"$(cat rancher-2.9.1.txt)\", \"version\":\"2.9.1\"}}" -n default

# Metal3 deployed in the kube-system namespace
kubectl patch helmchart metal3 --type=merge -p "{\"spec\":{\"chartContent\":\"$(cat metal3-chart-0.8.1.txt)\", \"version\":\"0.8.1\"}}" -n kube-system</pre></div></li><li class="listitem"><p>Locate the <code class="literal">helm-controller</code> created <span class="emphasis"><em>Rancher</em></span> and <span class="emphasis"><em>Metal<sup>3</sup></em></span> Pods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>Rancher:</em></span></p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get pods -l helmcharts.helm.cattle.io/chart=rancher -n default

# Example output
NAME                         READY   STATUS      RESTARTS   AGE
helm-install-rancher-wg7nf   0/1     Completed   0          5m2s</pre></div></li><li class="listitem"><p><span class="emphasis"><em>Metal<sup>3</sup>:</em></span></p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get pods -l helmcharts.helm.cattle.io/chart=metal3 -n kube-system

# Example output
NAME                        READY   STATUS      RESTARTS   AGE
helm-install-metal3-57lz5   0/1     Completed   0          4m35s</pre></div></li></ul></div></li><li class="listitem"><p>View the logs of each pod using <a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_logs/" target="_blank">kubectl logs</a>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>Rancher:</em></span></p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl logs helm-install-rancher-wg7nf -n default

# Example successful output
...
Upgrading rancher
+ helm_v3 upgrade --namespace cattle-system --create-namespace --version 2.9.1 --set-string global.clusterCIDR=10.42.0.0/16 --set-string global.clusterCIDRv4=10.42.0.0/16 --set-string global.clusterDNS=10.43.0.10 --set-string global.clusterDomain=cluster.local --set-string global.rke2DataDir=/var/lib/rancher/rke2 --set-string global.serviceCIDR=10.43.0.0/16 --set-string ingress.ingressClassName=nginx rancher /tmp/rancher.tgz --values /config/values-01_HelmChart.yaml
Release "rancher" has been upgraded. Happy Helming!
...</pre></div></li><li class="listitem"><p><span class="emphasis"><em>Metal<sup>3</sup>:</em></span></p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl logs helm-install-metal3-57lz5  -n kube-system

# Example successful output
...
Upgrading metal3
+ echo 'Upgrading metal3'
+ shift 1
+ helm_v3 upgrade --namespace metal3-system --create-namespace --version 0.8.1 --set-string global.clusterCIDR=10.42.0.0/16 --set-string global.clusterCIDRv4=10.42.0.0/16 --set-string global.clusterDNS=10.43.0.10 --set-string global.clusterDomain=cluster.local --set-string global.rke2DataDir=/var/lib/rancher/rke2 --set-string global.serviceCIDR=10.43.0.0/16 metal3 /tmp/metal3.tgz --values /config/values-01_HelmChart.yaml
Release "metal3" has been upgraded. Happy Helming!
...</pre></div></li></ul></div></li><li class="listitem"><p>Validate that the pods for the specific chart are running:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For Rancher
kubectl get pods -n cattle-system

# For Metal3
kubectl get pods -n metal3-system</pre></div></li></ol></div></section></section><section class="sect3" id="day2-migration-mgmt-helm-non-eib" data-id-title="Edge Helm chart upgrade - non-EIB"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">26.1.3.4 </span><span class="title-name">Edge Helm chart upgrade - non-EIB</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-helm-non-eib">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section explains how to upgrade a Helm chart from the Edge component stack, deployed via Helm, to an <code class="literal">Edge 3.1.0</code> compatible version.</p><div id="id-1.7.3.4.7.8.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The below steps assume that <code class="literal">kubectl</code> has been configured to connect to the <code class="literal">management</code> cluster that you wish to upgrade.</p></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Locate the <code class="literal">Edge 3.1.0</code> compatible chart version that you wish to migrate to by looking at the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="36.1. Abstract">Section 36.1, “Abstract”</a>).</p></li><li class="listitem"><p>Get the custom values of the currently running helm chart:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm get values &lt;chart_name&gt; -n &lt;chart_namespace&gt; -o yaml &gt; &lt;chart_name&gt;-values.yaml</pre></div></li><li class="listitem"><p>Check the Known Limitations (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-limitations" title="26.1.3.1. Known Limitations">Section 26.1.3.1, “Known Limitations”</a>) section if there are any additional steps, or changes that need to be done for the charts.</p></li><li class="listitem"><p><a class="link" href="https://helm.sh/docs/helm/helm_upgrade/" target="_blank">Upgrade</a> the helm chart to the desired version:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For non air-gapped setups:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For charts hosted in HTTP repositories
helm upgrade &lt;chart_name&gt; &lt;chart_repo&gt;/&lt;chart_name&gt; --version &lt;version&gt; --values &lt;chart_name&gt;-values.yaml -n &lt;chart_namespace&gt;

# For charts hosted in OCI registries
helm upgrade &lt;chart_name&gt; oci://&lt;oci_registry_url&gt;/&lt;chart_name&gt; --namespace &lt;chart_namespace&gt; --values &lt;chart_name&gt;-values.yaml --version=X.Y.Z</pre></div></li><li class="listitem"><p>For air-gapped setups:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>On a machine with access to the internet, pull the desired chart version:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For charts hosted in HTTP repositories
helm pull &lt;chart_repo_name&gt;/&lt;chart_name&gt; --version=X.Y.Z

# For charts hosted in OCI registries
helm pull oci://&lt;chart_oci_url&gt; --version=X.Y.Z</pre></div></li><li class="listitem"><p>Transfer the chart archive to your <code class="literal">management</code> cluster:</p><div class="verbatim-wrap highlight bash"><pre class="screen">scp &lt;chart&gt;.tgz &lt;machine-address&gt;:&lt;filesystem-path&gt;</pre></div></li><li class="listitem"><p>Upgrade the chart:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm upgrade &lt;chart_name&gt; &lt;chart&gt;.tgz --values &lt;chart_name&gt;-values.yaml -n &lt;chart_namespace&gt;</pre></div></li></ul></div></li></ul></div></li><li class="listitem"><p>Verify that the chart pods are running:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get pods -n &lt;chart_namespace&gt;</pre></div></li></ol></div><p>You may want to do additional verification of the upgrade by checking resources specific to your chart. After this has been done, the upgrade can be considered successful.</p><p>For a full example, refer to the Example (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-non-eib-example" title="26.1.3.4.1. Example">Section 26.1.3.4.1, “Example”</a>) section.</p><section class="sect4" id="day2-migration-mgmt-helm-non-eib-example" data-id-title="Example"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">26.1.3.4.1 </span><span class="title-name">Example</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-mgmt-helm-non-eib-example">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section provides an example of upgrading the <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> Helm charts to a version compatible with the <code class="literal">Edge 3.1.0</code> release. It follows the steps outlined in the "Edge Helm chart upgrade - non-EIB" (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-non-eib" title="26.1.3.4. Edge Helm chart upgrade - non-EIB">Section 26.1.3.4, “Edge Helm chart upgrade - non-EIB”</a>) section.</p><p><span class="emphasis"><em>Use-case:</em></span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Current <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> charts need to be upgraded to an <code class="literal">Edge 3.1.0</code> compatible version.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The <code class="literal">Rancher</code> helm chart is deployed from the <a class="link" href="https://charts.rancher.com/server-charts/prime" target="_blank">Rancher Prime</a> repository in the <code class="literal">cattle-system</code> namespace. The <code class="literal">Rancher Prime</code> repository was added in the following way:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm repo add rancher-prime https://charts.rancher.com/server-charts/prime</pre></div></li><li class="listitem"><p>The <code class="literal">Metal<sup>3</sup></code> is deployed from the <code class="literal">registry.suse.com</code> OCI registry in the <code class="literal">metal3-system</code> namespace.</p></li></ul></div></li></ul></div><p><span class="emphasis"><em>Steps:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Locate the desired versions for <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> from the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="36.1. Abstract">Section 36.1, “Abstract”</a>). For <code class="literal">Edge 3.1.0</code>, these versions would be <code class="literal">2.9.1</code> for Rancher and <code class="literal">0.8.1</code> for Metal<sup>3</sup>.</p></li><li class="listitem"><p>Get the custom values of the currently running <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> helm charts:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For Rancher
helm get values rancher -n cattle-system -o yaml &gt; rancher-values.yaml

# For Metal3
helm get values metal3 -n metal3-system -o yaml &gt; metal3-values.yaml</pre></div></li><li class="listitem"><p>Check the Known Limitations (<a class="xref" href="day2-migration.html#day2-migration-mgmt-helm-limitations" title="26.1.3.1. Known Limitations">Section 26.1.3.1, “Known Limitations”</a>) section if there are any additional steps that need to be done for the charts.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">Rancher</code> the <code class="literal">--set ingress.ingressClassName=nginx</code> option needs to be added to the upgrade command.</p></li></ul></div></li><li class="listitem"><p>Upgrade the <code class="literal">Rancher</code> and <code class="literal">Metal<sup>3</sup></code> helm charts:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For Rancher
helm upgrade rancher rancher-prime/rancher --version 2.9.1 --set ingress.ingressClassName=nginx --values rancher-values.yaml -n cattle-system

# For Metal3
helm upgrade metal3 oci://registry.suse.com/edge/3.1/metal3-chart --version 0.8.1 --values metal3-values.yaml -n metal3-system</pre></div></li><li class="listitem"><p>Validate that the <code class="literal">Rancher</code> and Metal<sup>3</sup> pods are running:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For Rancher
kubectl get pods -n cattle-system

# For Metal3
kubectl get pods -n metal3-system</pre></div></li></ol></div></section></section></section></section><section class="sect1" id="day2-migration-downstream" data-id-title="Downstream clusters"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">26.2 </span><span class="title-name">Downstream clusters</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-downstream">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers how to migrate your <code class="literal">Edge 3.0.X</code> downstream clusters to <code class="literal">Edge 3.1.0</code>.</p><section class="sect2" id="day2-migration-downstream-prerequisites" data-id-title="Prerequisites"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">26.2.1 </span><span class="title-name">Prerequisites</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-downstream-prerequisites">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers any prerequisite steps that users should go through before beginning the migration process.</p><section class="sect3" id="id-charts-deployed-through-eib" data-id-title="Charts deployed through EIB"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">26.2.1.1 </span><span class="title-name">Charts deployed through EIB</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#id-charts-deployed-through-eib">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>In <code class="literal">Edge 3.1</code>, EIB (<a class="xref" href="components-eib.html" title="Chapter 9. Edge Image Builder">Chapter 9, <em>Edge Image Builder</em></a>) changes the way it deploys charts and <span class="strong"><strong>no longer uses</strong></span> the <a class="link" href="https://docs.rke2.io/helm#automatically-deploying-manifests-and-helm-charts" target="_blank">RKE2</a>/<a class="link" href="https://docs.k3s.io/installation/packaged-components#auto-deploying-manifests-addons" target="_blank">K3s</a> manifest auto-deploy mechanism.</p><p>This means that, before migrating to an <code class="literal">Edge 3.1.0</code> compatible version, any Helm charts deployed on an <code class="literal">Edge 3.0</code> environment using EIB should have their chart manifests removed from the manifests directory of the relevant Kubernetes distribution.</p><div id="id-1.7.3.5.3.3.4" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.svg"/><div class="admon-title">Warning</div><p>If this is not done, any chart upgrade will be reverted by the RKE2/K3s process upon restart of the process or the operating system.</p></div><p>On downstream clusters, the removal of the EIB created chart manifest files is handled by a Fleet called <a class="link" href="https://github.com/suse-edge/fleet-examples/tree/main/fleets/day2/system-upgrade-controller-plans/eib-charts-migration-prep" target="_blank">eib-charts-migration-prep</a> located in the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository.</p><div id="id-1.7.3.5.3.3.6" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.svg"/><div class="admon-title">Warning</div><p>Using the <code class="literal">eib-charts-migration-prep</code> Fleet file from the <code class="literal">main</code> branch is <span class="strong"><strong>not</strong></span> advised. The Fleet file should <span class="strong"><strong>always</strong></span> be used from a valid Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><div id="id-1.7.3.5.3.3.7" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>This process requires that System Upgrade Controller (SUC) is already deployed. For installation details, refer to "Installing the System Upgrade Controller" (<a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-install" title="19.2. Installing the System Upgrade Controller">Section 19.2, “Installing the System Upgrade Controller”</a>).</p></div><p>Once created, the <code class="literal">eib-charts-migration-prep</code> Fleet ships an SUC (<a class="xref" href="components-system-upgrade-controller.html" title="Chapter 19. System Upgrade Controller">Chapter 19, <em>System Upgrade Controller</em></a>) Plan that contains a script that will do the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Determine if the current node on which it is running is an <code class="literal">initializer</code> node. If it is not, it won’t do anything.</p></li><li class="listitem"><p>If the node is an <code class="literal">initializer</code>, it will:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Detect all <code class="literal">HelmChart</code> resources deployed by EIB.</p></li><li class="listitem"><p>Locate the manifest file of each of the above <code class="literal">HelmChart</code> resources.</p><div id="id-1.7.3.5.3.3.9.2.2.2.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p><code class="literal">HelmChart</code> manifest files are located only on the <code class="literal">initializer</code> node under <code class="literal">/var/lib/rancher/rke2/server/manifests</code> for RKE2 and <code class="literal">/var/lib/rancher/k3s/server/manifests</code> for K3s.</p></div></li><li class="listitem"><p>To ensure disaster recovery, make a backup of each located manifest under <code class="literal">/tmp</code>.</p><div id="id-1.7.3.5.3.3.9.2.2.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The backup location can be changed by defining the <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.1.0/fleets/day2/system-upgrade-controller-plans/eib-charts-migration-prep/plan.yaml#L36" target="_blank"><code class="literal">MANIFEST_BACKUP_DIR</code></a> environment variable in the SUC Plan file of the Fleet.</p></div></li><li class="listitem"><p>Remove each manifest file related to a <code class="literal">HelmChart</code> resource deployed by EIB.</p><div id="id-1.7.3.5.3.3.9.2.2.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Deleting manifests from the RKE2/K3s directory will <span class="strong"><strong>not</strong></span> result in the resources being removed from the cluster.</p><p>As per the <a class="link" href="https://docs.rke2.io/helm#automatically-deploying-manifests-and-helm-charts" target="_blank">RKE2</a>/<a class="link" href="https://docs.k3s.io/installation/packaged-components#auto-deploying-manifests-addons" target="_blank">K3s</a> documentation:</p><div class="blockquote"><blockquote class="blockquote"><p>"Deleting files out of this directory will not delete the corresponding resources from the cluster."</p></blockquote></div></div></li></ul></div></li></ol></div><p>Depending on your use-case, the <code class="literal">eib-charts-migration-prep</code> Fleet can be deployed in the following two ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Through a <a class="link" href="https://fleet.rancher.io/ref-gitrepo" target="_blank">GitRepo</a> resource - for use-cases where an external/local Git server is available. For more information, refer to EIB chart migration preparation Fleet deployment - GitRepo (<a class="xref" href="day2-migration.html#day2-migration-downstream-prerequisites-fleet-gitrepo" title="26.2.1.1.1. EIB chart manifest removal Fleet deployment - GitRepo">Section 26.2.1.1.1, “EIB chart manifest removal Fleet deployment - GitRepo”</a>).</p></li><li class="listitem"><p>Through a <a class="link" href="https://fleet.rancher.io/bundle-add" target="_blank">Bundle</a> resource - for air-gapped use-cases that do not support a local Git server option. For more information, refer to EIB chart manifest removal Fleet deployment - Bundle (<a class="xref" href="day2-migration.html#day2-migration-downstream-prerequisites-fleet-bundle" title="26.2.1.1.2. EIB chart manifest removal Fleet deployment - Bundle">Section 26.2.1.1.2, “EIB chart manifest removal Fleet deployment - Bundle”</a>).</p></li></ul></div><section class="sect4" id="day2-migration-downstream-prerequisites-fleet-gitrepo" data-id-title="EIB chart manifest removal Fleet deployment - GitRepo"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">26.2.1.1.1 </span><span class="title-name">EIB chart manifest removal Fleet deployment - GitRepo</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-downstream-prerequisites-fleet-gitrepo">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>On the <code class="literal">management</code> cluster, deploy the following <code class="literal">GitRepo</code> resource:</p><div id="id-1.7.3.5.3.3.12.2.1.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Before deploying the resource below, you <span class="strong"><strong>must</strong></span> provide a valid <code class="literal">targets</code> configuration, so that Fleet knows on which downstream clusters to deploy your resource. For information on how to map to downstream clusters, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p></div><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -n fleet-default -f - &lt;&lt;EOF
apiVersion: fleet.cattle.io/v1alpha1
kind: GitRepo
metadata:
  name: eib-chart-migration-prep
spec:
  revision: release-3.1.0
  paths:
  - fleets/day2/system-upgrade-controller-plans/eib-charts-migration-prep
  repo: https://github.com/suse-edge/fleet-examples.git
  targets:
  - clusterSelector: CHANGEME
  # Example matching all clusters:
  # targets:
  # - clusterSelector: {}
EOF</pre></div><p>Alternatively, you can also create the resource through Ranchers' UI, if such is available. For more information, see <a class="link" href="https://ranchermanager.docs.rancher.com/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">Accessing Fleet in the Rancher UI</a>.</p></li><li class="listitem"><p>By creating the above <code class="literal">GitRepo</code> on your <code class="literal">management</code> cluster, Fleet will deploy a <code class="literal">SUC Plan</code> (called <code class="literal">eib-chart-migration-prep</code>) on each downstream cluster that matches the <code class="literal">targets</code> specified in the <code class="literal">GitRepo</code>. To monitor the lifecycle of this plan, refer to "Monitoring System Upgrade Controller Plans" (<a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="19.3. Monitoring System Upgrade Controller Plans">Section 19.3, “Monitoring System Upgrade Controller Plans”</a>).</p></li></ol></div></section><section class="sect4" id="day2-migration-downstream-prerequisites-fleet-bundle" data-id-title="EIB chart manifest removal Fleet deployment - Bundle"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">26.2.1.1.2 </span><span class="title-name">EIB chart manifest removal Fleet deployment - Bundle</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#day2-migration-downstream-prerequisites-fleet-bundle">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section describes how to convert the <code class="literal">eib-chart-migration-prep</code> Fleet to a <a class="link" href="https://fleet.rancher.io/bundle-add" target="_blank">Bundle</a> resource that can then be used in air-gapped environments that cannot utilize a local git server.</p><p><span class="emphasis"><em>Steps:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>On a machine with network access download the <span class="strong"><strong>fleet-cli</strong></span>:</p><div id="id-1.7.3.5.3.3.13.4.1.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Make sure that the version of the <span class="strong"><strong>fleet-cli</strong></span> you download matches the version of Fleet that has been deployed on your cluster.</p></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For Mac users, there is a <a class="link" href="https://formulae.brew.sh/formula/fleet-cli" target="_blank">fleet-cli</a> Homebrew Formulae.</p></li><li class="listitem"><p>For Linux users, the binaries are present as <span class="strong"><strong>assets</strong></span> to each Fleet <a class="link" href="https://github.com/rancher/fleet/releases" target="_blank">release</a>.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Retrieve the desired binary:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Linux AMD:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -L -o fleet-cli https://github.com/rancher/fleet/releases/download/&lt;FLEET_VERSION&gt;/fleet-linux-amd64</pre></div></li><li class="listitem"><p>Linux ARM:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -L -o fleet-cli https://github.com/rancher/fleet/releases/download/&lt;FLEET_VERSION&gt;/fleet-linux-arm64</pre></div></li></ul></div></li><li class="listitem"><p>Move the binary to <code class="literal">/usr/local/bin</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">sudo mkdir -p /usr/local/bin
sudo mv ./fleet-cli /usr/local/bin/fleet-cli
sudo chmod 755 /usr/local/bin/fleet-cli</pre></div></li></ul></div></li></ul></div></li><li class="listitem"><p>Clone the <span class="strong"><strong>suse-edge/fleet-examples</strong></span> <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> that you wish to use the <code class="literal">eib-chart-migration-prep</code> fleet from:</p><div class="verbatim-wrap highlight bash"><pre class="screen">git clone -b release-3.1.0 https://github.com/suse-edge/fleet-examples.git</pre></div></li><li class="listitem"><p>Navigate to the <code class="literal">eib-chart-migration-prep</code> fleet, located in the <span class="strong"><strong>fleet-examples</strong></span> repo:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd fleet-examples/fleets/day2/system-upgrade-controller-plans/eib-charts-migration-prep</pre></div></li><li class="listitem"><p>Create a <code class="literal">targets.yaml</code> file that will point to all downstream clusters on which you wish to deploy the fleet:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; targets.yaml &lt;&lt;EOF
targets:
- clusterSelector: CHANGEME
EOF</pre></div><p>For information on how to map to downstream clusters, see <a class="link" href="https://fleet.rancher.io/gitrepo-targets" target="_blank">Mapping to Downstream Clusters</a>.</p></li><li class="listitem"><p>Proceed to build the Bundle:</p><div id="id-1.7.3.5.3.3.13.4.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Make sure you did <span class="strong"><strong>not</strong></span> download the <span class="strong"><strong>fleet-cli</strong></span> in the <code class="literal">fleet-examples/fleets/day2/system-upgrade-controller-plans/eib-charts-migration-prep</code> directory, otherwise it will be packaged with the Bundle, which is not advised.</p></div><div class="verbatim-wrap highlight bash"><pre class="screen">fleet-cli apply --compress --targets-file=targets.yaml -n fleet-default -o - eib-chart-migration-prep . &gt; eib-chart-migration-prep-bundle.yaml</pre></div><p>For more information about this process, see <a class="link" href="https://fleet.rancher.io/bundle-add#convert-a-helm-chart-into-a-bundle" target="_blank">Convert a Helm Chart into a Bundle</a>.</p><p>For more information about the <code class="literal">fleet-cli apply</code> command, see <a class="link" href="https://fleet.rancher.io/cli/fleet-cli/fleet_apply" target="_blank">fleet apply</a>.</p></li><li class="listitem"><p>Transfer the <span class="strong"><strong>eib-chart-migration-prep-bundle.yaml</strong></span> bundle to your <span class="strong"><strong>management</strong></span> cluster machine:</p><div class="verbatim-wrap highlight bash"><pre class="screen">scp eib-chart-migration-prep-bundle.yaml &lt;machine-address&gt;:&lt;filesystem-path&gt;</pre></div></li><li class="listitem"><p>On your <span class="strong"><strong>management</strong></span> cluster, deploy the <span class="strong"><strong>eib-chart-migration-prep-bundle.yaml</strong></span> Bundle:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f eib-chart-migration-prep-bundle.yaml</pre></div></li><li class="listitem"><p>On your <span class="strong"><strong>management</strong></span> cluster, validate that the <span class="strong"><strong>Bundle</strong></span> is deployed:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get bundle eib-chart-migration-prep -n fleet-default
NAME                       BUNDLEDEPLOYMENTS-READY   STATUS
eib-chart-migration-prep   1/1</pre></div></li><li class="listitem"><p>By creating the above <code class="literal">Bundle</code> on your <code class="literal">management</code> cluster, Fleet will deploy an <code class="literal">SUC Plan</code> (called <code class="literal">eib-chart-migration-prep</code>) on each downstream cluster that matches the <code class="literal">targets</code> specified in the <code class="literal">targets.yaml</code> file. To monitor the lifecycle of this plan, refer to "Monitoring System Upgrade Controller Plans" (<a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="19.3. Monitoring System Upgrade Controller Plans">Section 19.3, “Monitoring System Upgrade Controller Plans”</a>).</p></li></ol></div></section></section></section><section class="sect2" id="id-migration-steps-2" data-id-title="Migration steps"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">26.2.2 </span><span class="title-name">Migration steps</span></span> <a title="Permalink" class="permalink" href="day2-migration.html#id-migration-steps-2">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>After executing the prerequisite (<a class="xref" href="day2-migration.html#day2-migration-downstream-prerequisites" title="26.2.1. Prerequisites">Section 26.2.1, “Prerequisites”</a>) steps, you can proceed to follow the downstream cluster (<a class="xref" href="day2-downstream-clusters.html" title="Chapter 28. Downstream clusters">Chapter 28, <em>Downstream clusters</em></a>) upgrade documentation for the <code class="literal">Edge 3.1.0</code> release.</p></section></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="day-2-operations.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Part V </span>Day 2 Operations</span></a> </div><div><a class="pagination-link next" href="day2-mgmt-cluster.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Chapter 27 </span>Management Cluster</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="section"><a href="day2-migration.html#day2-migration-mgmt"><span class="title-number">26.1 </span><span class="title-name">Management cluster</span></a></span></li><li><span class="section"><a href="day2-migration.html#day2-migration-downstream"><span class="title-number">26.2 </span><span class="title-name">Downstream clusters</span></a></span></li></ul></div><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter/X"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2024</span></div></div></footer></body></html>